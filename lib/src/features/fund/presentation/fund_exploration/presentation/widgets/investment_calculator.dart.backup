import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'dart:math' as math;

/// æŠ•èµ„è®¡ç®—å™¨ç»„ä»?
///
/// æä¾›åŸºé‡‘æŠ•èµ„æ”¶ç›Šè®¡ç®—åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
/// - æŠ•èµ„é‡‘é¢è¾“å…¥å’Œå‚æ•°è®¾ç½?
/// - æ”¶ç›Šé¢„æµ‹å’Œé£é™©è®¡ç®?
/// - æŠ•èµ„å»ºè®®å’Œç»“æœå±•ç¤?
/// - å“åº”å¼å¸ƒå±€é€‚é…
class InvestmentCalculator extends StatefulWidget {
  const InvestmentCalculator({super.key});

  @override
  State<InvestmentCalculator> createState() => _InvestmentCalculatorState();
}

class _InvestmentCalculatorState extends State<InvestmentCalculator>
    with TickerProviderStateMixin {
  // æ§åˆ¶å™?
  final TextEditingController _amountController =
      TextEditingController(text: '1000');
  final TextEditingController _periodController =
      TextEditingController(text: '12');
  final TextEditingController _expectedReturnController =
      TextEditingController(text: '8');

  // è®¡ç®—å‚æ•°
  String _frequency = 'monthly'; // monthly, weekly, daily
  String _riskLevel = 'medium'; // low, medium, high

  // è®¡ç®—ç»“æœ
  Map<String, dynamic>? _calculationResult;
  bool _isCalculating = false;

  // åŠ¨ç”»æ§åˆ¶å™?
  late AnimationController _animationController;
  late Animation<double> _fadeAnimation;

  // å“åº”å¼å¸ƒå±€
  bool _isCompactLayout = false;

  @override
  void initState() {
    super.initState();
    _initializeAnimations();
    _performCalculation();

    // ç›‘å¬å¸ƒå±€å˜åŒ–
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _checkLayout();
    });
  }

  /// åˆå§‹åŒ–åŠ¨ç”?
  void _initializeAnimations() {
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _fadeAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(
      parent: _animationController,
      curve: Curves.easeInOut,
    ));
    _animationController.forward();
  }

  /// æ£€æŸ¥å¸ƒå±€çŠ¶æ€?
  void _checkLayout() {
    if (mounted) {
      final renderBox = context.findRenderObject() as RenderBox?;
      if (renderBox != null) {
        final width = renderBox.size.width;
        setState(() {
          _isCompactLayout = width < 320;
        });
      }
    }
  }

  @override
  void dispose() {
    _amountController.dispose();
    _periodController.dispose();
    _expectedReturnController.dispose();
    _animationController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return LayoutBuilder(
      builder: (context, constraints) {
        // å®æ—¶æ£€æŸ¥å¸ƒå±€
        WidgetsBinding.instance.addPostFrameCallback((_) {
          _checkLayout();
        });

        return Card(
          elevation: 4,
          shadowColor: Colors.black12,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // æ ‡é¢˜åŒºåŸŸ
                _buildHeaderSection(),
                const SizedBox(height: 16),

                // å‚æ•°è®¾ç½®åŒºåŸŸ
                _buildParameterSection(),
                const SizedBox(height: 16),

                // è®¡ç®—æŒ‰é’®
                _buildCalculateButton(),
                const SizedBox(height: 16),

                // è®¡ç®—ç»“æœåŒºåŸŸ
                if (_calculationResult != null) ...[
                  FadeTransition(
                    opacity: _fadeAnimation,
                    child: _buildResultSection(),
                  ),
                ],
              ],
            ),
          ),
        );
      },
    );
  }

  /// æ„å»ºå¤´éƒ¨åŒºåŸŸ
  Widget _buildHeaderSection() {
    return _isCompactLayout
        ? Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: const Color(0xFF1E40AF).withOpacity(0.1),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Icon(
                      Icons.calculate,
                      color: Color(0xFF1E40AF),
                      size: 20,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      'æŠ•èµ„è®¡ç®—å™?,
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Colors.grey[800],
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),
              Row(
                mainAxisAlignment: MainAxisAlignment.end,
                children: [
                  TextButton.icon(
                    onPressed: _showCalculationInfo,
                    icon: const Icon(Icons.info_outline, size: 16),
                    label: const Text('è¯´æ˜', style: TextStyle(fontSize: 12)),
                    style: TextButton.styleFrom(
                      padding: const EdgeInsets.symmetric(horizontal: 8),
                      minimumSize: Size.zero,
                      tapTargetSize: MaterialTapTargetSize.shrinkWrap,
                    ),
                  ),
                ],
              ),
            ],
          )
        : Row(
            children: [
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: const Color(0xFF1E40AF).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Icon(
                  Icons.calculate,
                  color: Color(0xFF1E40AF),
                  size: 24,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'æŠ•èµ„è®¡ç®—å™?,
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Colors.grey[800],
                      ),
                    ),
                    Text(
                      'è®¡ç®—æŠ•èµ„æ”¶ç›Šå’Œé£é™©è¯„ä¼?,
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.grey[600],
                      ),
                    ),
                  ],
                ),
              ),
              IconButton(
                onPressed: _showCalculationInfo,
                icon: const Icon(Icons.info_outline),
                tooltip: 'è®¡ç®—è¯´æ˜',
              ),
            ],
          );
  }

  /// æ„å»ºå‚æ•°è®¾ç½®åŒºåŸŸ
  Widget _buildParameterSection() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.grey[50],
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.grey[200]!),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'æŠ•èµ„å‚æ•°',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Colors.grey[800],
            ),
          ),
          const SizedBox(height: 12),

          // æŠ•èµ„é‡‘é¢
          _buildInputField(
            controller: _amountController,
            label: 'æŠ•èµ„é‡‘é¢',
            hintText: 'è¯·è¾“å…¥æŠ•èµ„é‡‘é¢?,
            prefixText: 'Â¥',
            keyboardType: TextInputType.number,
            inputFormatters: [FilteringTextInputFormatter.digitsOnly],
            onChanged: (_) => _onParameterChanged(),
          ),
          const SizedBox(height: 12),

          // æŠ•èµ„æ—¶é•¿å’Œé¢‘ç?
          _isCompactLayout
              ? Column(
                  children: [
                    _buildInputField(
                      controller: _periodController,
                      label: 'æŠ•èµ„æ—¶é•¿',
                      hintText: 'æŠ•èµ„æ—¶é•¿',
                      suffixText: 'ä¸ªæœˆ',
                      keyboardType: TextInputType.number,
                      inputFormatters: [FilteringTextInputFormatter.digitsOnly],
                      onChanged: (_) => _onParameterChanged(),
                    ),
                    const SizedBox(height: 12),
                    _buildFrequencyDropdown(),
                  ],
                )
              : Row(
                  children: [
                    Expanded(
                      flex: 3,
                      child: _buildInputField(
                        controller: _periodController,
                        label: 'æŠ•èµ„æ—¶é•¿',
                        hintText: 'æŠ•èµ„æ—¶é•¿',
                        suffixText: 'ä¸ªæœˆ',
                        keyboardType: TextInputType.number,
                        inputFormatters: [FilteringTextInputFormatter.digitsOnly],
                        onChanged: (_) => _onParameterChanged(),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      flex: 2,
                      child: _buildFrequencyDropdown(),
                    ),
                  ],
                ),
          const SizedBox(height: 12),

          // é¢„æœŸæ”¶ç›Šç?
          _buildInputField(
            controller: _expectedReturnController,
            label: 'é¢„æœŸå¹´åŒ–æ”¶ç›Šç?,
            hintText: 'è¯·è¾“å…¥é¢„æœŸå¹´åŒ–æ”¶ç›Šç‡',
            suffixText: '%',
            keyboardType: TextInputType.number,
            inputFormatters: [
              FilteringTextInputFormatter.allow(RegExp(r'[\d.]')),
            ],
            onChanged: (_) => _onParameterChanged(),
          ),
          const SizedBox(height: 12),

          // é£é™©ç­‰çº§é€‰æ‹©
          _buildRiskLevelSelector(),
        ],
      ),
    );
  }

  /// æ„å»ºè¾“å…¥å­—æ®µ
  Widget _buildInputField({
    required TextEditingController controller,
    required String label,
    required String hintText,
    String? prefixText,
    String? suffixText,
    required TextInputType keyboardType,
    required List<TextInputFormatter> inputFormatters,
    Function(String)? onChanged,
  }) {
    return TextField(
      controller: controller,
      decoration: InputDecoration(
        labelText: label,
        hintText: hintText,
        prefixText: prefixText,
        suffixText: suffixText,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
        isDense: true,
        filled: true,
        fillColor: Colors.white,
      ),
      keyboardType: keyboardType,
      inputFormatters: inputFormatters,
      onChanged: onChanged,
    );
  }

  /// æ„å»ºé¢‘ç‡ä¸‹æ‹‰é€‰æ‹©æ¡?
  Widget _buildFrequencyDropdown() {
    return DropdownButtonFormField<String>(
      value: _frequency,
      decoration: InputDecoration(
        labelText: 'æŠ•èµ„é¢‘ç‡',
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(8),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
        isDense: true,
        filled: true,
        fillColor: Colors.white,
      ),
      items: const [
        DropdownMenuItem(value: 'monthly', child: Text('æ¯æœˆ')),
        DropdownMenuItem(value: 'weekly', child: Text('æ¯å‘¨')),
        DropdownMenuItem(value: 'daily', child: Text('æ¯æ—¥')),
      ],
      onChanged: (value) {
        if (value != null) {
          setState(() {
            _frequency = value;
          });
          _onParameterChanged();
        }
      },
    );
  }

  /// æ„å»ºé£é™©ç­‰çº§é€‰æ‹©å™?
  Widget _buildRiskLevelSelector() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'é£é™©ç­‰çº§',
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w500,
            color: Colors.grey[700],
          ),
        ),
        const SizedBox(height: 8),
        Row(
          children: [
            Expanded(
              child: _buildRiskOption('low', 'ä½é£é™?, Colors.green),
            ),
            const SizedBox(width: 8),
            Expanded(
              child: _buildRiskOption('medium', 'ä¸­é£é™?, Colors.orange),
            ),
            const SizedBox(width: 8),
            Expanded(
              child: _buildRiskOption('high', 'é«˜é£é™?, Colors.red),
            ),
          ],
        ),
      ],
    );
  }

  /// æ„å»ºé£é™©é€‰é¡¹
  Widget _buildRiskOption(String value, String label, Color color) {
    final isSelected = _riskLevel == value;
    return GestureDetector(
      onTap: () {
        setState(() {
          _riskLevel = value;
        });
        _onParameterChanged();
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 8),
        decoration: BoxDecoration(
          color: isSelected ? color.withOpacity(0.1) : Colors.transparent,
          borderRadius: BorderRadius.circular(8),
          border: Border.all(
            color: isSelected ? color : Colors.grey[300]!,
            width: isSelected ? 2 : 1,
          ),
        ),
        child: Text(
          label,
          textAlign: TextAlign.center,
          style: TextStyle(
            fontSize: 12,
            fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
            color: isSelected ? color : Colors.grey[600],
          ),
        ),
      ),
    );
  }

  /// æ„å»ºè®¡ç®—æŒ‰é’®
  Widget _buildCalculateButton() {
    return SizedBox(
      width: double.infinity,
      child: ElevatedButton.icon(
        onPressed: _isCalculating ? null : _performCalculation,
        icon: _isCalculating
            ? SizedBox(
                width: 16,
                height: 16,
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  valueColor: AlwaysStoppedAnimation<Color>(
                    Theme.of(context).colorScheme.onPrimary,
                  ),
                ),
              )
            : const Icon(Icons.calculate),
        label: Text(_isCalculating ? 'è®¡ç®—ä¸?..' : 'å¼€å§‹è®¡ç®?),
        style: ElevatedButton.styleFrom(
          backgroundColor: const Color(0xFF1E40AF),
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(vertical: 14),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
          elevation: 2,
        ),
      ),
    );
  }

  /// æ„å»ºç»“æœåŒºåŸŸ
  Widget _buildResultSection() {
    final result = _calculationResult!;
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            const Color(0xFF1E40AF).withOpacity(0.05),
            const Color(0xFF3B82F6).withOpacity(0.05),
          ],
        ),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: const Color(0xFF1E40AF).withOpacity(0.2)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // ç»“æœæ ‡é¢˜
          _buildResultHeader(),
          const SizedBox(height: 16),

          // ä¸»è¦ç»“æœ
          _buildMainResults(result),
          const SizedBox(height: 16),

          // è¯¦ç»†ä¿¡æ¯
          _buildDetailedResults(result),
          const SizedBox(height: 16),

          // æŠ•èµ„å»ºè®®
          _buildInvestmentAdvice(result),
        ],
      ),
    );
  }

  /// æ„å»ºç»“æœæ ‡é¢˜
  Widget _buildResultHeader() {
    return Row(
      children: [
        Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: const Color(0xFF1E40AF).withOpacity(0.1),
            borderRadius: BorderRadius.circular(8),
          ),
          child: const Icon(
            Icons.show_chart,
            color: Color(0xFF1E40AF),
            size: 20,
          ),
        ),
        const SizedBox(width: 12),
        const Expanded(
          child: Text(
            'è®¡ç®—ç»“æœ',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
              color: Color(0xFF1E40AF),
            ),
          ),
        ),
        IconButton(
          onPressed: _shareResult,
          icon: const Icon(Icons.share, size: 20),
          tooltip: 'åˆ†äº«ç»“æœ',
          constraints: const BoxConstraints(),
          padding: EdgeInsets.zero,
        ),
      ],
    );
  }

  /// æ„å»ºä¸»è¦ç»“æœ
  Widget _buildMainResults(Map<String, dynamic> result) {
    return _isCompactLayout
        ? Column(
            children: [
              _buildResultItem(
                'æŠ•å…¥æœ¬é‡‘',
                'Â¥${result['totalPrincipal']?.toStringAsFixed(0) ?? "0"}',
                Colors.blue,
              ),
              const SizedBox(height: 12),
              _buildResultItem(
                'é¢„æœŸæ”¶ç›Š',
                'Â¥${result['totalReturn']?.toStringAsFixed(0) ?? "0"}',
                _getReturnColor(result['totalReturn'] ?? 0),
              ),
              const SizedBox(height: 12),
              _buildResultItem(
                'æ€»èµ„äº?,
                'Â¥${result['totalValue']?.toStringAsFixed(0) ?? "0"}',
                Colors.green,
              ),
            ],
          )
        : Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              _buildResultItem(
                'æŠ•å…¥æœ¬é‡‘',
                'Â¥${result['totalPrincipal']?.toStringAsFixed(0) ?? "0"}',
                Colors.blue,
              ),
              _buildResultItem(
                'é¢„æœŸæ”¶ç›Š',
                'Â¥${result['totalReturn']?.toStringAsFixed(0) ?? "0"}',
                _getReturnColor(result['totalReturn'] ?? 0),
              ),
              _buildResultItem(
                'æ€»èµ„äº?,
                'Â¥${result['totalValue']?.toStringAsFixed(0) ?? "0"}',
                Colors.green,
              ),
            ],
          );
  }

  /// æ„å»ºç»“æœé¡?
  Widget _buildResultItem(String label, String value, Color color) {
    return Column(
      children: [
        Text(
          value,
          style: TextStyle(
            fontSize: _isCompactLayout ? 16 : 18,
            fontWeight: FontWeight.bold,
            color: color,
          ),
        ),
        const SizedBox(height: 4),
        Text(
          label,
          style: TextStyle(
            fontSize: 12,
            color: Colors.grey[600],
          ),
        ),
      ],
    );
  }

  /// æ„å»ºè¯¦ç»†ç»“æœ
  Widget _buildDetailedResults(Map<String, dynamic> result) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white.withOpacity(0.7),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Column(
        children: [
          _buildDetailRow('æŠ•èµ„æ¬¡æ•°', '${result['totalInvestments'] ?? 0} æ¬?),
          _buildDetailRow('å¹³å‡æˆæœ¬', 'Â¥${result['averageCost']?.toStringAsFixed(4) ?? "0.0000"}'),
          _buildDetailRow('æ”¶ç›Šç?, '${result['totalReturnRate']?.toStringAsFixed(2) ?? "0.00"}%'),
          _buildDetailRow('å¹´åŒ–æ”¶ç›Šç?, '${result['annualizedReturn']?.toStringAsFixed(2) ?? "0.00"}%'),
          if (result['maxDrawdown'] != null)
            _buildDetailRow('æœ€å¤§å›æ’?, '${result['maxDrawdown'].toStringAsFixed(2)}%'),
          if (result['riskScore'] != null)
            _buildDetailRow('é£é™©è¯„åˆ†', '${result['riskScore'].toStringAsFixed(1)}/10'),
        ],
      ),
    );
  }

  /// æ„å»ºè¯¦æƒ…è¡?
  Widget _buildDetailRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            label,
            style: TextStyle(
              fontSize: 13,
              color: Colors.grey[600],
            ),
          ),
          Text(
            value,
            style: const TextStyle(
              fontSize: 13,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  /// æ„å»ºæŠ•èµ„å»ºè®®
  Widget _buildInvestmentAdvice(Map<String, dynamic> result) {
    final advice = _generateAdvice(result);
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: _getAdviceColor(advice['level']).withOpacity(0.1),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: _getAdviceColor(advice['level']).withOpacity(0.3),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.lightbulb_outline,
                color: _getAdviceColor(advice['level']),
                size: 16,
              ),
              const SizedBox(width: 8),
              Text(
                'æŠ•èµ„å»ºè®®',
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                  color: _getAdviceColor(advice['level']),
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          ...advice['suggestions'].map<Widget>((suggestion) => Padding(
            padding: EdgeInsets only(bottom: 4),
            child: Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'â€?',
                  style: TextStyle(
                    fontSize: 12,
                    color: _getAdviceColor(advice['level']),
                  ),
                ),
                Expanded(
                  child: Text(
                    suggestion,
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[700],
                    ),
                  ),
                ),
              ],
            ),
          )).toList(),
        ],
      ),
    );
  }

  /// å‚æ•°å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°è®¡ç®?
  void _onParameterChanged() {
    // å»¶è¿Ÿè®¡ç®—ï¼Œé¿å…é¢‘ç¹è®¡ç®?
    Future.delayed(const Duration(milliseconds: 500), () {
      if (mounted) {
        _performCalculation();
      }
    });
  }

  /// æ‰§è¡Œè®¡ç®—
  Future<void> _performCalculation() async {
    if (_isCalculating) return;

    setState(() {
      _isCalculating = true;
    });

    try {
      // æ¨¡æ‹Ÿè®¡ç®—è¿‡ç¨‹
      await Future.delayed(const Duration(milliseconds: 800));

      final amount = double.tryParse(_amountController.text) ?? 1000;
      final period = int.tryParse(_periodController.text) ?? 12;
      final expectedReturn = double.tryParse(_expectedReturnController.text) ?? 8;

      // è®¡ç®—é€»è¾‘
      final calculations = _calculateInvestment(amount, period, expectedReturn);

      if (mounted) {
        setState(() {
          _calculationResult = calculations;
          _isCalculating = false;
        });

        // é‡æ–°æ’­æ”¾åŠ¨ç”»
        _animationController.reset();
        _animationController.forward();
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          _isCalculating = false;
        });

        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text('è®¡ç®—å¤±è´¥: $e'),
            backgroundColor: Colors.red,
          ),
        );
      }
    }
  }

  /// è®¡ç®—æŠ•èµ„æ”¶ç›Š
  Map<String, dynamic> _calculateInvestment(
      double amount, int period, double expectedReturn) {
    // æ ¹æ®é¢‘ç‡è°ƒæ•´è®¡ç®—
    int frequencyFactor = _getFrequencyFactor();
    int totalInvestments = period * frequencyFactor;
    double periodReturn = expectedReturn / 100 / frequencyFactor;

    final totalPrincipal = amount * totalInvestments;

    // å¤åˆ©è®¡ç®—
    double totalValue = 0;
    for (int i = 0; i < totalInvestments; i++) {
      totalValue += amount * math.pow(1 + periodReturn, totalInvestments - i);
    }

    final totalReturn = totalValue - totalPrincipal;
    final totalReturnRate = (totalReturn / totalPrincipal) * 100;
    final annualizedReturn = math.pow(totalValue / totalPrincipal, frequencyFactor / 12.0) - 1;

    // é£é™©è®¡ç®—
    final riskScore = _calculateRiskScore(expectedReturn, _riskLevel);
    final maxDrawdown = _calculateMaxDrawdown(_riskLevel, expectedReturn);

    return {
      'totalPrincipal': totalPrincipal,
      'totalValue': totalValue,
      'totalReturn': totalReturn,
      'totalReturnRate': totalReturnRate,
      'annualizedReturn': annualizedReturn * 100,
      'totalInvestments': totalInvestments,
      'averageCost': totalPrincipal / totalValue,
      'maxDrawdown': maxDrawdown,
      'riskScore': riskScore,
      'frequency': _frequency,
      'riskLevel': _riskLevel,
    };
  }

  /// è·å–é¢‘ç‡ç³»æ•°
  int _getFrequencyFactor() {
    switch (_frequency) {
      case 'daily':
        return 30; // å‡è®¾æ¯æœˆ30å¤?
      case 'weekly':
        return 4; // å‡è®¾æ¯æœˆ4å‘?
      case 'monthly':
      default:
        return 1;
    }
  }

  /// è®¡ç®—é£é™©è¯„åˆ†
  double _calculateRiskScore(double expectedReturn, String riskLevel) {
    double baseScore = expectedReturn / 10; // åŸºç¡€è¯„åˆ†

    switch (riskLevel) {
      case 'low':
        return math.max(1.0, math.min(4.0, baseScore));
      case 'medium':
        return math.max(3.0, math.min(7.0, baseScore + 2));
      case 'high':
        return math.max(6.0, math.min(10.0, baseScore + 4));
      default:
        return 5.0;
    }
  }

  /// è®¡ç®—æœ€å¤§å›æ’?
  double _calculateMaxDrawdown(String riskLevel, double expectedReturn) {
    switch (riskLevel) {
      case 'low':
        return -2.0 - (expectedReturn * 0.1);
      case 'medium':
        return -5.0 - (expectedReturn * 0.2);
      case 'high':
        return -10.0 - (expectedReturn * 0.3);
      default:
        return -5.0;
    }
  }

  /// ç”ŸæˆæŠ•èµ„å»ºè®®
  Map<String, dynamic> _generateAdvice(Map<String, dynamic> result) {
    final returnRate = result['totalReturnRate'] ?? 0.0;
    final riskScore = result['riskScore'] ?? 5.0;
    final riskLevel = result['riskLevel'] ?? 'medium';

    List<String> suggestions = [];
    String level = 'medium';

    if (returnRate > 20) {
      level = 'high';
      suggestions.add('é¢„æœŸæ”¶ç›Šç‡è¾ƒé«˜ï¼Œå»ºè®®æ³¨æ„é£é™©æ§åˆ¶');
      suggestions.add('å¯è€ƒè™‘åˆ†æ‰¹æŠ•å…¥ï¼Œé™ä½å¸‚åœºæ³¢åŠ¨å½±å“?);
    } else if (returnRate > 10) {
      level = 'medium';
      suggestions.add('æ”¶ç›Šç‡é¢„æœŸåˆç†ï¼Œé€‚åˆç¨³å¥æŠ•èµ„');
      suggestions.add('å»ºè®®å®šæœŸè¯„ä¼°æŠ•èµ„ç»„åˆè¡¨ç°');
    } else {
      level = 'low';
      suggestions.add('æ”¶ç›Šç‡é¢„æœŸè¾ƒä½ï¼Œå¯è€ƒè™‘ä¼˜åŒ–æŠ•èµ„ç­–ç•¥');
      suggestions.add('å»ºè®®é€‚å½“å¢åŠ æŠ•èµ„é‡‘é¢ä»¥æé«˜æ”¶ç›?);
    }

    if (riskLevel == 'high') {
      suggestions.add('é«˜é£é™©æŠ•èµ„ï¼Œå»ºè®®é…ç½®éƒ¨åˆ†ç¨³å¥èµ„äº§');
    } else if (riskLevel == 'low') {
      suggestions.add('ä½é£é™©ç­–ç•¥ï¼Œé€‚åˆä¿å®ˆå‹æŠ•èµ„è€?);
    }

    if (riskScore > 7) {
      suggestions.add('é£é™©è¯„åˆ†è¾ƒé«˜ï¼Œå»ºè®®åšå¥½èµ„é‡‘ç®¡ç?);
    }

    return {
      'level': level,
      'suggestions': suggestions,
    };
  }

  /// è·å–æ”¶ç›Šé¢œè‰²
  Color _getReturnColor(double returnValue) {
    if (returnValue > 0) {
      return Colors.green;
    } else if (returnValue < 0) {
      return Colors.red;
    } else {
      return Colors.grey;
    }
  }

  /// è·å–å»ºè®®é¢œè‰²
  Color _getAdviceColor(String level) {
    switch (level) {
      case 'high':
        return Colors.orange;
      case 'medium':
        return Colors.blue;
      case 'low':
        return Colors.green;
      default:
        return Colors.grey;
    }
  }

  /// æ˜¾ç¤ºè®¡ç®—è¯´æ˜
  void _showCalculationInfo() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('è®¡ç®—è¯´æ˜'),
        content: const SingleChildScrollView(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'æŠ•èµ„æ”¶ç›Šè®¡ç®—å™¨ä½¿ç”¨è¯´æ˜ï¼š',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              SizedBox(height: 12),
              Text(
                '1. æŠ•èµ„é‡‘é¢ï¼šæ¯æ¬¡æŠ•èµ„çš„é‡‘é¢\n'
                '2. æŠ•èµ„æ—¶é•¿ï¼šæŠ•èµ„çš„æ—¶é—´é•¿åº¦ï¼ˆæœˆï¼‰\n'
                '3. æŠ•èµ„é¢‘ç‡ï¼šæŠ•èµ„çš„é¢‘ç‡ï¼ˆæœˆ/å‘?æ—¥ï¼‰\n'
                '4. é¢„æœŸå¹´åŒ–æ”¶ç›Šç‡ï¼šé¢„æœŸçš„å¹´åŒ–æ”¶ç›Šç‡\n'
                '5. é£é™©ç­‰çº§ï¼šæŠ•èµ„çš„é£é™©åå¥½\n\n'
                'è®¡ç®—æ–¹å¼ï¼š\n'
                'â€?é‡‡ç”¨å¤åˆ©è®¡ç®—æ–¹å¼ï¼Œè€ƒè™‘èµ„é‡‘æ—¶é—´ä»·å€¼\n'
                'â€?æ ¹æ®ä¸åŒé¢‘ç‡è°ƒæ•´è®¡ç®—å‘¨æœŸ\n'
                'â€?é£é™©è¯„åˆ†åŸºäºæ”¶ç›Šç‡å’Œé£é™©ç­‰çº§\n'
                'â€?æœ€å¤§å›æ’¤æ ¹æ®é£é™©ç­‰çº§æ¨¡æ‹Ÿè®¡ç®—\n\n'
                'é‡è¦æç¤ºï¼š\n'
                'â€?è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒï¼Œå®é™…æ”¶ç›Šå¯èƒ½å­˜åœ¨å·®å¼‚\n'
                'â€?æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…\n'
                'â€?å»ºè®®ç»“åˆä¸ªäººé£é™©æ‰¿å—èƒ½åŠ›è¿›è¡ŒæŠ•èµ„å†³ç­–',
                style: TextStyle(fontSize: 14, height: 1.5),
              ),
            ],
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ç¡®å®š'),
          ),
        ],
      ),
    );
  }

  /// åˆ†äº«ç»“æœ
  void _shareResult() {
    if (_calculationResult == null) return;

    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(
        content: Text('è®¡ç®—ç»“æœå·²ç”Ÿæˆï¼Œå¯å¤åˆ¶åˆ†äº?),
        duration: Duration(seconds: 2),
      ),
    );

    // è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„åˆ†äº«åŠŸèƒ?
    // final shareText = _generateShareText(_calculationResult!);
    // Clipboard.setData(ClipboardData(text: shareText));
  }
}
