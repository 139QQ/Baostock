import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:async';
import 'package:jisu_fund_analyzer/src/features/portfolio/presentation/cubit/fund_favorite_cubit.dart';
import 'package:jisu_fund_analyzer/src/features/portfolio/domain/fund_favorite/src/entities/fund_favorite.dart';
import 'package:jisu_fund_analyzer/src/features/portfolio/domain/entities/portfolio_holding.dart';
import 'package:jisu_fund_analyzer/src/features/portfolio/presentation/pages/portfolio_analysis_page.dart';
import 'package:jisu_fund_analyzer/src/services/fund_data_cache_service.dart';
import 'package:jisu_fund_analyzer/src/services/optimized_fund_search_service.dart';
import 'package:jisu_fund_analyzer/src/services/intelligent_cache_manager.dart';
import 'package:jisu_fund_analyzer/src/models/fund_info.dart' as models;

/// è‡ªé€‰åŸºé‡‘é¡µé¢
///
/// ç”¨äºå±•ç¤ºå’Œç®¡ç†ç”¨æˆ·è‡ªé€‰åŸºé‡‘åˆ—è¡¨çš„é¡µé¢ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
/// - å±•ç¤ºè‡ªé€‰åŸºé‡‘åˆ—è¡¨
/// - æ·»åŠ /åˆ é™¤è‡ªé€‰åŸºé‡‘
/// - å®æ—¶æ›´æ–°åŸºé‡‘æ•°æ®
/// - è‡ªé€‰åŸºé‡‘åˆ†ç»„ç®¡ç†
/// - æ’åºå’Œç­›é€‰åŠŸèƒ½
class WatchlistPage extends StatefulWidget {
  /// æ„é€ å‡½æ•°
  const WatchlistPage({super.key});

  @override
  State<WatchlistPage> createState() => _WatchlistPageState();
}

class _WatchlistPageState extends State<WatchlistPage> {
  final TextEditingController _searchController = TextEditingController();
  FundFavoriteSortType _currentSortType = FundFavoriteSortType.addTime;
  FundFavoriteSortDirection _currentSortDirection = FundFavoriteSortDirection.descending;

  // æ™ºèƒ½æœç´¢ç›¸å…³çŠ¶æ€ - ä½¿ç”¨é«˜æ€§èƒ½æœåŠ¡
  bool _isSearching = false;
  List<models.FundInfo> _searchSuggestions = [];
  List<String> _searchHistory = [];
  List<String> _popularSearches = [];
  List<models.FundInfo> _searchResults = [];
  Timer? _searchDebounce;
  final FocusNode _searchFocusNode = FocusNode();
  final OptimizedFundSearchService _fundService = OptimizedFundSearchService();
  final IntelligentCacheManager _cacheManager = IntelligentCacheManager();

  @override
  void initState() {
    super.initState();
    _initializeSmartSearch();
    // å»¶è¿Ÿåˆå§‹åŒ–è‡ªé€‰åŸºé‡‘ï¼Œé¿å…ä¸Hiveåˆå§‹åŒ–å†²çª
    WidgetsBinding.instance.addPostFrameCallback((_) async {
      if (mounted) {
        try {
          final cubit = context.read<FundFavoriteCubit>();
          await cubit.initialize();
        } catch (e) {
          print('è‡ªé€‰åŸºé‡‘åˆå§‹åŒ–å¤±è´¥: $e');
        }
      }
    });
  }

  @override
  void dispose() {
    _searchController.dispose();
    _searchFocusNode.dispose();
    _searchDebounce?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: _buildAppBar(),
      body: Column(
        children: [
          _buildSearchAndFilterSection(),
          _buildContentSection(),
        ],
      ),
      floatingActionButton: _buildFloatingActionButton(),
    );
  }

  /// æ„å»ºåº”ç”¨æ 
  PreferredSizeWidget _buildAppBar() {
    return AppBar(
      title: const Text('è‡ªé€‰åŸºé‡‘'),
      backgroundColor: Theme.of(context).colorScheme.surface,
      elevation: 0,
      actions: [
        PopupMenuButton<String>(
          icon: const Icon(Icons.more_vert),
          onSelected: _handleMenuAction,
          itemBuilder: (context) => [
            const PopupMenuItem(
              value: 'sort',
              child: Row(
                children: [
                  Icon(Icons.sort),
                  SizedBox(width: 8),
                  Text('æ’åºæ–¹å¼'),
                ],
              ),
            ),
            const PopupMenuItem(
              value: 'clear_all',
              child: Row(
                children: [
                  Icon(Icons.clear_all, color: Colors.red),
                  SizedBox(width: 8),
                  Text('æ¸…ç©ºå…¨éƒ¨', style: TextStyle(color: Colors.red)),
                ],
              ),
            ),
            const PopupMenuItem(
              value: 'refresh',
              child: Row(
                children: [
                  Icon(Icons.refresh),
                  SizedBox(width: 8),
                  Text('åˆ·æ–°æ•°æ®'),
                ],
              ),
            ),
          ],
        ),
      ],
    );
  }

  /// æ„å»ºæœç´¢å’Œç­›é€‰åŒºåŸŸ
  Widget _buildSearchAndFilterSection() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.surface,
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          // æ™ºèƒ½æœç´¢æ¡†
          _buildSmartSearchField(),
          const SizedBox(height: 12),

          // æœç´¢å»ºè®®ï¼ˆä»…åœ¨æœç´¢æ—¶æ˜¾ç¤ºï¼‰
          _buildSearchSuggestions(),
          const SizedBox(height: 8),

          // å¿«é€Ÿç­›é€‰æŒ‰é’®
          _buildQuickFilterChips(),
        ],
      ),
    );
  }

  /// æ„å»ºç­›é€‰èŠ¯ç‰‡
  Widget _buildFilterChip(String label, VoidCallback onTap, {bool isSelected = false}) {
    return FilterChip(
      label: Text(label),
      selected: isSelected,
      onSelected: (_) => onTap(),
      backgroundColor: Colors.grey[200],
      selectedColor: Theme.of(context).primaryColor.withOpacity(0.2),
      checkmarkColor: Theme.of(context).primaryColor,
    );
  }

  /// æ„å»ºå†…å®¹åŒºåŸŸ
  Widget _buildContentSection() {
    return Expanded(
      child: BlocBuilder<FundFavoriteCubit, FundFavoriteState>(
        builder: (context, state) {
          try {
            if (state is FundFavoriteInitial) {
              return _buildInitialState();
            } else if (state is FundFavoriteLoading) {
              return _buildLoadingState();
            } else if (state is FundFavoriteLoaded) {
              return _buildLoadedState(context, state);
            } else if (state is FundFavoriteError) {
              return _buildErrorState(state.error);
            } else if (state is FundFavoriteOperationSuccess) {
              // å»¶è¿Ÿæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼Œé¿å…contexté—®é¢˜
              Future.microtask(() {
                if (context.mounted) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text(state.message),
                      backgroundColor: Colors.green,
                    ),
                  );
                }
              });
              return _buildLoadedState(context, state.previousState);
            } else {
              return _buildInitialState();
            }
          } catch (e) {
            print('æ„å»ºå†…å®¹æ—¶å‡ºé”™: $e');
            return _buildErrorState('é¡µé¢æ¸²æŸ“å‡ºé”™ï¼Œè¯·é‡è¯•');
          }
        },
      ),
    );
  }

  /// æ„å»ºåˆå§‹çŠ¶æ€
  Widget _buildInitialState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.star_outline,
            size: 64,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          Text(
            'æš‚æ— è‡ªé€‰åŸºé‡‘',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w600,
              color: Colors.grey[600],
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ‚¨å…³æ³¨çš„åŸºé‡‘',
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey[500],
            ),
          ),
        ],
      ),
    );
  }

  /// æ„å»ºåŠ è½½çŠ¶æ€
  Widget _buildLoadingState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          CircularProgressIndicator(),
          SizedBox(height: 16),
          Text('åŠ è½½ä¸­...'),
        ],
      ),
    );
  }

  /// æ„å»ºæ•°æ®åŠ è½½å®ŒæˆçŠ¶æ€
  Widget _buildLoadedState(BuildContext context, FundFavoriteLoaded state) {
    try {
      // å®‰å…¨æ£€æŸ¥
      if (state.displayFavorites.isEmpty) {
        return _buildEmptySearchState(state.searchQuery);
      }

      return RefreshIndicator(
        onRefresh: () async {
          if (context.mounted) {
            context.read<FundFavoriteCubit>().refresh();
          }
        },
        child: Column(
          children: [
            // ç»Ÿè®¡ä¿¡æ¯æ 
            _buildStatsBar(state),

            // åŸºé‡‘åˆ—è¡¨
            Expanded(
              child: ListView.builder(
                padding: const EdgeInsets.all(16),
                itemCount: state.displayFavorites.length,
                itemBuilder: (context, index) {
                  try {
                    if (index >= 0 && index < state.displayFavorites.length) {
                      final favorite = state.displayFavorites[index];
                      return _buildFavoriteCard(context, favorite);
                    }
                    return const SizedBox.shrink();
                  } catch (e) {
                    print('æ„å»ºåŸºé‡‘å¡ç‰‡æ—¶å‡ºé”™ (index: $index): $e');
                    return const SizedBox.shrink();
                  }
                },
              ),
            ),
          ],
        ),
      );
    } catch (e) {
      print('æ„å»ºåŠ è½½çŠ¶æ€æ—¶å‡ºé”™: $e');
      return _buildErrorState('æ•°æ®åŠ è½½å‡ºé”™ï¼Œè¯·é‡è¯•');
    }
  }

  /// æ„å»ºç©ºæœç´¢çŠ¶æ€
  Widget _buildEmptySearchState(String searchQuery) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.search_off,
            size: 64,
            color: Colors.grey[400],
          ),
          const SizedBox(height: 16),
          Text(
            'æœªæ‰¾åˆ°ç›¸å…³åŸºé‡‘',
            style: TextStyle(
              fontSize: 18,
              fontWeight: FontWeight.w600,
              color: Colors.grey[600],
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'æœç´¢è¯: "$searchQuery"',
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey[500],
            ),
          ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: () {
              _searchController.clear();
              context.read<FundFavoriteCubit>().searchFavorites('');
            },
            child: const Text('æ¸…é™¤æœç´¢'),
          ),
        ],
      ),
    );
  }

  /// æ„å»ºç»Ÿè®¡ä¿¡æ¯æ 
  Widget _buildStatsBar(FundFavoriteLoaded state) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      margin: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).primaryColor.withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        children: [
          Icon(
            Icons.analytics_outlined,
            color: Theme.of(context).primaryColor,
            size: 20,
          ),
          const SizedBox(width: 8),
          Expanded(
            child: Text(
              state.searchQuery.isEmpty
                  ? 'å…± ${state.favoriteCount} åªè‡ªé€‰åŸºé‡‘'
                  : 'æ‰¾åˆ° ${state.displayFavorites.length} åªç›¸å…³åŸºé‡‘',
              style: TextStyle(
                color: Theme.of(context).primaryColor,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
          if (state.lastMessage != null) ...[
            Container(
              width: 4,
              height: 4,
              decoration: BoxDecoration(
                color: Theme.of(context).primaryColor,
                shape: BoxShape.circle,
              ),
            ),
            const SizedBox(width: 8),
            Text(
              state.lastMessage!,
              style: TextStyle(
                color: Theme.of(context).primaryColor,
                fontSize: 12,
              ),
            ),
          ],
        ],
      ),
    );
  }

  /// æ„å»ºè‡ªé€‰åŸºé‡‘å¡ç‰‡
  Widget _buildFavoriteCard(BuildContext context, FundFavorite favorite) {
    return Card(
      margin: const EdgeInsets.only(bottom: 12),
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
        side: BorderSide(color: Colors.grey[200]!),
      ),
      child: InkWell(
        borderRadius: BorderRadius.circular(12),
        onTap: () {
          // TODO: å¯¼èˆªåˆ°åŸºé‡‘è¯¦æƒ…é¡µ
        },
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Row(
            children: [
              // åŸºé‡‘ä¿¡æ¯
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Text(
                          favorite.fundCode,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 16,
                          ),
                        ),
                        const SizedBox(width: 8),
                        Container(
                          padding: const EdgeInsets.symmetric(
                            horizontal: 6,
                            vertical: 2,
                          ),
                          decoration: BoxDecoration(
                            color: _getFundTypeColor(favorite.fundType).withOpacity(0.1),
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            favorite.fundType,
                            style: TextStyle(
                              color: _getFundTypeColor(favorite.fundType),
                              fontSize: 10,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 4),
                    Text(
                      favorite.fundName,
                      style: TextStyle(
                        fontSize: 14,
                        color: Colors.grey[600],
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                    if (favorite.notes != null) ...[
                      const SizedBox(height: 4),
                      Text(
                        favorite.notes!,
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey[500],
                          fontStyle: FontStyle.italic,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ],
                ),
              ),

              // å‡€å€¼ä¿¡æ¯
              Column(
                crossAxisAlignment: CrossAxisAlignment.end,
                children: [
                  if (favorite.currentNav != null) ...[
                    Text(
                      'Â¥${favorite.currentNav!.toStringAsFixed(4)}',
                      style: const TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                      ),
                    ),
                    const SizedBox(height: 4),
                    _buildChangeIndicator(favorite.dailyChange),
                  ] else ...[
                    Text(
                      '--',
                      style: TextStyle(
                        color: Colors.grey[400],
                        fontSize: 16,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      'æš‚æ— æ•°æ®',
                      style: TextStyle(
                        color: Colors.grey[400],
                        fontSize: 12,
                      ),
                    ),
                  ],
                ],
              ),

              const SizedBox(width: 12),

              // æ“ä½œæŒ‰é’®
              PopupMenuButton<String>(
                icon: Icon(Icons.more_vert, color: Colors.grey[600]),
                onSelected: (value) => _handleFavoriteAction(context, favorite, value),
                itemBuilder: (context) => [
                  const PopupMenuItem(
                    value: 'edit',
                    child: Row(
                      children: [
                        Icon(Icons.edit, size: 16),
                        SizedBox(width: 8),
                        Text('ç¼–è¾‘'),
                      ],
                    ),
                  ),
                  const PopupMenuItem(
                    value: 'add_to_portfolio',
                    child: Row(
                      children: [
                        Icon(Icons.add_chart, size: 16, color: Colors.blue),
                        SizedBox(width: 8),
                        Text('æ·»åŠ åˆ°æŒä»“', style: TextStyle(color: Colors.blue)),
                      ],
                    ),
                  ),
                  const PopupMenuItem(
                    value: 'remove',
                    child: Row(
                      children: [
                        Icon(Icons.remove_circle_outline, size: 16, color: Colors.red),
                        SizedBox(width: 8),
                        Text('ç§»é™¤', style: TextStyle(color: Colors.red)),
                      ],
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// æ„å»ºæ¶¨è·ŒæŒ‡æ ‡
  Widget _buildChangeIndicator(double? change) {
    if (change == null) {
      return Text(
        '--',
        style: TextStyle(
          color: Colors.grey[400],
          fontSize: 12,
        ),
      );
    }

    final isPositive = change >= 0;
    final color = isPositive ? Colors.red : Colors.green;
    final sign = isPositive ? '+' : '';

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(4),
      ),
      child: Text(
        '$sign${change.toStringAsFixed(2)}%',
        style: TextStyle(
          color: color,
          fontSize: 12,
          fontWeight: FontWeight.w500,
        ),
      ),
    );
  }

  /// æ„å»ºé”™è¯¯çŠ¶æ€
  Widget _buildErrorState(String error) {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            Icons.error_outline,
            size: 64,
            color: Colors.red[400],
          ),
          const SizedBox(height: 16),
          Text(
            'å‡ºé”™äº†',
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.w600,
              color: Colors.grey[600],
            ),
          ),
          const SizedBox(height: 8),
          Text(
            error,
            style: TextStyle(
              fontSize: 14,
              color: Colors.grey[500],
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 16),
          ElevatedButton(
            onPressed: () {
              context.read<FundFavoriteCubit>().refresh();
            },
            child: const Text('é‡è¯•'),
          ),
        ],
      ),
    );
  }

  /// æ„å»ºæµ®åŠ¨æ“ä½œæŒ‰é’®
  Widget _buildFloatingActionButton() {
    return FloatingActionButton.extended(
      onPressed: _showAddFavoriteDialog,
      icon: const Icon(Icons.add),
      label: const Text('æ·»åŠ åŸºé‡‘'),
    );
  }

  /// å¤„ç†èœå•æ“ä½œ
  void _handleMenuAction(String action) {
    switch (action) {
      case 'sort':
        _showSortDialog();
        break;
      case 'clear_all':
        _showClearAllDialog();
        break;
      case 'refresh':
        context.read<FundFavoriteCubit>().refresh();
        break;
    }
  }

  /// å¤„ç†åŸºé‡‘å¡ç‰‡æ“ä½œ
  void _handleFavoriteAction(BuildContext context, FundFavorite favorite, String action) {
    switch (action) {
      case 'edit':
        _showEditFavoriteDialog(favorite);
        break;
      case 'add_to_portfolio':
        _showAddToPortfolioDialog(favorite);
        break;
      case 'remove':
        _showRemoveFavoriteDialog(favorite);
        break;
    }
  }

  /// æ˜¾ç¤ºæ·»åŠ åˆ°æŒä»“å¯¹è¯æ¡†
  void _showAddToPortfolioDialog(FundFavorite favorite) {
    showDialog(
      context: context,
      builder: (context) => _AddToPortfolioDialog(
        favorite: favorite,
        onConfirm: (holding) {
          // TODO: å®ç°æ·»åŠ åˆ°æŒä»“çš„é€»è¾‘
          // è¿™é‡Œéœ€è¦è°ƒç”¨ PortfolioAnalysisCubit æ¥æ·»åŠ æŒä»“
          _navigateToPortfolioPage();
        },
      ),
    );
  }

  /// å¯¼èˆªåˆ°æŒä»“åˆ†æé¡µé¢
  void _navigateToPortfolioPage() {
    // ä½¿ç”¨ Navigator å¯¼èˆªåˆ°æŒä»“åˆ†æé¡µé¢
    final context = this.context;
    if (context.mounted) {
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => const PortfolioAnalysisPage(),
        ),
      );
    }
  }

  /// æ˜¾ç¤ºæ·»åŠ è‡ªé€‰åŸºé‡‘å¯¹è¯æ¡†
  void _showAddFavoriteDialog() {
    showDialog(
      context: context,
      builder: (context) => _AddFavoriteDialog(
        onAdd: (favorite) {
          context.read<FundFavoriteCubit>().addFavorite(favorite);
        },
      ),
    );
  }

  /// æ˜¾ç¤ºç¼–è¾‘è‡ªé€‰åŸºé‡‘å¯¹è¯æ¡†
  void _showEditFavoriteDialog(FundFavorite favorite) {
    showDialog(
      context: context,
      builder: (context) => _EditFavoriteDialog(
        favorite: favorite,
        onUpdate: (updatedFavorite) {
          context.read<FundFavoriteCubit>().updateFavorite(updatedFavorite);
        },
      ),
    );
  }

  /// æ˜¾ç¤ºç§»é™¤ç¡®è®¤å¯¹è¯æ¡†
  void _showRemoveFavoriteDialog(FundFavorite favorite) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ç¡®è®¤ç§»é™¤'),
        content: Text('ç¡®å®šè¦ä»è‡ªé€‰ä¸­ç§»é™¤ ${favorite.fundName} å—ï¼Ÿ'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('å–æ¶ˆ'),
          ),
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
              context.read<FundFavoriteCubit>().removeFavorite(favorite.fundCode);
            },
            style: TextButton.styleFrom(foregroundColor: Colors.red),
            child: const Text('ç§»é™¤'),
          ),
        ],
      ),
    );
  }

  /// æ˜¾ç¤ºæ’åºå¯¹è¯æ¡†
  void _showSortDialog() {
    showDialog(
      context: context,
      builder: (context) => _SortDialog(
        currentSortType: _currentSortType,
        currentSortDirection: _currentSortDirection,
        onSort: (type, direction) {
          setState(() {
            _currentSortType = type;
            _currentSortDirection = direction;
          });
          context.read<FundFavoriteCubit>().sortFavorites(type, direction);
        },
      ),
    );
  }

  /// æ˜¾ç¤ºæ¸…ç©ºå…¨éƒ¨ç¡®è®¤å¯¹è¯æ¡†
  void _showClearAllDialog() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ç¡®è®¤æ¸…ç©º'),
        content: const Text('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‡ªé€‰åŸºé‡‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('å–æ¶ˆ'),
          ),
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
              context.read<FundFavoriteCubit>().clearAllFavorites();
            },
            style: TextButton.styleFrom(foregroundColor: Colors.red),
            child: const Text('æ¸…ç©ºå…¨éƒ¨'),
          ),
        ],
      ),
    );
  }

  /// è·å–åŸºé‡‘ç±»å‹é¢œè‰²
  Color _getFundTypeColor(String fundType) {
    switch (fundType) {
      case 'è‚¡ç¥¨å‹':
        return Colors.red;
      case 'å€ºåˆ¸å‹':
        return Colors.blue;
      case 'æ··åˆå‹':
        return Colors.orange;
      case 'è´§å¸å‹':
        return Colors.green;
      case 'æŒ‡æ•°å‹':
        return Colors.purple;
      default:
        return Colors.grey;
    }
  }

  /// åˆå§‹åŒ–æ™ºèƒ½æœç´¢
  void _initializeSmartSearch() async {
    _loadSearchHistory();
    _loadPopularSearches();

    // åˆå§‹åŒ–é«˜æ€§èƒ½æœåŠ¡
    try {
      await _fundService.initialize();
      // é¢„åŠ è½½æ•°æ® - åœ¨ç©ºé—²æ—¶é—´è§¦å‘
      WidgetsBinding.instance.addPostFrameCallback((_) {
        if (mounted) {
          // ä½¿ç”¨æ™ºèƒ½é¢„åŠ è½½ç®¡ç†å™¨
    // await _preloadManager.triggerBehaviorPreload('000001');
        }
      });
    } catch (e) {
      // å¿½ç•¥åˆå§‹åŒ–é”™è¯¯ï¼Œä¸å½±å“é¡µé¢æ­£å¸¸ä½¿ç”¨
    }
  }

  
  /// åŠ è½½æœç´¢å†å²
  void _loadSearchHistory() {
    // æ¨¡æ‹Ÿä»æœ¬åœ°å­˜å‚¨åŠ è½½æœç´¢å†å²
    setState(() {
      _searchHistory = [
        'æ˜“æ–¹è¾¾',
        'åå¤',
        'å—æ–¹',
        'å˜‰å®',
        'åšæ—¶',
      ];
    });
  }

  /// åŠ è½½çƒ­é—¨æœç´¢
  void _loadPopularSearches() {
    setState(() {
      _popularSearches = [
        'æ˜“æ–¹è¾¾è“ç­¹',
        'å¯Œå›½å¤©æƒ ',
        'å…´å…¨åˆæ¶¦',
        'æ±‡æ·»å¯Œä»·å€¼',
      ];
    });
  }

  /// æ„å»ºæ™ºèƒ½æœç´¢æ¡†
  Widget _buildSmartSearchField() {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.03),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: TextField(
        controller: _searchController,
        focusNode: _searchFocusNode,
        decoration: InputDecoration(
          hintText: 'æœç´¢åŸºé‡‘ä»£ç æˆ–åç§°...',
          prefixIcon: Icon(Icons.search, color: Colors.grey[600]),
          suffixIcon: _isSearching
              ? Container(
                  width: 20,
                  height: 20,
                  margin: EdgeInsets.all(12),
                  child: CircularProgressIndicator(strokeWidth: 2),
                )
              : IconButton(
                  icon: Icon(Icons.clear, color: Colors.grey[600]),
                  onPressed: () {
                    _searchController.clear();
                    setState(() {
                      _searchSuggestions.clear();
                      _isSearching = false;
                    });
                  },
                ),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide.none,
          ),
          filled: true,
          fillColor: Colors.grey[50],
          contentPadding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        ),
        onChanged: (value) {
          if (value.trim().isEmpty) {
            setState(() {
              _searchSuggestions.clear();
              _isSearching = false;
            });
            return;
          }

          // é˜²æŠ–æœç´¢
          _searchDebounce?.cancel();
          _searchDebounce = Timer(Duration(milliseconds: 300), () {
            _performSearch(value.trim());
          });
        },
        onSubmitted: (value) {
          if (value.trim().isNotEmpty) {
            _addToSearchHistory(value.trim());
          }
        },
      ),
    );
  }

  /// æ‰§è¡Œæœç´¢
  void _performSearch(String query) async {
    setState(() => _isSearching = true);

    try {
      // ä½¿ç”¨ä¼˜åŒ–æœç´¢æœåŠ¡ï¼Œå¢åŠ å»ºè®®æ•°é‡åˆ°20æ¡
      final searchResult = await _fundService.searchFunds(query);
      setState(() {
        _searchSuggestions = searchResult.funds.take(20).map((fund) => models.FundInfo(
          code: fund.code,
          name: fund.name,
          type: fund.type,
          pinyinAbbr: fund.pinyinAbbr,
          pinyinFull: fund.pinyinFull,
        )).toList();
        _isSearching = false;
      });
    } catch (e) {
      setState(() => _isSearching = false);
    }
  }

  /// è·å–æœç´¢å»ºè®®
  Future<List<String>> _getSearchSuggestions(String prefix) async {
    try {
      // ä½¿ç”¨æ™ºèƒ½ç¼“å­˜ç®¡ç†å™¨è·å–æœç´¢å»ºè®®
      return await _cacheManager.getSearchSuggestions(prefix);
    } catch (e) {
      return [];
    }
  }

  /// æ·»åŠ åˆ°æœç´¢å†å²
  void _addToSearchHistory(String query) {
    setState(() {
      _searchHistory.remove(query);
      _searchHistory.insert(0, query);
      if (_searchHistory.length > 10) {
        _searchHistory = _searchHistory.take(10).toList();
      }
    });
  }

  /// æ„å»ºæœç´¢å»ºè®®
  Widget _buildSearchSuggestions() {
    if (_searchSuggestions.isEmpty && !_isSearching) {
      return _buildSearchHistory();
    }

    if (_isSearching) {
      return Container(
        height: 200,
        child: Center(
          child: CircularProgressIndicator(),
        ),
      );
    }

    return Container(
      height: 300,
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(bottom: Radius.circular(12)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        children: [
          // æœç´¢ç»“æœç»Ÿè®¡å¤´éƒ¨
          Container(
            padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
            decoration: BoxDecoration(
              border: Border(bottom: BorderSide(color: Colors.grey[200]!)),
            ),
            child: Row(
              children: [
                Icon(Icons.search, color: Colors.blue, size: 16),
                SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'æ‰¾åˆ° ${_searchSuggestions.length} åªåŸºé‡‘ (æ— é™åˆ¶æœç´¢)',
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[600],
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
                if (_searchSuggestions.length >= 20)
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                    decoration: BoxDecoration(
                      color: Colors.blue[50],
                      borderRadius: BorderRadius.circular(10),
                    ),
                    child: Text(
                      'æ˜¾ç¤ºå‰20æ¡',
                      style: TextStyle(
                        fontSize: 10,
                        color: Colors.blue[700],
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                  ),
              ],
            ),
          ),
          // æœç´¢ç»“æœåˆ—è¡¨
          Expanded(
            child: ListView.builder(
              itemCount: _searchSuggestions.length,
              itemBuilder: (context, index) {
              final suggestion = _searchSuggestions[index];
              return ListTile(
                leading: CircleAvatar(
                  radius: 16,
                  backgroundColor: Colors.blue[50],
                  child: Text(
                    suggestion.code.substring(0, 3),
                    style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold),
                  ),
                ),
                title: Text(suggestion.name),
                subtitle: Text('${suggestion.code} Â· ${suggestion.simplifiedType}'),
                onTap: () => _selectFund(suggestion),
              );
            },
            ),
          ),
        ],
      ),
    );
  }

  /// æ„å»ºæœç´¢å†å²
  Widget _buildSearchHistory() {
    if (_searchHistory.isEmpty) {
      return SizedBox.shrink();
    }

    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(bottom: Radius.circular(12)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 8,
            offset: Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Padding(
            padding: EdgeInsets.all(16),
            child: Text(
              'æœç´¢å†å²',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w600,
                color: Colors.grey[600],
              ),
            ),
          ),
          ..._searchHistory.map((query) => ListTile(
            leading: Icon(Icons.history, color: Colors.grey[600]),
            title: Text(query),
            onTap: () {
              _searchController.text = query;
              _performSearch(query);
            },
            trailing: IconButton(
              icon: Icon(Icons.close, size: 16),
              onPressed: () {
                setState(() {
                  _searchHistory.remove(query);
                });
              },
            ),
          )).toList(),
        ],
      ),
    );
  }

  /// æ„å»ºå¿«é€Ÿç­›é€‰èŠ¯ç‰‡
  Widget _buildQuickFilterChips() {
    final filters = ['è‚¡ç¥¨å‹', 'æ··åˆå‹', 'å€ºåˆ¸å‹', 'æŒ‡æ•°å‹'];

    return Container(
      height: 40,
      child: ListView.builder(
        scrollDirection: Axis.horizontal,
        itemCount: filters.length,
        itemBuilder: (context, index) {
          final filter = filters[index];
          return Container(
            margin: EdgeInsets.only(right: 8),
            child: FilterChip(
              label: Text(filter),
              selected: false,
              onSelected: (selected) {
                _searchController.text = filter;
                _performSearch(filter);
              },
              backgroundColor: Colors.grey[100],
              selectedColor: Colors.blue[50],
              checkmarkColor: Colors.blue[600],
              labelStyle: TextStyle(
                color: Colors.grey[700],
                fontSize: 12,
              ),
            ),
          );
        },
      ),
    );
  }

  /// é€‰æ‹©åŸºé‡‘
  void _selectFund(models.FundInfo fund) {
    setState(() {
      _searchSuggestions.clear();
    });
    _searchController.text = fund.name;
    // è¿™é‡Œå¯ä»¥æ·»åŠ é€‰æ‹©åŸºé‡‘åçš„é€»è¾‘
  }

  /// éšè—æœç´¢ç»“æœ
  void _hideSearchResults() {
    setState(() {
      _searchSuggestions.clear();
      _isSearching = false;
    });
  }
}

/// æ·»åŠ è‡ªé€‰åŸºé‡‘å¯¹è¯æ¡†
class _AddFavoriteDialog extends StatefulWidget {
  final Function(FundFavorite) onAdd;

  const _AddFavoriteDialog({required this.onAdd});

  @override
  State<_AddFavoriteDialog> createState() => _AddFavoriteDialogState();
}

class _AddFavoriteDialogState extends State<_AddFavoriteDialog> {
  final _formKey = GlobalKey<FormState>();
  final _fundCodeController = TextEditingController();
  final _fundNameController = TextEditingController();
  final _fundManagerController = TextEditingController();
  final _notesController = TextEditingController();
  bool _isLoading = false;

  // æ™ºèƒ½æœç´¢ç›¸å…³çŠ¶æ€
  List<models.FundInfo> _searchResults = [];
  bool _isSearching = false;
  bool _showSearchResults = false;
  final LayerLink _layerLink = LayerLink();
  OverlayEntry? _overlayEntry;
  final FocusNode _fundCodeFocusNode = FocusNode();

  /// é€šè¿‡APIç›´æ¥è·å–åŸºé‡‘ç±»å‹
  Future<String> _getFundType(String fundCode) async {
    try {
      print('ğŸ” å¼€å§‹æŸ¥æ‰¾åŸºé‡‘ $fundCode çš„ç±»å‹...');

      final response = await http.get(
        Uri.parse('http://154.44.25.92:8080/api/public/fund_name_em'),
        headers: {'Accept': 'application/json'},
      ).timeout(const Duration(seconds: 10));

      if (response.statusCode == 200) {
        final List<dynamic> funds = json.decode(response.body);
        print('ğŸ“Š è·å–åˆ° ${funds.length} åªåŸºé‡‘æ•°æ®');

        // ç›´æ¥æŸ¥æ‰¾åŸºé‡‘
        final fund = funds.firstWhere(
          (f) => f['åŸºé‡‘ä»£ç ']?.toString() == fundCode,
          orElse: () => null,
        );

        if (fund != null && fund['åŸºé‡‘ç±»å‹'] != null) {
          String fundType = fund['åŸºé‡‘ç±»å‹'].toString();
          // ç®€åŒ–åŸºé‡‘ç±»å‹æ˜¾ç¤ºï¼Œå–ä¸»è¦ç±»å‹
          if (fundType.contains('-')) {
            fundType = fundType.split('-')[0];
          }
          print('âœ… æ‰¾åˆ°åŸºé‡‘ $fundCode: ${fund['åŸºé‡‘ç®€ç§°']} - $fundType');
          return fundType;
        } else {
          print('âš ï¸ æœªæ‰¾åˆ°åŸºé‡‘ $fundCode çš„ç±»å‹ä¿¡æ¯');
          // å°è¯•ç¼“å­˜è·å–ä½œä¸ºå¤‡ç”¨
          final cachedType = FundDataCacheService.instance.getFundType(fundCode);
          if (cachedType != 'æœªçŸ¥ç±»å‹') {
            print('ğŸ”„ ä»ç¼“å­˜è·å–åˆ°ç±»å‹: $cachedType');
            return cachedType;
          }
        }
      } else {
        print('âŒ APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.statusCode}');
      }
    } catch (e) {
      print('âŒ è·å–åŸºé‡‘ç±»å‹å¤±è´¥: $e');
    }

    // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šä»ç¼“å­˜è·å–æˆ–æ ¹æ®ä»£ç æ¨æ–­
    final cachedType = FundDataCacheService.instance.getFundType(fundCode);
    if (cachedType != 'æœªçŸ¥ç±»å‹') {
      return cachedType;
    }

    return _inferFundTypeFromCode(fundCode);
  }

  /// æ ¹æ®åŸºé‡‘ä»£ç æ¨æ–­åŸºé‡‘ç±»å‹ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
  String _inferFundTypeFromCode(String fundCode) {
    if (fundCode.startsWith('00')) {
      return 'æ··åˆå‹';
    } else if (fundCode.startsWith('11')) {
      return 'å€ºåˆ¸å‹';
    } else if (fundCode.startsWith('15')) {
      return 'æŒ‡æ•°å‹';
    } else if (fundCode.startsWith('16')) {
      return 'å€ºåˆ¸å‹';
    } else if (fundCode.startsWith('18')) {
      return 'è‚¡ç¥¨å‹';
    } else if (fundCode.startsWith('50')) {
      return 'æŒ‡æ•°å‹';
    } else if (fundCode.startsWith('51')) {
      return 'æŒ‡æ•°å‹';
    } else if (fundCode.startsWith('52')) {
      return 'è´§å¸å‹';
    } else {
      return 'æœªçŸ¥ç±»å‹';
    }
  }

  /// åˆå§‹åŒ–æœç´¢åŠŸèƒ½
  void _initializeSearch() async {
    await _fundService.initialize();
    await _cacheManager.initialize();
  }

  /// æœç´¢åŸºé‡‘
  void _searchFunds(String query) async {
    if (query.isEmpty) {
      _hideSearchResults();
      return;
    }

    setState(() {
      _isSearching = true;
    });

    try {
      // ä½¿ç”¨ä¼˜åŒ–æœç´¢æœåŠ¡è¿›è¡Œæ— é™åˆ¶æœç´¢
      final searchResult = await _fundService.searchFunds(query);

      setState(() {
        _searchResults = searchResult.funds.map((fund) => models.FundInfo(
          code: fund.code,
          name: fund.name,
          type: fund.type,
          pinyinAbbr: fund.pinyinAbbr,
          pinyinFull: fund.pinyinFull,
        )).toList();
        _isSearching = false;
        _showSearchResults = true;
      });
      _showSearchOverlay();
      return;
    }

    } catch (e) {
      // å¦‚æœä¼˜åŒ–æœç´¢å¤±è´¥ï¼Œé™çº§åˆ°ç¼“å­˜æœç´¢
      try {
        final cachedResults = FundDataCacheService.instance.searchFunds(query, limit: 20);

        if (cachedResults.isNotEmpty) {
          setState(() {
            _searchResults = cachedResults.map((fund) => models.FundInfo(
              code: fund.code,
              name: fund.name,
              type: fund.type,
              pinyinAbbr: fund.pinyin,
              pinyinFull: fund.fullName,
            )).toList();
            _isSearching = false;
            _showSearchResults = true;
          });
          _showSearchOverlay();
          return;
        }
      } catch (cacheError) {
        // å¦‚æœç¼“å­˜ä¹Ÿå¤±è´¥ï¼Œç›´æ¥ä»APIæœç´¢
        final apiResults = await _searchFundsFromAPI(query, limit: 50); // å¢åŠ åˆ°50æ¡

        setState(() {
          _searchResults = apiResults;
          _isSearching = false;
          _showSearchResults = apiResults.isNotEmpty;
        });

        if (apiResults.isNotEmpty) {
          _showSearchOverlay();
        }
      }
    }
    } catch (e) {
      print('æœç´¢åŸºé‡‘å¤±è´¥: $e');
      setState(() {
        _isSearching = false;
        _showSearchResults = false;
      });
      _hideSearchResults();
    }
  }

  /// ä»APIç›´æ¥æœç´¢åŸºé‡‘
  Future<List<models.FundInfo>> _searchFundsFromAPI(String query, {int limit = 10}) async {
    try {
      print('ğŸ” ä»APIæœç´¢åŸºé‡‘: $query');

      final response = await http.get(
        Uri.parse('http://154.44.25.92:8080/api/public/fund_name_em'),
        headers: {'Accept': 'application/json'},
      ).timeout(const Duration(seconds: 10));

      if (response.statusCode == 200) {
        final List<dynamic> funds = json.decode(response.body);
        final queryLower = query.toLowerCase();
        final results = <models.FundInfo>[];

        // ç²¾ç¡®åŒ¹é…åŸºé‡‘ä»£ç 
        final exactMatch = funds.firstWhere(
          (f) => f['åŸºé‡‘ä»£ç ']?.toString() == query,
          orElse: () => null,
        );

        if (exactMatch != null) {
          final fundInfo = _convertToFundInfo(exactMatch);
          if (fundInfo != null) results.add(fundInfo);
        }

        // æ¨¡ç³Šæœç´¢
        for (final fund in funds) {
          if (results.length >= limit) break;

          final fundInfo = _convertToFundInfo(fund);
          if (fundInfo == null) continue;
          if (results.any((r) => r.code == fundInfo.code)) continue;

          // ä»£ç åŒ¹é…
          if (fundInfo.code.contains(query)) {
            results.add(fundInfo);
            continue;
          }

          // åç§°åŒ¹é…
          if (fundInfo.name.toLowerCase().contains(queryLower)) {
            results.add(fundInfo);
            continue;
          }

          // æ‹¼éŸ³åŒ¹é…
          if (fundInfo.pinyinAbbr.toLowerCase().contains(queryLower)) {
            results.add(fundInfo);
            continue;
          }
        }

        print('âœ… APIæœç´¢å®Œæˆï¼Œæ‰¾åˆ° ${results.length} åªåŸºé‡‘');
        return results.take(limit).toList();
      }
    } catch (e) {
      print('âŒ APIæœç´¢å¤±è´¥: $e');
    }

    return [];
  }

  /// å°†APIæ•°æ®è½¬æ¢ä¸ºFundInfoå¯¹è±¡
  models.FundInfo? _convertToFundInfo(dynamic fund) {
    try {
      final code = fund['åŸºé‡‘ä»£ç ']?.toString();
      final name = fund['åŸºé‡‘ç®€ç§°']?.toString();
      final type = fund['åŸºé‡‘ç±»å‹']?.toString();
      final pinyin = fund['æ‹¼éŸ³ç¼©å†™']?.toString();
      final fullName = fund['æ‹¼éŸ³å…¨ç§°']?.toString();

      if (code != null && name != null) {
        return models.FundInfo(
          code: code,
          name: name,
          type: type ?? 'æœªçŸ¥ç±»å‹',
          pinyinAbbr: pinyin ?? '',
          pinyinFull: fullName ?? '',
        );
      }
    } catch (e) {
      print('âš ï¸ è½¬æ¢åŸºé‡‘æ•°æ®å¤±è´¥: $e');
    }
    return null;
  }

  /// æ˜¾ç¤ºæœç´¢ç»“æœè¦†ç›–å±‚
  void _showSearchOverlay() {
    _hideSearchResults(); // å…ˆéšè—æ—§çš„

    _overlayEntry = OverlayEntry(
      builder: (context) => _buildSearchOverlay(),
    );

    Overlay.of(context).insert(_overlayEntry!);
  }

  /// éšè—æœç´¢ç»“æœ
  void _hideSearchResults() {
    _overlayEntry?.remove();
    _overlayEntry = null;
    setState(() {
      _showSearchResults = false;
    });
  }

  /// é€‰æ‹©æœç´¢ç»“æœä¸­çš„åŸºé‡‘
  void _selectFund(models.FundInfo fund) {
    _hideSearchResults();
    _fundCodeController.text = fund.code;
    _fundNameController.text = fund.name;

    // è‡ªåŠ¨å¡«å……åŸºé‡‘ç®¡ç†äººä¿¡æ¯
    if (_fundManagerController.text.isEmpty) {
      _fundManagerController.text = 'æœªçŸ¥';
    }

    // è‡ªåŠ¨å¡«å……å¤‡æ³¨ä¿¡æ¯
    if (_notesController.text.isEmpty) {
      _notesController.text = 'æ•°æ®æ¥æº: http://154.44.25.92:8080';
    }

    // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
    FocusScope.of(context).requestFocus(FocusNode());
  }

  /// è·å–åŸºé‡‘ç±»å‹é¢œè‰²
  Color _getFundTypeColor(String fundType) {
    switch (fundType) {
      case 'è‚¡ç¥¨å‹':
        return Colors.red;
      case 'å€ºåˆ¸å‹':
        return Colors.blue;
      case 'æ··åˆå‹':
        return Colors.orange;
      case 'è´§å¸å‹':
        return Colors.green;
      case 'æŒ‡æ•°å‹':
        return Colors.purple;
      default:
        return Colors.grey;
    }
  }

  /// æ„å»ºæœç´¢ç»“æœè¦†ç›–å±‚
  Widget _buildSearchOverlay() {
    final renderBox = context.findRenderObject() as RenderBox?;
    final size = renderBox?.size ?? Size.zero;
    final offset = renderBox?.localToGlobal(Offset.zero) ?? Offset.zero;

    return Positioned(
      left: offset.dx,
      top: offset.dy + size.height + 5,
      width: size.width,
      child: CompositedTransformFollower(
        link: _layerLink,
        showWhenUnlinked: false,
        offset: Offset(0, size.height + 5),
        child: Material(
          elevation: 8,
          borderRadius: BorderRadius.circular(12),
          child: Container(
            constraints: BoxConstraints(maxHeight: 300),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.1),
                  blurRadius: 10,
                  offset: Offset(0, 4),
                ),
              ],
            ),
            child: _isSearching
                ? Container(
                    padding: EdgeInsets.all(16),
                    child: Center(
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          CircularProgressIndicator(strokeWidth: 2),
                          SizedBox(width: 8),
                          Text('æœç´¢ä¸­...'),
                        ],
                      ),
                    ),
                  )
                : ListView.builder(
                    shrinkWrap: true,
                    itemCount: _searchResults.length,
                    itemBuilder: (context, index) {
                      final fund = _searchResults[index];
                      return _buildFundSearchResult(fund);
                    },
                  ),
          ),
        ),
      ),
    );
  }

  /// æ„å»ºå•ä¸ªåŸºé‡‘æœç´¢ç»“æœé¡¹
  Widget _buildFundSearchResult(models.FundInfo fund) {
    return InkWell(
      onTap: () => _selectFund(fund),
      child: Container(
        padding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          border: Border(
            bottom: BorderSide(
              color: Colors.grey.withOpacity(0.2),
              width: 0.5,
            ),
          ),
        ),
        child: Row(
          children: [
            // åŸºé‡‘ä»£ç 
            Container(
              padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              decoration: BoxDecoration(
                color: Colors.blue.withOpacity(0.1),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                fund.code,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.blue,
                  fontSize: 12,
                ),
              ),
            ),
            SizedBox(width: 12),

            // åŸºé‡‘åç§°
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    fund.name,
                    style: TextStyle(
                      fontWeight: FontWeight.w500,
                      fontSize: 14,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  SizedBox(height: 2),
                  Text(
                    fund.simplifiedType,
                    style: TextStyle(
                      fontSize: 12,
                      color: Colors.grey[600],
                    ),
                  ),
                ],
              ),
            ),

            // ç±»å‹æ ‡ç­¾
            Container(
              padding: EdgeInsets.symmetric(horizontal: 6, vertical: 2),
              decoration: BoxDecoration(
                color: _getFundTypeColor(fund.simplifiedType).withOpacity(0.1),
                borderRadius: BorderRadius.circular(4),
              ),
              child: Text(
                fund.simplifiedType,
                style: TextStyle(
                  color: _getFundTypeColor(fund.simplifiedType),
                  fontSize: 10,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  @override
  void initState() {
    super.initState();
    _initializeSearch();
  }

  @override
  void dispose() {
    _hideSearchResults();
    _fundCodeController.dispose();
    _fundNameController.dispose();
    _fundManagerController.dispose();
    _notesController.dispose();
    _fundCodeFocusNode.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Row(
        children: [
          Icon(Icons.add_circle, color: Theme.of(context).primaryColor),
          const SizedBox(width: 8),
          const Text('æ·»åŠ è‡ªé€‰åŸºé‡‘'),
          Spacer(),
          if (_showSearchResults)
            IconButton(
              icon: Icon(Icons.keyboard_arrow_down, color: Theme.of(context).primaryColor),
              onPressed: _hideSearchResults,
              tooltip: 'éšè—æœç´¢ç»“æœ',
            ),
        ],
      ),
      content: SizedBox(
        width: 450,
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // åŸºé‡‘ä»£ç è¾“å…¥æ¡†ï¼ˆæ”¯æŒæ™ºèƒ½æœç´¢ï¼‰
              CompositedTransformTarget(
                link: _layerLink,
                child: TextFormField(
                  controller: _fundCodeController,
                  focusNode: _fundCodeFocusNode,
                  decoration: InputDecoration(
                    labelText: 'åŸºé‡‘ä»£ç /åç§°æœç´¢ *',
                    hintText: 'è¾“å…¥åŸºé‡‘ä»£ç ã€åç§°æˆ–æ‹¼éŸ³ï¼Œå¦‚ï¼š000001ã€åå¤ã€HXCZHH',
                    prefixIcon: _isSearching
                        ? SizedBox(
                            width: 20,
                            height: 20,
                            child: CircularProgressIndicator(strokeWidth: 2),
                          )
                        : const Icon(Icons.search),
                    suffixIcon: _fundCodeController.text.isNotEmpty
                        ? IconButton(
                            icon: const Icon(Icons.clear),
                            onPressed: () {
                              setState(() {
                                _fundCodeController.clear();
                                _hideSearchResults();
                              });
                            },
                          )
                        : null,
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: _showSearchResults ? Colors.blue.withOpacity(0.05) : Colors.grey[50],
                    enabledBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(
                        color: _showSearchResults
                            ? Theme.of(context).primaryColor.withOpacity(0.5)
                            : Colors.grey.withOpacity(0.3),
                        width: _showSearchResults ? 2 : 1,
                      ),
                    ),
                    focusedBorder: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                      borderSide: BorderSide(
                        color: Theme.of(context).primaryColor,
                        width: 2,
                      ),
                    ),
                  ),
                  onChanged: (value) {
                    // å®æ—¶æœç´¢
                    _searchFunds(value.trim());
                  },
                  onTap: () {
                    // å¦‚æœæœ‰å†…å®¹ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœ
                    if (_fundCodeController.text.trim().isNotEmpty) {
                      _searchFunds(_fundCodeController.text.trim());
                    }
                  },
                  validator: (value) {
                    if (value == null || value.trim().isEmpty) {
                      return 'è¯·è¾“å…¥åŸºé‡‘ä»£ç æˆ–åç§°';
                    }
                    // å¦‚æœæ˜¯çº¯æ•°å­—ï¼Œæ£€æŸ¥æ˜¯å¦ä¸º6ä½
                    if (RegExp(r'^\d+$').hasMatch(value.trim())) {
                      if (value.trim().length != 6) {
                        return 'åŸºé‡‘ä»£ç å¿…é¡»ä¸º6ä½æ•°å­—';
                      }
                    }
                    return null;
                  },
                ),
              ),
              const SizedBox(height: 8),

              // æœç´¢æç¤º
              if (_showSearchResults && _searchResults.isNotEmpty)
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                  decoration: BoxDecoration(
                    color: Theme.of(context).primaryColor.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.lightbulb_outline,
                           size: 16,
                           color: Theme.of(context).primaryColor),
                      SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          'æ‰¾åˆ° ${_searchResults.length} åªåŒ¹é…åŸºé‡‘ï¼Œç‚¹å‡»é€‰æ‹©',
                          style: TextStyle(
                            fontSize: 12,
                            color: Theme.of(context).primaryColor,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _fundNameController,
                decoration: InputDecoration(
                  labelText: 'åŸºé‡‘åç§° *',
                  hintText: 'ä¾‹å¦‚: åå¤æˆé•¿æ··åˆ',
                  prefixIcon: const Icon(Icons.description),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
                validator: (value) {
                  if (value == null || value.trim().isEmpty) {
                    return 'è¯·è¾“å…¥åŸºé‡‘åç§°';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _fundManagerController,
                decoration: InputDecoration(
                  labelText: 'åŸºé‡‘ç®¡ç†äºº',
                  hintText: 'ä¾‹å¦‚: åå¤åŸºé‡‘ç®¡ç†æœ‰é™å…¬å¸',
                  prefixIcon: const Icon(Icons.business),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _notesController,
                decoration: InputDecoration(
                  labelText: 'å¤‡æ³¨',
                  hintText: 'æ·»åŠ ä¸ªäººå¤‡æ³¨ä¿¡æ¯...',
                  prefixIcon: const Icon(Icons.note),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                  filled: true,
                  fillColor: Colors.grey[50],
                ),
                maxLines: 2,
              ),
              const SizedBox(height: 16),
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.blue.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: Colors.blue.withOpacity(0.3)),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Icon(Icons.info_outline, color: Colors.blue[700], size: 18),
                        const SizedBox(width: 8),
                        Text(
                          'ğŸ“¡ æ•°æ®æ¥æº',
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            color: Colors.blue[700],
                            fontSize: 14,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'ğŸŒ APIåœ°å€: http://154.44.25.92:8080\n'
                      'ğŸ“Š æ•°æ®ç±»å‹: åŸºé‡‘å‡€å€¼ã€æ¶¨è·Œå¹…ã€åŸºæœ¬ä¿¡æ¯\n'
                      'ğŸ”„ æ›´æ–°é¢‘ç‡: å®æ—¶åŒæ­¥',
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.blue[600],
                        height: 1.4,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(),
          child: const Text('å–æ¶ˆ'),
        ),
        ElevatedButton.icon(
          onPressed: _isLoading ? null : _handleSubmit,
          icon: _isLoading
            ? const SizedBox(
                width: 16,
                height: 16,
                child: CircularProgressIndicator(
                  strokeWidth: 2,
                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                ),
              )
            : const Icon(Icons.add),
          label: Text(_isLoading ? 'è·å–åŸºé‡‘ç±»å‹ä¸­...' : 'æ·»åŠ åŸºé‡‘'),
          style: ElevatedButton.styleFrom(
            backgroundColor: Theme.of(context).primaryColor,
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
          ),
        ),
      ],
    );
  }

  void _handleSubmit() async {
    if (_formKey.currentState!.validate()) {
      setState(() {
        _isLoading = true;
      });

      try {
        final fundCode = _fundCodeController.text.trim().toUpperCase();
        final fundName = _fundNameController.text.trim();
        final fundManager = _fundManagerController.text.trim().isEmpty
            ? 'æœªçŸ¥'
            : _fundManagerController.text.trim();
        final notes = _notesController.text.trim().isEmpty
            ? 'æ•°æ®æ¥æº: http://154.44.25.92:8080'
            : _notesController.text.trim();

        // åŠ¨æ€è·å–åŸºé‡‘ç±»å‹
        final fundType = await _getFundType(fundCode);

        final favorite = FundFavorite(
          fundCode: fundCode,
          fundName: fundName, // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åç§°
          fundType: fundType, // ä½¿ç”¨APIè·å–çš„çœŸå®ç±»å‹
          fundManager: fundManager, // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç®¡ç†äººæˆ–é»˜è®¤å€¼
          addedAt: DateTime.now(),
          updatedAt: DateTime.now(),
          notes: notes, // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„å¤‡æ³¨æˆ–é»˜è®¤å€¼
        );

        widget.onAdd(favorite);
        Navigator.of(context).pop();

        // æ˜¾ç¤ºæˆåŠŸæç¤º
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.check_circle, color: Colors.white),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    'âœ… æˆåŠŸæ·»åŠ : $fundCode - $fundName ($fundType)',
                    style: const TextStyle(fontSize: 14),
                  ),
                ),
              ],
            ),
            backgroundColor: Colors.green,
            duration: const Duration(seconds: 2),
            action: SnackBarAction(
              label: 'æŸ¥çœ‹',
              textColor: Colors.white,
              onPressed: () {
                // å¯ä»¥æ·»åŠ å¯¼èˆªåˆ°è¯¦æƒ…é¡µçš„é€»è¾‘
              },
            ),
          ),
        );
      } catch (e) {
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Row(
              children: [
                const Icon(Icons.error, color: Colors.white),
                const SizedBox(width: 8),
                Expanded(
                  child: Text('âŒ æ·»åŠ å¤±è´¥: $e'),
                ),
              ],
            ),
            backgroundColor: Colors.red,
            duration: const Duration(seconds: 4),
          ),
        );
      } finally {
        if (mounted) {
          setState(() {
            _isLoading = false;
          });
        }
      }
    }
  }
}

/// ç¼–è¾‘è‡ªé€‰åŸºé‡‘å¯¹è¯æ¡†
class _EditFavoriteDialog extends StatefulWidget {
  final FundFavorite favorite;
  final Function(FundFavorite) onUpdate;

  const _EditFavoriteDialog({
    required this.favorite,
    required this.onUpdate,
  });

  @override
  State<_EditFavoriteDialog> createState() => _EditFavoriteDialogState();
}

class _EditFavoriteDialogState extends State<_EditFavoriteDialog> {
  final _formKey = GlobalKey<FormState>();
  late final TextEditingController _fundNameController;
  late final TextEditingController _fundManagerController;
  late final TextEditingController _notesController;
  late String _selectedFundType;

  final List<String> _fundTypes = [
    'è‚¡ç¥¨å‹', 'å€ºåˆ¸å‹', 'æ··åˆå‹', 'è´§å¸å‹', 'æŒ‡æ•°å‹', 'QDII', 'FOF', 'æœªçŸ¥ç±»å‹'
  ];

  @override
  void initState() {
    super.initState();
    _fundNameController = TextEditingController(text: widget.favorite.fundName);
    _fundManagerController = TextEditingController(text: widget.favorite.fundManager);
    _notesController = TextEditingController(text: widget.favorite.notes ?? '');

    // åˆå§‹åŒ–é€‰æ‹©çš„åŸºé‡‘ç±»å‹ï¼Œç¡®ä¿å®ƒåœ¨é€‰é¡¹åˆ—è¡¨ä¸­
    _selectedFundType = _fundTypes.contains(widget.favorite.fundType)
        ? widget.favorite.fundType
        : 'æœªçŸ¥ç±»å‹';
  }

  @override
  void dispose() {
    _fundNameController.dispose();
    _fundManagerController.dispose();
    _notesController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('ç¼–è¾‘è‡ªé€‰åŸºé‡‘'),
      content: SizedBox(
        width: 400,
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(
                'åŸºé‡‘ä»£ç : ${widget.favorite.fundCode}',
                style: const TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
              const SizedBox(height: 16),
              TextFormField(
                controller: _fundNameController,
                decoration: const InputDecoration(
                  labelText: 'åŸºé‡‘åç§° *',
                ),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'è¯·è¾“å…¥åŸºé‡‘åç§°';
                  }
                  return null;
                },
              ),
              const SizedBox(height: 12),
              DropdownButtonFormField<String>(
                value: _selectedFundType,
                decoration: const InputDecoration(
                  labelText: 'åŸºé‡‘ç±»å‹ *',
                ),
                items: _fundTypes.map((type) {
                  return DropdownMenuItem(
                    value: type,
                    child: Text(type),
                  );
                }).toList(),
                onChanged: (value) {
                  if (value != null) {
                    setState(() {
                      _selectedFundType = value;
                    });
                  }
                },
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: _fundManagerController,
                decoration: const InputDecoration(
                  labelText: 'åŸºé‡‘ç®¡ç†äºº',
                ),
              ),
              const SizedBox(height: 12),
              TextFormField(
                controller: _notesController,
                decoration: const InputDecoration(
                  labelText: 'å¤‡æ³¨',
                ),
                maxLines: 2,
              ),
            ],
          ),
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(),
          child: const Text('å–æ¶ˆ'),
        ),
        ElevatedButton(
          onPressed: _handleSubmit,
          child: const Text('ä¿å­˜'),
        ),
      ],
    );
  }

  void _handleSubmit() {
    if (_formKey.currentState!.validate()) {
      final updatedFavorite = widget.favorite.copyWith(
        fundName: _fundNameController.text.trim(),
        fundType: _selectedFundType,
        fundManager: _fundManagerController.text.trim().isEmpty
            ? 'æœªçŸ¥'
            : _fundManagerController.text.trim(),
        notes: _notesController.text.trim().isEmpty
            ? null
            : _notesController.text.trim(),
        updatedAt: DateTime.now(),
      );

      widget.onUpdate(updatedFavorite);
      Navigator.of(context).pop();
    }
  }
}

/// æ’åºå¯¹è¯æ¡†
class _SortDialog extends StatefulWidget {
  final FundFavoriteSortType currentSortType;
  final FundFavoriteSortDirection currentSortDirection;
  final Function(FundFavoriteSortType, FundFavoriteSortDirection) onSort;

  const _SortDialog({
    required this.currentSortType,
    required this.currentSortDirection,
    required this.onSort,
  });

  @override
  State<_SortDialog> createState() => _SortDialogState();
}

class _SortDialogState extends State<_SortDialog> {
  late FundFavoriteSortType _selectedSortType;
  late FundFavoriteSortDirection _selectedDirection;

  @override
  void initState() {
    super.initState();
    _selectedSortType = widget.currentSortType;
    _selectedDirection = widget.currentSortDirection;
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('æ’åºæ–¹å¼'),
      content: SizedBox(
        width: 300,
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // æ’åºç±»å‹é€‰æ‹©
            const Text('æ’åºç±»å‹', style: TextStyle(fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            ...FundFavoriteSortType.values.map((type) {
              return RadioListTile<FundFavoriteSortType>(
                title: Text(_getSortTypeName(type)),
                value: type,
                groupValue: _selectedSortType,
                onChanged: (value) {
                  setState(() {
                    _selectedSortType = value!;
                  });
                },
                dense: true,
              );
            }),

            const Divider(),

            // æ’åºæ–¹å‘é€‰æ‹©
            const Text('æ’åºæ–¹å‘', style: TextStyle(fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            RadioListTile<FundFavoriteSortDirection>(
              title: const Text('å‡åº'),
              value: FundFavoriteSortDirection.ascending,
              groupValue: _selectedDirection,
              onChanged: (value) {
                setState(() {
                  _selectedDirection = value!;
                });
              },
              dense: true,
            ),
            RadioListTile<FundFavoriteSortDirection>(
              title: const Text('é™åº'),
              value: FundFavoriteSortDirection.descending,
              groupValue: _selectedDirection,
              onChanged: (value) {
                setState(() {
                  _selectedDirection = value!;
                });
              },
              dense: true,
            ),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(),
          child: const Text('å–æ¶ˆ'),
        ),
        ElevatedButton(
          onPressed: () {
            widget.onSort(_selectedSortType, _selectedDirection);
            Navigator.of(context).pop();
          },
          child: const Text('ç¡®å®š'),
        ),
      ],
    );
  }

  String _getSortTypeName(FundFavoriteSortType sortType) {
    switch (sortType) {
      case FundFavoriteSortType.addTime:
        return 'æ·»åŠ æ—¶é—´';
      case FundFavoriteSortType.fundCode:
        return 'åŸºé‡‘ä»£ç ';
      case FundFavoriteSortType.fundName:
        return 'åŸºé‡‘åç§°';
      case FundFavoriteSortType.currentNav:
        return 'å½“å‰å‡€å€¼';
      case FundFavoriteSortType.dailyChange:
        return 'æ—¥æ¶¨è·Œå¹…';
      case FundFavoriteSortType.fundScale:
        return 'åŸºé‡‘è§„æ¨¡';
      case FundFavoriteSortType.custom:
        return 'è‡ªå®šä¹‰æ’åº';
    }
  }
}

/// æ·»åŠ åˆ°æŒä»“å¯¹è¯æ¡†
class _AddToPortfolioDialog extends StatefulWidget {
  final FundFavorite favorite;
  final Function(PortfolioHolding) onConfirm;

  const _AddToPortfolioDialog({
    required this.favorite,
    required this.onConfirm,
  });

  @override
  State<_AddToPortfolioDialog> createState() => _AddToPortfolioDialogState();
}

class _AddToPortfolioDialogState extends State<_AddToPortfolioDialog> {
  final _formKey = GlobalKey<FormState>();
  late final TextEditingController _amountController;
  late final TextEditingController _costNavController;
  late final TextEditingController _costValueController;

  double _suggestedAmount = 1000.0;
  bool _useSuggestedAmount = true;

  @override
  void initState() {
    super.initState();
    _amountController = TextEditingController();
    _costNavController = TextEditingController();
    _costValueController = TextEditingController();

    // è®¡ç®—å»ºè®®çš„æŒæœ‰ä»½é¢
    _calculateSuggestedAmount();

    // å¦‚æœä½¿ç”¨å½“å‰å‡€å€¼ä½œä¸ºæˆæœ¬
    if (widget.favorite.currentNav != null) {
      _costNavController.text = widget.favorite.currentNav!.toStringAsFixed(4);
      _updateCostValue();
    }
  }

  @override
  void dispose() {
    _amountController.dispose();
    _costNavController.dispose();
    _costValueController.dispose();
    super.dispose();
  }

  void _calculateSuggestedAmount() {
    // ç®€åŒ–çš„å»ºè®®ä»½é¢è®¡ç®—é€»è¾‘
    // è¿™é‡Œå¯ä»¥æ ¹æ®åŸºé‡‘ç±»å‹ç»™å‡ºä¸åŒçš„å»ºè®®
    _suggestedAmount = 1000.0; // é»˜è®¤1000ä»½

    if (_useSuggestedAmount) {
      _amountController.text = _suggestedAmount.toStringAsFixed(0);
    }
  }

  void _updateCostValue() {
    final amount = double.tryParse(_amountController.text) ?? 0;
    final costNav = double.tryParse(_costNavController.text) ?? 0;
    final costValue = amount * costNav;
    _costValueController.text = costValue.toStringAsFixed(2);
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: const Text('æ·»åŠ åˆ°æŒä»“'),
      content: SizedBox(
        width: 450,
        child: Form(
          key: _formKey,
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // åŸºé‡‘ä¿¡æ¯æ˜¾ç¤º
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.blue.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'åŸºé‡‘ä¿¡æ¯',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                        color: Colors.blue,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Row(
                      children: [
                        Text('ä»£ç : ${widget.favorite.fundCode}'),
                        const SizedBox(width: 16),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.blue.withOpacity(0.2),
                            borderRadius: BorderRadius.circular(4),
                          ),
                          child: Text(
                            widget.favorite.fundType,
                            style: const TextStyle(
                              color: Colors.blue,
                              fontSize: 12,
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 4),
                    Text('åç§°: ${widget.favorite.fundName}'),
                    if (widget.favorite.currentNav != null) ...[
                      const SizedBox(height: 4),
                      Text('å½“å‰å‡€å€¼: Â¥${widget.favorite.currentNav!.toStringAsFixed(4)}'),
                    ],
                  ],
                ),
              ),
              const SizedBox(height: 20),

              // æŒä»“ä¿¡æ¯è¾“å…¥
              const Text(
                'æŒä»“ä¿¡æ¯',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                ),
              ),
              const SizedBox(height: 12),

              Row(
                children: [
                  Expanded(
                    child: TextFormField(
                      controller: _amountController,
                      decoration: const InputDecoration(
                        labelText: 'æŒæœ‰ä»½é¢',
                        hintText: 'è¯·è¾“å…¥æŒæœ‰ä»½é¢',
                        suffixText: 'ä»½',
                        border: OutlineInputBorder(),
                      ),
                      keyboardType: TextInputType.number,
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'è¯·è¾“å…¥æŒæœ‰ä»½é¢';
                        }
                        final amount = double.tryParse(value);
                        if (amount == null || amount <= 0) {
                          return 'è¯·è¾“å…¥æœ‰æ•ˆçš„ä»½é¢æ•°é‡';
                        }
                        return null;
                      },
                      onChanged: (_) => _updateCostValue(),
                    ),
                  ),
                  const SizedBox(width: 12),
                  IconButton(
                    onPressed: () {
                      setState(() {
                        _useSuggestedAmount = true;
                        _calculateSuggestedAmount();
                        _updateCostValue();
                      });
                    },
                    tooltip: 'ä½¿ç”¨å»ºè®®ä»½é¢',
                    icon: const Icon(Icons.lightbulb_outline, color: Colors.orange),
                  ),
                ],
              ),
              SizedBox(height: 12),

              Row(
                children: [
                  Expanded(
                    child: TextFormField(
                      controller: _costNavController,
                      decoration: InputDecoration(
                        labelText: 'æˆæœ¬å‡€å€¼',
                        hintText: 'è¯·è¾“å…¥æˆæœ¬å‡€å€¼',
                        suffixText: 'å…ƒ',
                        border: OutlineInputBorder(),
                      ),
                      keyboardType: TextInputType.number,
                      validator: (value) {
                        if (value == null || value.isEmpty) {
                          return 'è¯·è¾“å…¥æˆæœ¬å‡€å€¼';
                        }
                        final costNav = double.tryParse(value);
                        if (costNav == null || costNav <= 0) {
                          return 'è¯·è¾“å…¥æœ‰æ•ˆçš„æˆæœ¬å‡€å€¼';
                        }
                        return null;
                      },
                      onChanged: (_) => _updateCostValue(),
                    ),
                  ),
                  SizedBox(width: 12),
                  if (widget.favorite.currentNav != null)
                    TextButton(
                      onPressed: () {
                        _costNavController.text = widget.favorite.currentNav!.toStringAsFixed(4);
                        _updateCostValue();
                      },
                      child: Text('ä½¿ç”¨å½“å‰å‡€å€¼'),
                    ),
                ],
              ),
              const SizedBox(height: 12),

              TextFormField(
                controller: _costValueController,
                decoration: const InputDecoration(
                  labelText: 'æˆæœ¬é‡‘é¢',
                  hintText: 'è‡ªåŠ¨è®¡ç®—',
                  suffixText: 'å…ƒ',
                  border: OutlineInputBorder(),
                  filled: true,
                  fillColor: Color(0xFFF5F5F5),
                ),
                keyboardType: TextInputType.number,
                readOnly: true,
                style: const TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.blue,
                ),
              ),
              const SizedBox(height: 12),

              // æŠ•èµ„å»ºè®®
              if (_suggestedAmount > 0) ...[
                Container(
                  padding: EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.orange.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(6),
                    border: Border.all(color: Colors.orange.withOpacity(0.3)),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.lightbulb, size: 16, color: Colors.orange[700]),
                      SizedBox(width: 8),
                      Expanded(
                        child: Text(
                          'å»ºè®®æŒæœ‰ ${_suggestedAmount.toStringAsFixed(0)} ä»½',
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.orange[700],
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ],
          ),
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.of(context).pop(),
          child: Text('å–æ¶ˆ'),
        ),
        ElevatedButton(
          onPressed: _handleSubmit,
          style: ElevatedButton.styleFrom(
            backgroundColor: Colors.blue,
            foregroundColor: Colors.white,
          ),
          child: Text('ç¡®è®¤æ·»åŠ '),
        ),
      ],
    );
  }

  void _handleSubmit() {
    if (_formKey.currentState!.validate()) {
      final amount = double.parse(_amountController.text);
      final costNav = double.parse(_costNavController.text);
      final costValue = double.parse(_costValueController.text);
      final now = DateTime.now();

      final holding = PortfolioHolding(
        fundCode: widget.favorite.fundCode,
        fundName: widget.favorite.fundName,
        fundType: widget.favorite.fundType,
        holdingAmount: amount,
        costNav: costNav,
        costValue: costValue,
        marketValue: amount * (widget.favorite.currentNav ?? costNav),
        currentNav: widget.favorite.currentNav ?? costNav,
        accumulatedNav: widget.favorite.currentNav ?? costNav,
        holdingStartDate: now,
        lastUpdatedDate: now,
        dividendReinvestment: false,
        status: HoldingStatus.active,
      );

      widget.onConfirm(holding);
      Navigator.of(context).pop();
    }
  }
}
