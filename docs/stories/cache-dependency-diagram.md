# 缓存管理器依赖关系图

## 📊 整体架构依赖图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Application Layer                        │
├─────────────────────────────────────────────────────────────────┤
│  FundExplorationCubit  │  FundComparisonCubit  │  AuthBloc      │
│  PortfolioAnalysisCubit │  FundFavoriteCubit   │  CacheBloc     │
└─────────────────┬───────────────────────┬─────────────────────┘
                  │                       │
┌─────────────────▼───────────────────────▼─────────────────────┐
│                     Service Layer                              │
├───────────────────────────────────────────────────────────────┤
│ FundDataService │ SearchService │ MarketService │ DataValService│
│ SmartPreloading │ SearchPerfOpt │ FundComparison │ MoneyFund   │
└─────────────────┬───────────────────────┬─────────────────────┘
                  │                       │
┌─────────────────▼───────────────────────▼─────────────────────┐
│                    Cache Layer                                 │
├───────────────────────────────────────────────────────────────┤
│  HiveCacheManager   │ EnhancedHiveCacheManager                │
│  OptimizedCacheV3   │ IntelligentCacheManager                  │
│  MarketCacheManager │ SmartCacheManager                        │
│  UnifiedHiveCache   │ OptimizedCacheManager                    │
└─────────────────┬───────────────────────┬─────────────────────┘
                  │                       │
┌─────────────────▼───────────────────────▼─────────────────────┐
│                Storage Layer                                   │
├───────────────────────────────────────────────────────────────┤
│                    Hive Database                               │
│  fund_cache      │ fund_cache_enhanced                        │
│  optimized_data  │ funds_v3                                   │
│  market_cache    │ smart_fund_cache                           │
│  unified_cache   │ intelligent_cache                          │
└───────────────────────────────────────────────────────────────┘
```

## 🔄 依赖注入容器关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                Main DI Container (GetIt)                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ HiveCacheManager│  │EnhancedHiveCM   │  │OptimizedCacheV3 │ │
│  │   (Singleton)   │  │   (Singleton)   │  │   (Singleton)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│           │                     │                     │        │
│           └─────────────────────┼─────────────────────┘        │
│                                 │                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ FundDataService │  │DataValidationSv │  │ ComparisonCache │ │
│  │   (Singleton)   │  │   (Singleton)   │  │    Cubit        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│              Hive DI Container (GetIt)                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ HiveCacheManager│  │ CacheRepository │  │   FundService   │ │
│  │   (Singleton)   │  │   (Singleton)   │  │   (Singleton)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 📦 模块依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Fund Module                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    uses    ┌─────────────────┐            │
│  │ FundExploration  │────────────▶│ FundDataService  │            │
│  │      Cubit      │             └─────────┬───────┘            │
│  └─────────────────┘                       │                    │
│             │                               │                    │
│  uses        │          uses         ┌───────▼───────┐            │
│             ▼                       │OptimizedCacheV3│            │
│  ┌─────────────────┐               └─────────────────┘            │
│  │  SearchService  │                                                    │
│  └─────────────────┘                                                    │
│             │                                                            │
│  uses        │          uses         ┌─────────────────┐            │
│             ▼                       │IntelligentCache │            │
│  ┌─────────────────┐               │    Manager      │            │
│  │SmartPreloading  │               └─────────────────┘            │
│  │    Manager      │                                                    │
│  └─────────────────┘                                                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      Market Module                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    uses    ┌─────────────────┐            │
│  │ MarketService   │────────────▶│MarketCacheMgr   │            │
│  └─────────────────┘             └─────────────────┘            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Portfolio Module                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    uses    ┌─────────────────┐            │
│  │PortfolioAnalysis│────────────▶│HiveCacheManager │            │
│  │     Cubit       │             └─────────────────┘            │
│  └─────────────────┘                                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 🗂️ 数据存储依赖图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Cache Data Flow                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Application Layer                                               │
│  ┌─────────────┐    put/get    ┌─────────────────────────────────┐ │
│  │    UI       │──────────────▶│        Cache Managers           │ │
│  │ Components  │◀──────────────┤                                 │ │
│  └─────────────┘               │  ┌─────────┐ ┌───────────────┐ │ │
│                                │  │   L1    │ │     L2        │ │ │
│                                │  │ Memory  │ │   Hive Disk  │ │ │
│                                │  │ Cache   │ │   Storage     │ │ │
│                                │  └─────────┘ └───────────────┘ │ │
│                                └─────────────────────────────────┘ │
│                                          │                        │
│                                          │ read/write             │
│                                          ▼                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Hive Database                             │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │ │
│  │  │fund_cache*  │ │funds_v3     │ │unified_fund_cache    │   │ │
│  │  │(Primary)    │ │(Optimized)  │ │(Target)              │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘   │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │ │
│  │  │market_cache │ │smart_cache  │ │intelligent_cache    │   │ │
│  │  │(Market)     │ │(Smart)      │ │(Intelligent)         │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## ⚠️ 依赖问题标记图

```
┌─────────────────────────────────────────────────────────────────┐
│                  Dependency Issues                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🚨 CRITICAL ISSUES:                                           │
│                                                                 │
│  ┌─────────────────┐    duplicate    ┌─────────────────┐        │
│  │Main DI Container│◀───────────────▶│Hive DI Container│        │
│  │                 │    registration   │                 │        │
│  │HiveCacheManager │──────────────────▶│HiveCacheManager │        │
│  └─────────────────┘                   └─────────────────┘        │
│         ⚠️ Different instances may cause inconsistency          │
│                                                                 │
│  🔄 CIRCULAR DEPENDENCY RISK:                                   │
│                                                                 │
│  ┌─────────────────┐    depends on    ┌─────────────────┐        │
│  │  FundDataService │──────────────────▶│DataValidationSv │        │
│  └─────────────────┘                  └─────────┬───────┘        │
│          ▲                                        │             │
│          │                                        │ uses        │
│          │              provides data             ▼             │
│  ┌─────────────────┐    cache from    ┌─────────────────┐        │
│  │ CacheRepository │◀─────────────────┤HiveCacheManager │        │
│  └─────────────────┘                  └─────────────────┘        │
│                                                                 │
│  ⏱️ INITIALIZATION RACE CONDITIONS:                             │
│                                                                 │
│  Multiple Cache Managers initializing asynchronously              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │
│  │HiveCacheMgr │ │EnhancedHive │ │OptimizedV3  │ │Intelligent│ │
│  │ .initialize()│ │.initialize() │ │.initialize() │ │.initialize()│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │
│          │             │             │             │           │
│          └─────────────┼─────────────┼─────────────┘           │
│                        ▼             ▼                         │
│                ┌─────────────────────────────┐                   │
│                │   Potential Resource        │                   │
│                │   Competition & Conflicts   │                   │
│                └─────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 统一迁移目标架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                  Target Architecture                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Application Layer                                               │
│  ┌─────────────────┐    uses    ┌─────────────────────────────────┐ │
│  │    UI/BLoC      │────────────▶│        Services                │ │
│  │   Components    │◀────────────┤                                 │ │
│  └─────────────────┘             │  ┌─────────────────────────────┐ │ │
│                                  │  │     Unified Cache Service   │ │ │
│                                  │  │  (UnifiedHiveCacheManager)  │ │ │
│                                  │  └─────────────┬───────────────┘ │ │
│                                  │                │               │ │
│                                  │                │               │ │
│                                  │          ┌─────▼──────┐          │ │
│                                  │          │   DI       │          │ │
│                                  │          │Container   │          │ │
│                                  │          └─────┬──────┘          │ │
│                                          │               │         │
│                                          ▼               ▼         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │               Unified Cache Layer                           │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │ │
│  │  │   L1 Cache  │ │   L2 Cache  │ │      Search Index       │ │ │
│  │  │   (Memory)  │ │   (Disk)    │ │     (Memory + Disk)     │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────────┘ │ │
│  │                                                             │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │           Performance Monitoring                        │ │ │
│  │  │  - Hit Rates, Response Times, Memory Usage            │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                          │                       │
│                                          ▼                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   Unified Storage                            │ │
│  │                                                             │ │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │ │
│  │  │unified_fund_cache│ │unified_metadata │ │unified_index    │ │ │
│  │  │   (Main Data)   │ │   (Metadata)    │ │  (Search Data)  │ │ │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 迁移路径图

```
┌─────────────────────────────────────────────────────────────────┐
│                     Migration Path                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1: Analysis & Planning (Week 1)                          │
│  ┌─────────────────┐                                           │
│  │  Current State  │                                           │
│  │ 7 Cache Managers│                                           │
│  └─────────┬───────┘                                           │
│            │                                                   │
│            ▼                                                   │
│  ┌─────────────────┐    analyze    ┌─────────────────┐          │
│  │ Dependency Map  │───────────────▶│ Impact Analysis │          │
│  └─────────┬───────┘               └─────────┬───────┘          │
│            │                                 │                 │
│            ▼                                 ▼                 │
│  ┌─────────────────┐    design     ┌─────────────────┐          │
│  │ Risk Assessment│────────────────▶│Migration Plan   │          │
│  └─────────────────┘               └─────────────────┘          │
│                                                                 │
│  Phase 2: Unified Cache Development (Week 2-3)                   │
│  ┌─────────────────┐    enhance    ┌─────────────────┐          │
│  │UnifiedHiveCache │───────────────▶|Feature Complete │          │
│  │    Manager      │               └─────────┬───────┘          │
│  └─────────┬───────┘                         │                 │
│            │                                 │                 │
│            ▼                                 ▼                 │
│  ┌─────────────────┐    test      ┌─────────────────┐          │
│  │Migration Scripts│───────────────▶|Validation Tests │          │
│  └─────────────────┘               └─────────────────┘          │
│                                                                 │
│  Phase 3: Gradual Migration (Week 4-5)                           │
│  ┌─────────────────┐    migrate    ┌─────────────────┐          │
│  │Low Risk Modules │───────────────▶│Medium Risk     │          │
│  │  (Market, etc)  │               │   Modules       │          │
│  └─────────┬───────┘               └─────────┬───────┘          │
│            │                                 │                 │
│            ▼                                 ▼                 │
│  ┌─────────────────┐    migrate    ┌─────────────────┐          │
│  │High Risk Modules│───────────────▶|   Complete      │          │
│  │ (Fund, Portfolio)│              │   Migration     │          │
│  └─────────────────┘               └─────────────────┘          │
│                                                                 │
│  Phase 4: Cleanup & Monitoring (Week 6)                          │
│  ┌─────────────────┐    remove     ┌─────────────────┐          │
│  │  Old Managers   │───────────────▶|Legacy Code     │          │
│  └─────────┬───────┘               └─────────┬───────┘          │
│            │                                 │                 │
│            ▼                                 ▼                 │
│  ┌─────────────────┐    monitor    ┌─────────────────┐          │
│  │Performance Opt  │───────────────▶|   Success      │          │
│  └─────────────────┘               └─────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

**图表说明：**
- 🚨 表示关键问题需要立即解决
- 🔄 表示潜在风险需要关注
- ⏱️ 表示时序相关的问题
- 箭头方向表示依赖关系或数据流向
- 方框大小表示相对重要性或复杂度

**建议优先级：**
1. **HIGH** - 解决重复注册问题
2. **MEDIUM** - 防止循环依赖
3. **LOW** - 优化初始化顺序