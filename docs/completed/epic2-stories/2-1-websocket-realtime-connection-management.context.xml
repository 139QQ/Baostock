<?xml version="1.0" encoding="UTF-8"?>
<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>WebSocket实时数据连接管理</title>
    <status>drafted</status>
    <generatedAt>2025-11-07</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-1-websocket-realtime-connection-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>专业投资者</asA>
    <iWant>稳定的实时数据连接</iWant>
    <soThat>我能够获得及时的市场数据和基金净值更新</soThat>
    <tasks>### 核心连接管理
- [ ] **Task 1**: 实现WebSocket连接管理器 (AC: 1, 5, 6)
  - [ ] Subtask 1.1: 创建WebSocketManager类，封装连接逻辑
  - [ ] Subtask 1.2: 实现指数退避重连算法
  - [ ] Subtask 1.3: 添加连接参数配置支持(重连间隔、超时时间)
  - [ ] Subtask 1.4: 实现心跳机制，定期发送ping/pong消息

### 连接状态监控
- [ ] **Task 2**: 实现连接状态监控系统 (AC: 2, 7)
  - [ ] Subtask 2.1: 创建ConnectionStatusCubit管理连接状态
  - [ ] Subtask 2.2: 实现连接状态可视化指示器组件
  - [ ] Subtask 2.3: 添加连接质量监控(延迟、丢包率等)
  - [ ] Subtask 2.4: 实现连接性能指标收集和展示

### 降级机制
- [ ] **Task 3**: 实现HTTP轮询降级机制 (AC: 3, 4)
  - [ ] Subtask 3.1: 创建HTTP轮询服务作为WebSocket的降级方案
  - [ ] Subtask 3.2: 实现网络状态检测和自动切换逻辑
  - [ ] Subtask 3.3: 添加断线期间数据缓存和恢复机制
  - [ ] Subtask 3.4: 实现数据同步的一致性保证

### 状态管理集成
- [ ] **Task 4**: 集成到现有状态管理系统 (IV: 4)
  - [ ] Subtask 4.1: 扩展RealtimeDataCubit支持WebSocket连接状态
  - [ ] Subtask 4.2: 实现连接状态与全局状态管理器的同步
  - [ ] Subtask 4.3: 添加实时数据状态变化的UI响应机制

### 网络层集成
- [ ] **Task 5**: 与现有Dio网络层集成 (IV: 1, 3)
  - [ ] Subtask 5.1: 确保WebSocket连接不与现有HTTP API冲突
  - [ ] Subtask 5.2: 实现WebSocket断开时的HTTP API降级保证
  - [ ] Subtask 5.3: 添加网络层统一的错误处理机制

### 缓存系统集成
- [ ] **Task 6**: 集成到现有Hive缓存系统 (IV: 2)
  - [ ] Subtask 6.1: 实现实时数据到Hive缓存的存储逻辑
  - [ ] Subtask 6.2: 确保实时数据与缓存数据的一致性
  - [ ] Subtask 6.3: 实现缓存数据的实时更新策略

### 测试和质量保证
- [ ] **Task 7**: 实现完整的测试覆盖
  - [ ] Subtask 7.1: 编写WebSocket连接管理的单元测试
  - [ ] Subtask 7.2: 创建连接状态监控的集成测试
  - [ ] Subtask 7.3: 实现降级机制的端到端测试
  - [ ] Subtask 7.4: 添加网络异常场景的压力测试</tasks>
  </story>

  <acceptanceCriteria>1. **AC1**: 建立稳定的WebSocket连接，支持自动重连机制
2. **AC2**: 实现连接状态的实时监控和可视化指示
3. **AC3**: 网络中断时自动降级到HTTP轮询模式
4. **AC4**: 连接恢复后自动同步断线期间的数据
5. **AC5**: 支持连接参数配置(重连间隔、超时时间等)
6. **AC6**: 实现连接心跳机制，确保连接活跃状态
7. **AC7**: 提供连接质量监控和性能指标

### Integration Verification

- **IV1**: 与现有Dio网络层无缝集成，不冲突现有API调用
- **IV2**: 实时数据缓存到现有Hive系统，保持数据一致性
- **IV3**: WebSocket断开时，现有HTTP API功能正常工作
- **IV4**: 连接状态与全局状态管理器同步</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd/epic-2-realtime-market-data.md" title="Epic 2 PRD文档" section="Story 2.1定义" snippet="Story 2.1: WebSocket实时数据连接管理 - 建立稳定的WebSocket连接，支持自动重连机制"/>
      <doc path="docs/epics/epic-2-quasi-realtime-market-data-system.md" title="Epic 2 技术规范" section="架构不一致性问题" snippet="范围外: WebSocket连接和推送功能(技术架构不支持)"/>
      <doc path="docs/architecture.md" title="架构决策文档" section="实时数据架构" snippet="实时数据架构: 混合同步策略 (WebSocket + HTTP轮询) web_socket_channel 2.4.0"/>
    </docs>
    <code>
      <artifact path="lib/src/core/network/fund_api_client.dart" kind="service" symbol="FundApiClient" lines="1-100" reason="现有网络层基础，基于Dio的HTTP客户端"/>
      <artifact path="lib/src/core/state/global_cubit_manager.dart" kind="state" symbol="GlobalCubitManager" lines="1-50" reason="全局状态管理，需要集成实时连接状态"/>
      <artifact path="lib/src/features/market/data/services/sector_realtime_service.dart" kind="service" symbol="SectorRealtimeService" lines="1-50" reason="现有实时数据服务参考，基于HTTP轮询"/>
      <artifact path="lib/src/core/network/" kind="directory" symbol="NetworkModule" reason="网络层架构，需要集成WebSocket管理"/>
    </code>
    <dependencies>
      <dart ecosystem="flutter" packages="dio:5.3.0,flutter_bloc:9.1.1,hive:2.2.3,connectivity_plus:5.0.1"/>
      <dart ecosystem="missing" packages="web_socket_channel:2.4.0 - 需要添加到pubspec.yaml"/>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architectural" priority="critical">
      必须与现有Dio网络层完全兼容，不冲突现有HTTP API调用
    </constraint>
    <constraint type="architectural" priority="critical">
      实时数据缓存到现有Hive三级缓存系统，保持数据一致性
    </constraint>
    <constraint type="technical" priority="high">
      支持Windows桌面端优先的跨平台架构
    </constraint>
    <constraint type="performance" priority="high">
      连接重连延迟控制(最长不超过30秒)，内存使用控制(实时数据缓存不应超过50MB)
    </constraint>
    <constraint type="critical" priority="blocking">
      架构不一致性警告: Story要求WebSocket，但Epic规范明确为HTTP轮询且不支持WebSocket
    </constraint>
  </constraints>
  <interfaces>
    <interface name="WebSocket连接管理" kind="class" signature="class WebSocketManager { Future&lt;void&gt; connect(); Stream&lt;WebSocketMessage&gt; get messageStream; }" path="lib/src/core/network/realtime/websocket_manager.dart"/>
    <interface name="连接状态监控" kind="cubit" signature="class ConnectionStatusCubit extends Cubit&lt;ConnectionState&gt;" path="lib/src/core/state/realtime_connection_cubit.dart"/>
    <interface name="降级HTTP服务" kind="class" signature="class FallbackHttpService { Future&lt;List&lt;FundData&gt;&gt; pollData(); }" path="lib/src/core/network/realtime/fallback_http_service.dart"/>
  </interfaces>
  <tests>
    <standards>基于flutter_test + mockito框架，单元测试覆盖率≥90%，集成测试覆盖WebSocket连接故障恢复场景</standards>
    <locations>test/unit/core/network/realtime/, test/integration/realtime_data_test.dart</locations>
    <ideas>
      <test idea="WebSocket连接管理器单元测试" ac="AC1,AC5,AC6"/>
      <test idea="连接状态监控集成测试" ac="AC2,AC7"/>
      <test idea="HTTP轮询降级机制端到端测试" ac="AC3,AC4"/>
      <test idea="网络异常场景压力测试" ac="AC1,AC3,AC6"/>
    </ideas>
  </tests>
</story-context>