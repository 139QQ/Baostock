<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>准实时基金净值数据处理</title>
    <status>drafted</status>
    <generatedAt>2025-11-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-2-quasi-realtime-fund-nav-processing.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>专业投资者</asA>
    <iWant>基金净值数据能够准实时更新并提供智能变化提示</iWant>
    <soThat>我能够及时掌握基金表现动态，做出更准确的投资决策，同时通过视觉变化获得更好的用户体验</soThat>
    <tasks>### 基金净值数据处理核心
- [ ] **Task 1**: 实现基金净值准实时数据管理器 (AC: 1, 2, 3, 6)
  - [ ] Subtask 1.1: 创建FundNavDataManager，基于HybridDataManager扩展
  - [ ] Subtask 1.2: 实现批量基金净值轮询机制，支持50+基金并发
  - [ ] Subtask 1.3: 集成多源数据验证机制，确保数据准确性
  - [ ] Subtask 1.4: 实现L1/L2缓存策略，支持离线查看

### 数据变化检测和可视化
- [ ] **Task 2**: 实现净值变化检测和视觉提示系统 (AC: 4, 5)
  - [ ] Subtask 2.1: 创建NavChangeDetector，检测净值变化趋势
  - [ ] Subtask 2.2: 集成AdaptiveFundCard，支持净值变化动画
  - [ ] Subtask 2.3: 实现涨跌颜色提示和百分比显示
  - [ ] Subtask 2.4: 创建历史净值对比图表组件

### 状态管理和用户控制
- [ ] **Task 3**: 实现准实时数据状态管理 (AC: 7, IV4)
  - [ ] Subtask 3.1: 创建FundNavCubit，管理净值数据状态
  - [ ] Subtask 3.2: 集成GlobalCubitManager，统一状态管理
  - [ ] Subtask 3.3: 实现暂停/恢复控制功能
  - [ ] Subtask 3.4: 添加轮询状态可视化指示器

### 数据处理和缓存优化
- [ ] **Task 4**: 优化数据处理和缓存性能 (AC: 1, 3, IV2)
  - [ ] Subtask 4.1: 扩展UnifiedHiveCacheManager支持净值数据
  - [ ] Subtask 4.2: 实现数据压缩和批量处理优化
  - [ ] Subtask 4.3: 添加延迟监控和性能指标收集
  - [ ] Subtask 4.4: 实现智能缓存更新策略

### 测试和质量保证
- [ ] **Task 5**: 实现完整的测试覆盖
  - [ ] Subtask 5.1: 编写基金净值数据管理器单元测试
  - [ ] Subtask 5.2: 创建批量轮询的集成测试
  - [ ] Subtask 5.3: 实现延迟测试和性能基准测试
  - [ ] Subtask 5.4: 添加数据准确性验证测试</tasks>
  </story>

  <acceptanceCriteria>1. **AC1**: 基金净值数据准实时更新，延迟 < 60秒
   - 验证: 从API调用到UI展示延迟控制在60秒内
   - 测试方法: 端到端延迟测试

2. **AC2**: 支持多只基金的批量轮询获取
   - 验证: 同时轮询50+只基金数据
   - 测试方法: 批量轮询压力测试

3. **AC3**: 轮询数据的智能缓存和本地存储
   - 验证: 数据缓存到L1/L2缓存，支持离线查看
   - 测试方法: 缓存策略验证测试

4. **AC4**: 净值变化时的视觉提示和动画效果
   - 验证: 净值变化时显示涨跌颜色和动画
   - 测试方法: UI动画效果测试

5. **AC5**: 历史净值数据的准实时对比展示
   - 验证: 轮询数据与历史数据对比图表
   - 测试方法: 数据对比准确性测试

6. **AC6**: 轮询数据的准确性验证机制
   - 验证: 多源数据交叉验证确保准确性
   - 测试方法: 数据准确性验证测试

7. **AC7**: 支持轮询数据的暂停/恢复控制
   - 验证: 用户可暂停/恢复轮询数据更新
   - 测试方法: 暂停恢复功能测试

### Integration Verification

- **IV1**: 与现有HybridDataManager无缝集成，复用轮询基础设施
- **IV2**: 扩展现有Hive缓存系统支持基金净值准实时数据
- **IV3**: 与AdaptiveFundCard组件集成，支持净值变化动画
- **IV4**: 利用GlobalCubitManager管理准实时数据状态
- **IV5**: 兼容现有金融级数据验证机制</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epics/epic-2-quasi-realtime-market-data-system.md" title="准实时市场数据集成系统 Epic" section="Overview" snippet="Epic 2实现基速基金量化分析平台的准实时市场数据集成系统，基于HTTP轮询策略提供准实时性、权威性的专业投资决策支持。"/>
      <doc path="docs/epics/epic-2-quasi-realtime-market-data-system.md" title="详细设计" section="Services and Modules" snippet="PollingDataManager负责轮询数据统一管理，协调HTTP调度；MarketDataProcessor处理市场数据解析、验证和转换；DataChangePushService管理数据变化推送，优先级管理。"/>
      <doc path="docs/epics/epic-2-quasi-realtime-market-data-system.md" title="数据模型" section="Data Models and Contracts" snippet="PollingFundData包含基金代码、名称、当前净值、变化量、变化百分比、时间戳等字段，支持多数据源标识。"/>
      <doc path="docs/epics/epic-2-quasi-realtime-market-data-system.md" title="API接口" section="APIs and Interfaces" snippet="IPollingDataManager提供开始/停止轮询、订阅基金/指数、调整轮询频率等接口，返回数据流和状态流。"/>
      <doc path="docs/architecture.md" title="系统架构" section="混合数据获取架构" snippet="HybridDataManager通过DataType Router选择最优获取策略，支持WebSocket和HTTP轮询的混合数据获取模式。"/>
      <doc path="docs/architecture.md" title="缓存系统架构" section="缓存系统架构" snippet="L1内存缓存提供毫秒级访问，L2 Hive本地缓存提供快速持久化，L3远程API提供企业级数据，三级缓存确保数据可用性。"/>
      <doc path="docs/architecture.md" title="状态管理架构" section="状态管理架构" snippet="GlobalCubitManager统一管理各种状态Cubit，包括HybridDataStatusCubit用于混合数据状态管理。"/>
      <doc path="docs/architecture.md" title="实时数据架构" section="ADR-001: 混合数据获取架构选择" snippet="采用分层的混合数据获取策略，当前基于HTTP轮询，预留WebSocket扩展接口，根据数据类型和优先级选择最优获取方式。"/>
      <doc path="docs/stories/2-1-hybrid-data-connection-management.md" title="前序故事成果" section="Dev Agent Record" snippet="已实现HybridDataManager基础架构、PollingManager轮询管理器、HybridDataStatusCubit状态管理，为基金净值处理提供完整基础设施。"/>
      <doc path="docs/stories/2-1-hybrid-data-connection-management.md" title="架构扩展性" section="架构扩展性设计" snippet="可插拔的数据获取策略接口，支持HTTP轮询和未来WebSocket扩展，智能数据路由选择最优策略。"/>
    </docs>
    <code>
      <artifact path="lib/src/core/network/hybrid/hybrid_data_manager.dart" kind="service" symbol="HybridDataManager" lines="16-50" reason="混合数据管理器，支持多种数据获取策略协调，为基金净值数据提供统一管理接口"/>
      <artifact path="lib/src/core/network/polling/polling_manager.dart" kind="service" symbol="PollingManager" lines="10-50" reason="轮询管理器，提供HTTP轮询任务配置、执行和监控，为基金净值准实时更新提供基础设施"/>
      <artifact path="lib/src/core/state/hybrid_data_status_cubit.dart" kind="state" symbol="HybridDataStatusCubit" lines="10-50" reason="混合数据状态管理，提供连接状态监控和数据流管理，确保净值数据状态同步"/>
      <artifact path="lib/src/features/fund/presentation/fund_exploration/presentation/widgets/adaptive_fund_card.dart" kind="widget" symbol="AdaptiveFundCard" lines="1-50" reason="自适应基金卡片，支持三级动画系统，可扩展显示净值变化动画和视觉提示"/>
      <artifact path="lib/src/core/state/global_cubit_manager.dart" kind="state" symbol="GlobalCubitManager" reason="全局状态管理器，统一管理应用状态，支持净值数据状态的集成"/>
    </code>
    <dependencies>
      <ecosystem name="flutter">
        <package name="flutter_bloc" version="^9.1.1" usage="状态管理，净值数据Cubit"/>
        <package name="dio" version="^5.3.0" usage="HTTP轮询请求，基金净值API调用"/>
        <package name="hive" version="^2.2.3" usage="L2本地缓存，净值数据持久化"/>
        <package name="web_socket_channel" version="^2.4.0" usage="未来WebSocket扩展预留"/>
        <package name="fl_chart" version="^0.55.2" usage="净值变化图表展示"/>
        <package name="flutter_animate" version="^4.1.0" usage="净值变化动画效果"/>
        <package name="decimal" version="^2.3.3" usage="高精度净值计算"/>
        <package name="connectivity_plus" version="^5.0.1" usage="网络状态监控"/>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>必须与现有Dio网络层完全兼容，不能影响现有HTTP API功能</constraint>
    <constraint>需要保持与三级缓存系统(L1内存+L2 Hive+L3 API)的数据一致性</constraint>
    <constraint>必须支持Windows桌面应用的性能要求，内存使用增量&lt;20MB</constraint>
    <constraint>遵循Clean Architecture原则，数据层与表现层分离</constraint>
    <constraint>复用现有轮询基础设施：PollingManager、NetworkMonitor</constraint>
    <constraint>集成现有AdaptiveFundCard组件，扩展净值变化动画</constraint>
    <constraint>保持与现有BLoC状态管理的一致性</constraint>
    <constraint>金融级数据验证要求，确保数据准确性99.9%以上</constraint>
  </constraints>
  <interfaces>
    <interface name="HybridDataManager" kind="service class" signature="class HybridDataManager { static HybridDataManager(); void _initialize(); Stream&lt;DataItem&gt; getMixedDataStream(DataType type); }" path="lib/src/core/network/hybrid/hybrid_data_manager.dart"/>
    <interface name="PollingManager" kind="service class" signature="class PollingManager { void addTask(PollingTask task); void removeTask(String taskId); void startPolling(String taskId); void stopPolling(String taskId); }" path="lib/src/core/network/polling/polling_manager.dart"/>
    <interface name="HybridDataStatusCubit" kind="BLoC state" signature="class HybridDataStatusCubit extends Cubit&lt;HybridDataStatusState&gt; { void updateConnectionStatus(DataType type, HybridConnectionState state); Stream&lt;HybridDataStatusState&gt; get statusStream; }" path="lib/src/core/state/hybrid_data_status_cubit.dart"/>
    <interface name="AdaptiveFundCard" kind="widget component" signature="class AdaptiveFundCard extends StatefulWidget { const AdaptiveFundCard({required FundData fund, super.key}); Widget build(BuildContext context); }" path="lib/src/features/fund/presentation/fund_exploration/presentation/widgets/adaptive_fund_card.dart"/>
  </interfaces>
  <tests>
    <standards>使用flutter_test + mockito框架，单元测试覆盖率目标≥90%，集成测试覆盖数据流和状态管理，性能测试验证延迟要求，基于现有项目测试模式</standards>
    <locations>test/unit/features/fund/data/（单元测试）, test/integration/（集成测试）, test/performance/（性能测试）</locations>
    <ideas>
      <idea acceptanceCriteria="AC1" description="端到端延迟测试 - 验证API调用到UI展示延迟&lt;60秒"/>
      <idea acceptanceCriteria="AC2" description="批量轮询压力测试 - 验证同时轮询50+基金数据的性能"/>
      <idea acceptanceCriteria="AC3" description="缓存策略验证测试 - 验证L1/L2缓存数据和离线查看功能"/>
      <idea acceptanceCriteria="AC4" description="UI动画效果测试 - 验证净值变化时的涨跌颜色和动画"/>
      <idea acceptanceCriteria="AC5" description="数据对比准确性测试 - 验证轮询数据与历史数据对比算法"/>
      <idea acceptanceCriteria="AC6" description="数据准确性验证测试 - 验证多源数据交叉验证机制"/>
      <idea acceptanceCriteria="AC7" description="暂停恢复功能测试 - 验证用户控制轮询数据更新的功能"/>
    </ideas>
  </tests>
</story-context>