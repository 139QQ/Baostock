<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>准实时市场指数集成</title>
    <status>drafted</status>
    <generatedAt>2025-11-09</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>D:\Git\Github\Baostock\docs\stories\2-3-quasi-realtime-market-index-integration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>专业投资者</asA>
    <iWant>市场指数数据能够准实时更新并提供智能变化分析</iWant>
    <soThat>我能够及时掌握市场整体动态，评估投资环境，做出更准确的市场时机判断</soThat>
    <tasks>### 市场指数数据处理核心
- [ ] **Task 1**: 实现市场指数准实时数据管理器 (AC: 1, 2, 3, 6)
  - [ ] Subtask 1.1: 创建MarketIndexDataManager，基于HybridDataManager扩展
  - [ ] Subtask 1.2: 实现批量指数数据轮询机制，支持10+指数并发
  - [ ] Subtask 1.3: 集成多源数据验证机制，确保指数数据准确性
  - [ ] Subtask 1.4: 实现L1/L2缓存策略，支持指数数据离线查看

### 指数变化分析和可视化
- [ ] **Task 2**: 实现指数变化检测和可视化系统 (AC: 4, 5)
  - [ ] Subtask 2.1: 创建IndexChangeAnalyzer，检测指数变化趋势
  - [ ] Subtask 2.2: 实现指数涨跌颜色提示和百分比显示
  - [ ] Subtask 2.3: 创建指数趋势图表组件
  - [ ] Subtask 2.4: 实现历史指数数据对比展示功能

### 状态管理和用户控制
- [ ] **Task 3**: 实现指数数据状态管理 (AC: 7, IV4)
  - [ ] Subtask 3.1: 创建MarketIndexCubit，管理指数数据状态
  - [ ] Subtask 3.2: 集成GlobalCubitManager，统一状态管理
  - [ ] Subtask 3.3: 实现暂停/恢复控制功能
  - [ ] Subtask 3.4: 添加指数轮询状态可视化指示器

### WebSocket扩展接口预留
- [ ] **Task 4**: 设计和实现WebSocket扩展接口 (AC: 8, IV6)
  - [ ] Subtask 4.1: 创建WebSocketIndexStrategy，预留实时数据接口
  - [ ] Subtask 4.2: 实现策略选择器，支持HTTP轮询到WebSocket的平滑切换
  - [ ] Subtask 4.3: 设计指数数据的实时推送协议
  - [ ] Subtask 4.4: 创建降级机制，WebSocket异常时自动切换到HTTP轮询

### 数据处理和缓存优化
- [ ] **Task 5**: 优化指数数据处理和缓存性能 (AC: 1, 3, IV2)
  - [ ] Subtask 5.1: 扩展UnifiedHiveCacheManager支持指数数据
  - [ ] Subtask 5.2: 实现指数数据压缩和批量处理优化
  - [ ] Subtask 5.3: 添加延迟监控和性能指标收集
  - [ ] Subtask 5.4: 实现智能缓存更新策略

### 测试和质量保证
- [ ] **Task 6**: 实现完整的测试覆盖
  - [ ] Subtask 6.1: 编写指数数据管理器单元测试
  - [ ] Subtask 6.2: 创建批量轮询的集成测试
  - [ ] Subtask 6.3: 实现延迟测试和性能基准测试
  - [ ] Subtask 6.4: 添加数据准确性验证测试
  - [ ] Subtask 6.5: 创建WebSocket扩展接口的兼容性测试</tasks>
  </story>

  <acceptanceCriteria>1. **AC1**: 市场指数数据准实时更新，延迟 < 30秒
   - 验证: 从API调用到UI展示延迟控制在30秒内
   - 测试方法: 端到端延迟测试和性能基准测试

2. **AC2**: 支持主要市场指数的批量获取
   - 验证: 同时获取上证指数、深证成指、创业板指等10+指数
   - 测试方法: 批量数据获取压力测试

3. **AC3**: 指数数据的多级缓存和离线支持
   - 验证: 数据缓存到L1/L2缓存，支持离线查看
   - 测试方法: 缓存策略验证和离线功能测试

4. **AC4**: 指数变化的智能分析和可视化
   - 验证: 指数变化时显示涨跌幅度、颜色提示和趋势图表
   - 测试方法: 数据分析和可视化效果测试

5. **AC5**: 历史指数数据的准实时对比展示
   - 验证: 当前数据与历史数据的对比分析图表
   - 测试方法: 数据对比准确性测试

6. **AC6**: 指数数据的准确性验证机制
   - 验证: 多源数据交叉验证确保数据准确性
   - 测试方法: 数据准确性验证测试

7. **AC7**: 支持指数数据的暂停/恢复控制
   - 验证: 用户可暂停/恢复指数数据更新
   - 测试方法: 暂停恢复功能测试

8. **AC8**: 为未来WebSocket实时推送预留扩展接口
   - 验证: 架构设计支持WebSocket策略的无缝集成
   - 测试方法: 接口扩展性和兼容性测试</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epic-2-hybrid-data-strategy-proposal.md</path>
        <title>Epic 2 混合数据获取策略</title>
        <section>数据分类和优先级 - 高优先级实时数据</section>
        <snippet>高优先级 - 实时数据 (未来WebSocket扩展): 市场指数：上证指数、深证成指、创业板指等</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-2-quasi-realtime-market-data-system.md</path>
        <title>Epic 2 技术规范</title>
        <section>市场指数数据模型和API接口</section>
        <snippet>MarketIndexData模型包含指数代码、名称、当前值、变化点数、变化百分比、更新时间和市场状态</snippet>
      </doc>
      <doc>
        <path>docs/api/fund_public.md</path>
        <title>AKShare API文档</title>
        <section>基金数据API接口</section>
        <snippet>提供东方财富网基金数据接口，支持基金基本信息和净值数据获取</snippet>
      </doc>
    </docs>
    <code>
      <component>
        <path>lib/src/core/network/hybrid/hybrid_data_manager.dart</path>
        <kind>数据管理器</kind>
        <symbol>HybridDataManager</symbol>
        <lines>16-533</lines>
        <reason>混合数据管理器，支持HTTP轮询、WebSocket和按需请求策略，为市场指数数据提供基础架构</reason>
      </component>
      <component>
        <path>lib/src/core/network/polling/polling_manager.dart</path>
        <kind>轮询管理器</kind>
        <symbol>PollingManager</symbol>
        <lines>154-836</lines>
        <reason>HTTP轮询管理器，支持智能频率调整和批量轮询，可用于市场指数数据的准实时获取</reason>
      </component>
      <component>
        <path>lib/src/core/cache/unified_hive_cache_manager.dart</path>
        <kind>缓存管理器</kind>
        <symbol>UnifiedHiveCacheManager</symbol>
        <lines>54-100</lines>
        <reason>统一Hive缓存管理器，支持L1内存缓存和L2磁盘缓存，为市场指数数据提供多级缓存支持</reason>
      </component>
    </code>
    <dependencies>
      <package name="dio" version="^5.3.0" purpose="HTTP客户端，用于市场指数API调用" />
      <package name="hive" version="^2.2.3" purpose="本地数据库，用于指数数据缓存" />
      <package name="flutter_bloc" version="^9.1.1" purpose="状态管理，用于指数数据状态" />
      <package name="fl_chart" version="^0.55.2" purpose="图表组件，用于指数数据可视化" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>必须基于现有HybridDataManager架构扩展，不能创建独立的数据获取系统</constraint>
    <constraint>集成三级缓存系统（L1内存+L2 Hive+L3 API），支持离线查看</constraint>
    <constraint>遵循Clean Architecture和BLoC状态管理模式</constraint>
    <constraint>为未来WebSocket实时推送预留扩展接口</constraint>
    <constraint>数据更新延迟要求：当前HTTP轮询&lt;30秒，未来WebSocket&lt;1秒</constraint>
    <constraint>支持10+个市场指数的并发获取</constraint>
    <constraint>集成现有金融级数据验证机制</constraint>
  </constraints>
  <interfaces>
    <interface name="MarketIndexDataManager" kind="class interface" signature="class MarketIndexDataManager { Future&lt;List&lt;MarketIndexData&gt;&gt; getMarketIndices(); Stream&lt;MarketIndexData&gt; get indexDataStream; Future&lt;void&gt; start(); Future&lt;void&gt; stop(); }" path="lib/src/features/market/data/processors/market_index_data_manager.dart" />
    <interface name="IndexChangeAnalyzer" kind="class interface" signature="class IndexChangeAnalyzer { IndexChangeData analyzeChange(MarketIndexData current, MarketIndexData previous); List&lt;IndexChangeData&gt; detectChanges(List&lt;MarketIndexData&gt; indices); }" path="lib/src/features/market/data/processors/index_change_analyzer.dart" />
    <interface name="MarketIndexCubit" kind="class interface" signature="class MarketIndexCubit extends Cubit&lt;MarketIndexState&gt; { Future&lt;void&gt; loadMarketIndices(); Future&lt;void&gt; refreshIndices(); Stream&lt;MarketIndexState&gt; get stateStream; }" path="lib/src/features/market/presentation/cubits/market_index_cubit.dart" />
  </interfaces>
  <tests>
    <standards>基于现有测试框架flutter_test和mockito，采用单元测试、集成测试和端到端测试三层测试策略。测试覆盖率目标≥90%，重点关注数据准确性、性能指标和用户交互流程。</standards>
    <locations>test/unit/features/market/ - 单元测试；test/integration/ - 集成测试；test/features/market/ - 功能测试</locations>
    <ideas>
      <test idea ac="AC1">端到端延迟测试 - 测试从API调用到UI展示的完整延迟&lt;30秒</test>
      <test idea ac="AC2">批量获取压力测试 - 测试同时获取10+指数的并发处理能力</test>
      <test idea ac="AC3">缓存策略验证测试 - 测试L1/L2缓存的命中率和离线功能</test>
      <test idea ac="AC4">可视化效果测试 - 测试指数变化的颜色提示和图表展示</test>
      <test idea ac="AC6">数据准确性验证测试 - 测试多源数据交叉验证机制</test>
      <test idea ac="AC7">暂停恢复功能测试 - 测试用户对指数数据更新的控制功能</test>
    </ideas>
  </tests>
</story-context>