# 环境配置管理指南

## 📋 概述

本文档描述了基速基金量化分析平台的环境配置管理系统，该系统基于`.env`文件和`flutter_dotenv`包实现，支持开发、测试和生产环境的安全配置管理。

## 🎯 目标

- **安全性**: 避免敏感信息硬编码在源代码中
- **灵活性**: 支持多环境切换和配置变更
- **可维护性**: 集中管理所有环境配置
- **向后兼容**: 不破坏现有代码结构

## 📁 文件结构

```
project_root/
├── .env                    # 当前激活的环境配置（不提交到版本控制）
├── .env.development        # 开发环境配置
├── .env.production         # 生产环境配置
├── .env.example           # 配置模板文件
├── lib/src/core/config/
│   └── app_config.dart     # 环境配置管理器
└── .gitignore             # 忽略敏感配置文件
```

## 🔧 配置文件说明

### `.env` - 主配置文件
该文件指定当前使用的环境配置：

```env
FLUTTER_ENV=development
```

### `.env.development` - 开发环境配置
包含开发环境的所有配置项：

```env
# API配置
API_BASE_URL=http://154.44.25.92:8080
API_CONNECT_TIMEOUT=30
API_RECEIVE_TIMEOUT=120
API_SEND_TIMEOUT=30
API_MAX_RETRIES=5
API_RETRY_DELAY=2

# 数据库配置
DB_HOST=154.44.25.92
DB_PORT=1433
DB_DATABASE=JiSuDB
DB_USERNAME=SA
DB_PASSWORD=Miami@2024

# 应用配置
APP_ENV=development
APP_DEBUG=true
APP_LOG_LEVEL=debug

# 缓存配置
CACHE_ENABLED=true
CACHE_TTL=3600
CACHE_MAX_SIZE=100

# 性能配置
PERFORMANCE_MONITORING_ENABLED=true
PERFORMANCE_RESPONSE_TIME_THRESHOLD=300
```

### `.env.production` - 生产环境配置
包含生产环境的所有配置项：

```env
# API配置
API_BASE_URL=https://api.jisu-fund.com
API_CONNECT_TIMEOUT=15
API_RECEIVE_TIMEOUT=60
API_SEND_TIMEOUT=15
API_MAX_RETRIES=3
API_RETRY_DELAY=1

# 数据库配置
DB_HOST=your-production-server.database.windows.net
DB_PORT=1433
DB_DATABASE=FundAnalyzerDB
DB_USERNAME=funduser
DB_PASSWORD=YourProduction@Password123

# 应用配置
APP_ENV=production
APP_DEBUG=false
APP_LOG_LEVEL=error

# 缓存配置
CACHE_ENABLED=true
CACHE_TTL=1800
CACHE_MAX_SIZE=500

# 性能配置
PERFORMANCE_MONITORING_ENABLED=true
PERFORMANCE_RESPONSE_TIME_THRESHOLD=200

# 安全配置
SECURITY_ENCRYPTION_ENABLED=true
SECURITY_TOKEN_EXPIRY=8

# 监控配置
MONITORING_ENABLED=true
MONITORING_ERROR_REPORTING=true
MONITORING_ANALYTICS_ENABLED=true
```

## 🏗️ 架构设计

### AppConfig 类
环境配置管理器采用单例模式，提供统一的配置访问接口：

```dart
class AppConfig {
  static AppConfig get instance => _instance ??= AppConfig._();

  // API配置
  String get apiBaseUrl => dotenv.env['API_BASE_URL'] ?? 'default';
  int get apiConnectTimeout => int.tryParse(dotenv.env['API_CONNECT_TIMEOUT'] ?? '30') ?? 30;

  // 数据库配置
  String get dbHost => dotenv.env['DB_HOST'] ?? 'localhost';
  // ... 其他配置项
}
```

### 使用方式
```dart
// 在应用启动时初始化
await AppConfig.initialize();

// 在代码中使用配置
final apiClient = Dio(BaseOptions(
  baseUrl: AppConfig.instance.apiBaseUrl,
  connectTimeout: Duration(seconds: AppConfig.instance.apiConnectTimeout),
));
```

## 🚀 使用指南

### 1. 开发环境设置

```bash
# 1. 复制开发环境配置
cp .env.example .env.development

# 2. 编辑开发环境配置
# 根据实际环境修改 .env.development 文件

# 3. 设置激活环境
echo "FLUTTER_ENV=development" > .env

# 4. 运行应用
flutter run -d windows
```

### 2. 生产环境设置

```bash
# 1. 创建生产环境配置
cp .env.example .env.production

# 2. 编辑生产环境配置
# 设置生产环境的服务器地址、数据库凭据等

# 3. 设置激活环境
echo "FLUTTER_ENV=production" > .env

# 4. 构建生产版本
flutter build windows --release
```

### 3. 在代码中访问配置

```dart
import 'package:jisu_fund_analyzer/src/core/config/app_config.dart';

class MyService {
  void initialize() {
    // 获取API配置
    final baseUrl = AppConfig.instance.apiBaseUrl;
    final timeout = AppConfig.instance.apiConnectTimeout;

    // 获取数据库配置
    final dbHost = AppConfig.instance.dbHost;
    final dbPassword = AppConfig.instance.dbPassword;

    // 根据环境执行不同逻辑
    if (AppConfig.instance.isDevelopment) {
      // 开发环境特殊处理
    }
  }
}
```

## 🔒 安全考虑

### 1. 敏感信息保护
- 所有`.env`文件都已添加到`.gitignore`
- 生产环境密码不应提交到版本控制
- 使用环境变量传递敏感信息

### 2. 配置验证
```dart
// 验证配置完整性
if (!AppConfig.instance.validateConfig()) {
  throw Exception('配置验证失败');
}
```

### 3. 生产环境注意事项
- 生产环境密码应使用强密码
- 启用加密配置
- 配置监控和错误报告

## 🛠️ 高级用法

### 1. 动态环境切换
```dart
// 在运行时切换环境
await AppConfig.reload(envFileName: '.env.production');
```

### 2. 配置验证
```dart
// 验证必要配置
final requiredVars = ['API_BASE_URL', 'DB_HOST'];
for (final varName in requiredVars) {
  if (dotenv.env[varName] == null) {
    throw Exception('缺少必需的配置: $varName');
  }
}
```

### 3. 配置调试
```dart
// 打印配置摘要（仅在开发模式）
AppConfig.instance.printConfigSummary();
```

## 📊 配置项参考

### API配置项
| 配置项 | 说明 | 开发环境默认值 | 生产环境默认值 |
|--------|------|---------------|---------------|
| API_BASE_URL | API基础URL | http://154.44.25.92:8080 | https://api.jisu-fund.com |
| API_CONNECT_TIMEOUT | 连接超时(秒) | 30 | 15 |
| API_RECEIVE_TIMEOUT | 接收超时(秒) | 120 | 60 |
| API_SEND_TIMEOUT | 发送超时(秒) | 30 | 15 |
| API_MAX_RETRIES | 最大重试次数 | 5 | 3 |
| API_RETRY_DELAY | 重试延迟(秒) | 2 | 1 |

### 数据库配置项
| 配置项 | 说明 | 开发环境默认值 | 生产环境默认值 |
|--------|------|---------------|---------------|
| DB_HOST | 数据库主机 | 154.44.25.92 | your-production-server |
| DB_PORT | 数据库端口 | 1433 | 1433 |
| DB_DATABASE | 数据库名称 | JiSuDB | FundAnalyzerDB |
| DB_USERNAME | 数据库用户名 | SA | funduser |
| DB_PASSWORD | 数据库密码 | Miami@2024 | YourProduction@Password123 |

### 应用配置项
| 配置项 | 说明 | 开发环境默认值 | 生产环境默认值 |
|--------|------|---------------|---------------|
| APP_ENV | 应用环境 | development | production |
| APP_DEBUG | 调试模式 | true | false |
| APP_LOG_LEVEL | 日志级别 | debug | error |

### 缓存配置项
| 配置项 | 说明 | 开发环境默认值 | 生产环境默认值 |
|--------|------|---------------|---------------|
| CACHE_ENABLED | 启用缓存 | true | true |
| CACHE_TTL | 缓存过期时间(秒) | 3600 | 1800 |
| CACHE_MAX_SIZE | 缓存最大大小 | 100 | 500 |

## 🔧 故障排除

### 常见问题

1. **配置文件未找到**
   ```
   解决方案：确保.env文件存在且格式正确
   ```

2. **必需配置项缺失**
   ```
   解决方案：检查.env文件是否包含所有必需的配置项
   ```

3. **生产环境配置错误**
   ```
   解决方案：验证生产环境的服务器地址和凭据
   ```

### 调试步骤

1. 检查应用启动日志
2. 验证配置文件语法
3. 确认环境变量设置
4. 运行配置验证

## 📝 最佳实践

1. **永远不要**将`.env`文件提交到版本控制
2. **定期**更新和轮换生产环境密码
3. **使用**强密码和安全的凭据管理
4. **监控**配置变更和访问日志
5. **备份**重要配置文件
6. **文档化**所有配置项的用途和格式

## 🔄 迁移指南

### 从硬编码配置迁移

1. 识别硬编码的配置项
2. 在`.env`文件中定义对应配置
3. 更新代码使用`AppConfig.instance`
4. 测试配置加载和验证
5. 部署到各个环境

---

**文档版本**: 1.0
**创建时间**: 2025-11-03
**维护人**: 架构师
**下次审查**: 配置系统更新时