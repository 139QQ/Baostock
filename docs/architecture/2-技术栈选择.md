# 2. æŠ€æœ¯æ ˆé€‰æ‹©

## ğŸ› ï¸ æŠ€æœ¯æ ˆæ¦‚è¿°

åŸºé€ŸåŸºé‡‘é‡åŒ–åˆ†æå¹³å°é‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆç»„åˆï¼Œé‡ç‚¹è€ƒè™‘äº†è·¨å¹³å°å…¼å®¹æ€§ã€å¼€å‘æ•ˆç‡ã€æ€§èƒ½è¡¨ç°å’Œæœªæ¥æ‰©å±•æ€§ã€‚æœ¬ç« èŠ‚è¯¦ç»†è¯´æ˜å„å±‚æŠ€æœ¯é€‰å‹çš„å†³ç­–è¿‡ç¨‹å’ŒæŠ€æœ¯ä¼˜åŠ¿ã€‚

### 2.1 å‰ç«¯æŠ€æœ¯æ ˆ

#### 2.1.1 æ ¸å¿ƒæ¡†æ¶é€‰æ‹©

##### Flutter 3.13+ (ä¸»è¦é€‰æ‹©)

**é€‰æ‹©ç†ç”±**ï¼š
- **è·¨å¹³å°ç»Ÿä¸€æ€§**: ä¸€å¥—ä»£ç åº“æ”¯æŒWebã€ç§»åŠ¨ç«¯ã€æ¡Œé¢ç«¯
- **æ€§èƒ½è¡¨ç°**: ç¼–è¯‘ä¸ºåŸç”Ÿä»£ç ï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿåº”ç”¨
- **å¼€å‘æ•ˆç‡**: çƒ­é‡è½½åŠŸèƒ½æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡
- **ç”Ÿæ€ä¸°å¯Œ**: æ‹¥æœ‰ä¸°å¯Œçš„æ’ä»¶åº“å’Œæ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ
- **UIä¸€è‡´æ€§**: ç¡®ä¿ä¸åŒå¹³å°é—´çš„è§†è§‰å’Œäº¤äº’ä¸€è‡´æ€§

**ç‰ˆæœ¬é€‰æ‹©ç­–ç•¥**ï¼š
```yaml
flutter:
  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¨³å®šç‰ˆæœ¬
  version: "3.13.x"
  # æ¸è¿›å¼å‡çº§ç­–ç•¥
  upgrade_strategy: "stable_only"
  # å®‰å…¨æ›´æ–°ä¼˜å…ˆ
  security_patches: "auto_apply"

dart:
  # ä¸Flutterç‰ˆæœ¬å…¼å®¹
  version: "3.0.x"
  # ç©ºå®‰å…¨ç‰¹æ€§
  null_safety: "enabled"
```

**å…·ä½“ç‰ˆæœ¬é…ç½®**ï¼š
```yaml
# pubspec.yaml æ ¸å¿ƒä¾èµ–
dependencies:
  flutter:
    sdk: flutter

  # çŠ¶æ€ç®¡ç†
  flutter_bloc: ^8.1.3
  bloc: ^8.1.2

  # ç½‘ç»œè¯·æ±‚
  dio: ^5.3.2
  retrofit: ^4.0.3
  json_annotation: ^4.8.1

  # æœ¬åœ°å­˜å‚¨
  hive: ^2.2.3
  path_provider: ^2.1.1
  shared_preferences: ^2.2.2

  # UIç»„ä»¶
  fl_chart: ^0.63.0
  google_fonts: ^6.1.0
  flutter_svg: ^2.0.9
  cached_network_image: ^3.3.0

  # å·¥å…·åº“
  get_it: ^7.6.4
  logger: ^2.0.2+1
  intl: ^0.18.1
```

##### å¤‡é€‰æ–¹æ¡ˆè¯„ä¼°

**React Native (å¤‡é€‰æ–¹æ¡ˆè¯„ä¼°ï¼‰**

**ä¼˜åŠ¿**ï¼š
- æ›´å¤§çš„å¼€å‘è€…ç¤¾åŒº
- æ›´ä¸°å¯Œçš„ç¬¬ä¸‰æ–¹åº“
- Webå¼€å‘ç»éªŒå¯ç›´æ¥å¤ç”¨

**åŠ£åŠ¿**ï¼š
- æ€§èƒ½ä¸å¦‚Flutter
- å¹³å°ç‰¹å®šä»£ç è¾ƒå¤š
- UIä¸€è‡´æ€§éš¾ä»¥ä¿è¯

**é€‰æ‹©Flutterçš„æ ¸å¿ƒåŸå› **ï¼š
1. æ€§èƒ½è¦æ±‚é«˜ï¼ŒFlutteræ›´æ¥è¿‘åŸç”Ÿæ€§èƒ½
2. éœ€è¦é«˜åº¦å®šåˆ¶åŒ–çš„æ•°æ®å¯è§†åŒ–ç»„ä»¶
3. ç»Ÿä¸€çš„UIä½“éªŒå¯¹äº§å“éå¸¸é‡è¦

#### 2.1.2 çŠ¶æ€ç®¡ç†æ¶æ„

##### BLoC (Business Logic Component)

**æ¶æ„é€‰æ‹©ç†ç”±**ï¼š
- **åˆ†ç¦»å…³æ³¨ç‚¹**: æ¸…æ™°åˆ†ç¦»ä¸šåŠ¡é€»è¾‘å’ŒUIè¡¨ç°
- **å¯æµ‹è¯•æ€§**: ä¸šåŠ¡é€»è¾‘å¯ä»¥ç‹¬ç«‹äºUIè¿›è¡Œæµ‹è¯•
- **å¯ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**: æ”¯æŒçŠ¶æ€ç¼“å­˜å’Œé«˜æ•ˆçš„çŠ¶æ€æ›´æ–°

**BLoCæ¶æ„å®ç°**ï¼š
```dart
// åŸºç¡€BLoCå®ç°ç¤ºä¾‹
abstract class BaseBloc<Event, State> extends Bloc<Event, State> {
  BaseBloc(super.initialState);

  @override
  void onError(BlocBase bloc, Object error, StackTrace stackTrace) {
    super.onError(bloc, error, stackTrace);
    Logger().error('BLoC Error', error: error, stackTrace: stackTrace);
  }

  @override
  void onTransition(Bloc bloc, Transition<Event, State> transition) {
    super.onTransition(bloc, transition);
    Logger().info('State Transition: ${transition.currentState} -> ${transition.nextState}');
  }
}

// åŸºé‡‘æœç´¢BLoCç¤ºä¾‹
class FundSearchBloc extends BaseBloc<FundSearchEvent, FundSearchState> {
  final FundRepository _fundRepository;

  FundSearchBloc(this._fundRepository) : super(FundSearchInitial()) {
    on<SearchFunds>(_onSearchFunds);
    on<LoadSearchHistory>(_onLoadSearchHistory);
    on<ClearSearchHistory>(_onClearSearchHistory);
  }

  Future<void> _onSearchFunds(
    SearchFunds event,
    Emitter<FundSearchState> emit,
  ) async {
    if (event.query.isEmpty) {
      emit(FundSearchInitial());
      return;
    }

    emit(FundSearchLoading());

    try {
      final funds = await _fundRepository.searchFunds(event.query);
      emit(FundSearchLoaded(funds));
    } catch (error) {
      emit(FundSearchError(error.toString()));
    }
  }
}
```

#### 2.1.3 UIç»„ä»¶åº“

##### Material Design 3 + å®šåˆ¶åŒ–ç»„ä»¶

**è®¾è®¡ç³»ç»Ÿæ¶æ„**ï¼š
```dart
// ä¸»é¢˜é…ç½®
class AppTheme {
  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      colorScheme: ColorScheme.fromSeed(
        seedColor: const Color(0xFF1E88E5),
        brightness: Brightness.light,
      ),
      textTheme: TextTheme(
        displayLarge: GoogleFonts.inter(
          fontSize: 32,
          fontWeight: FontWeight.bold,
        ),
        headlineMedium: GoogleFonts.inter(
          fontSize: 24,
          fontWeight: FontWeight.w600,
        ),
        bodyLarge: GoogleFonts.inter(
          fontSize: 16,
          fontWeight: FontWeight.normal,
        ),
      ),
    );
  }

  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      colorScheme: ColorScheme.fromSeed(
        seedColor: const Color(0xFF1E88E5),
        brightness: Brightness.dark,
      ),
    );
  }
}
```

**è‡ªå®šä¹‰ç»„ä»¶æ¶æ„**ï¼š
```dart
// åŸºé‡‘å¡ç‰‡ç»„ä»¶
class FundCard extends StatelessWidget {
  final Fund fund;
  final VoidCallback? onTap;
  final VoidCallback? onFavorite;

  const FundCard({
    super.key,
    required this.fund,
    this.onTap,
    this.onFavorite,
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          fund.name,
                          style: Theme.of(context).textTheme.headlineSmall,
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                        ),
                        const SizedBox(height: 4),
                        Text(
                          fund.code,
                          style: Theme.of(context).textTheme.bodyMedium,
                        ),
                      ],
                    ),
                  ),
                  IconButton(
                    onPressed: onFavorite,
                    icon: Icon(
                      fund.isFavorite ? Icons.favorite : Icons.favorite_border,
                      color: fund.isFavorite ? Colors.red : null,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 12),
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  _buildInfoCard(
                    context,
                    'æœ€æ–°å‡€å€¼',
                    fund.latestNav.toStringAsFixed(4),
                  ),
                  _buildInfoCard(
                    context,
                    'æ—¥æ¶¨å¹…',
                    '${fund.dailyChange.toStringAsFixed(2)}%',
                    valueColor: fund.dailyChange >= 0 ? Colors.green : Colors.red,
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildInfoCard(
    BuildContext context,
    String label,
    String value, {
    Color? valueColor,
  }) {
    return Expanded(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            label,
            style: Theme.of(context).textTheme.bodySmall,
            color: Theme.of(context).colorScheme.onSurfaceVariant,
          ),
          const SizedBox(height: 2),
          Text(
            value,
            style: Theme.of(context).textTheme.titleMedium?.copyWith(
              color: valueColor,
              fontWeight: FontWeight.w600,
            ),
          ),
        ],
      ),
    );
  }
}
```

### 2.2 åç«¯æŠ€æœ¯æ ˆ

#### 2.2.1 APIæœåŠ¡æ¶æ„

##### Python FastAPI (æ¨èæ–¹æ¡ˆ)

**æŠ€æœ¯é€‰å‹ç†ç”±**ï¼š
- **æ€§èƒ½ä¼˜ç§€**: å¼‚æ­¥æ”¯æŒï¼Œæ€§èƒ½è¿œè¶…ä¼ ç»Ÿæ¡†æ¶
- **å¼€å‘æ•ˆç‡**: è‡ªåŠ¨APIæ–‡æ¡£ç”Ÿæˆï¼Œç±»å‹æç¤ºæ”¯æŒ
- **ç”Ÿæ€ä¸°å¯Œ**: å¼ºå¤§çš„æ•°æ®ç§‘å­¦ç”Ÿæ€æ”¯æŒ
- **éƒ¨ç½²ç®€å•**: å†…ç½®ASGIæ”¯æŒï¼Œéƒ¨ç½²é…ç½®ç®€å•

**FastAPIæ ¸å¿ƒé…ç½®**ï¼š
```python
# main.py - FastAPIåº”ç”¨å…¥å£
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from contextlib import asynccontextmanager
import uvicorn

from app.core.config import settings
from app.api.v1.api import api_router
from app.core.database import engine, Base


@asynccontextmanager
async def lifespan(app: FastAPI):
    # åº”ç”¨å¯åŠ¨æ—¶æ‰§è¡Œ
    Base.metadata.create_all(bind=engine)
    print("Database tables created")

    yield

    # åº”ç”¨å…³é—­æ—¶æ‰§è¡Œ
    print("Application shutting down")


# FastAPIåº”ç”¨å®ä¾‹
app = FastAPI(
    title="åŸºé€ŸåŸºé‡‘æ•°æ®API",
    description="ä¸“ä¸šçš„åŸºé‡‘æ•°æ®æœåŠ¡API",
    version="1.0.0",
    lifespan=lifespan,
    docs_url="/api/docs",
    redoc_url="/api/redoc",
)

# ä¸­é—´ä»¶é…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=settings.ALLOWED_HOSTS,
)

# è·¯ç”±æ³¨å†Œ
app.include_router(api_router, prefix="/api/v1")


if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host=settings.HOST,
        port=settings.PORT,
        reload=settings.DEBUG,
        workers=1 if settings.DEBUG else 4,
    )
```

**é…ç½®ç®¡ç†**ï¼š
```python
# core/config.py - é…ç½®ç®¡ç†
from pydantic_settings import BaseSettings
from typing import List
import os


class Settings(BaseSettings):
    # åŸºç¡€é…ç½®
    PROJECT_NAME: str = "åŸºé€ŸåŸºé‡‘æ•°æ®API"
    VERSION: str = "1.0.0"
    DEBUG: bool = False

    # æœåŠ¡å™¨é…ç½®
    HOST: str = "0.0.0.0"
    PORT: int = 8000

    # å®‰å…¨é…ç½®
    SECRET_KEY: str = os.getenv("SECRET_KEY", "your-secret-key-here")
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30

    # æ•°æ®åº“é…ç½®
    DATABASE_URL: str = os.getenv("DATABASE_URL", "postgresql://user:password@localhost/dbname")

    # Redisé…ç½®
    REDIS_URL: str = os.getenv("REDIS_URL", "redis://localhost:6379")

    # CORSé…ç½®
    ALLOWED_ORIGINS: List[str] = [
        "http://localhost:3000",
        "http://localhost:8080",
        "https://yourdomain.com",
    ]

    # APIå¯†é’¥é…ç½®
    AKSHARE_API_KEY: str = os.getenv("AKSHARE_API_KEY", "")

    class Config:
        env_file = ".env"
        case_sensitive = True


settings = Settings()
```

##### å¤‡é€‰æ–¹æ¡ˆï¼šNode.js Express

**è¯„ä¼°ç»“æœ**ï¼š
- **ä¼˜åŠ¿**: JavaScriptç”Ÿæ€ï¼Œå‰ç«¯å¼€å‘ç»éªŒå¯å¤ç”¨
- **åŠ£åŠ¿**: å¼‚æ­¥å¤„ç†å¤æ‚åº¦è¾ƒé«˜ï¼Œæ€§èƒ½ä¸å¦‚FastAPI
- **é€‰æ‹©åŸå› **: Pythonåœ¨æ•°æ®å¤„ç†å’Œé‡‘èåˆ†ææ–¹é¢æ›´æœ‰ä¼˜åŠ¿

#### 2.2.2 æ•°æ®åº“æŠ€æœ¯æ ˆ

##### PostgreSQL 15+ (ä¸»æ•°æ®åº“)

**é€‰æ‹©ç†ç”±**ï¼š
- **æ•°æ®å®Œæ•´æ€§**: å¼ºå¤§çš„äº‹åŠ¡æ”¯æŒå’Œæ•°æ®ä¸€è‡´æ€§ä¿è¯
- **æ€§èƒ½è¡¨ç°**: ä¼˜ç§€çš„æŸ¥è¯¢æ€§èƒ½å’Œå¹¶å‘å¤„ç†èƒ½åŠ›
- **æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•å’Œè¯»å†™åˆ†ç¦»
- **åŠŸèƒ½ä¸°å¯Œ**: æ”¯æŒJSONå­—æ®µã€å…¨æ–‡æœç´¢ç­‰é«˜çº§åŠŸèƒ½

**æ•°æ®åº“æ¶æ„è®¾è®¡**ï¼š
```sql
-- åŸºé‡‘åŸºæœ¬ä¿¡æ¯è¡¨
CREATE TABLE funds (
    code VARCHAR(10) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL,
    company VARCHAR(50) NOT NULL,
    establishment_date DATE,
    latest_nav NUMERIC(12, 4),
    latest_date DATE,
    total_assets NUMERIC(18, 2),
    management_fee NUMERIC(5, 3),
    custodian_fee NUMERIC(5, 3),
    performance_fee NUMERIC(5, 3),
    risk_level VARCHAR(10),
    investment_target TEXT,
    investment_strategy TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åŸºé‡‘å‡€å€¼å†å²è¡¨
CREATE TABLE fund_nav_history (
    id SERIAL PRIMARY KEY,
    fund_code VARCHAR(10) REFERENCES funds(code),
    nav_date DATE NOT NULL,
    nav_value NUMERIC(12, 4) NOT NULL,
    accumulated_nav NUMERIC(12, 4),
    daily_change NUMERIC(8, 4),
    daily_change_rate NUMERIC(8, 4),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_fund_date UNIQUE (fund_code, nav_date)
);

-- åŸºé‡‘åˆ†çº¢å†å²è¡¨
CREATE TABLE fund_dividends (
    id SERIAL PRIMARY KEY,
    fund_code VARCHAR(10) REFERENCES funds(code),
    ex_dividend_date DATE NOT NULL,
    dividend_value NUMERIC(12, 4),
    dividend_type VARCHAR(20),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·æ”¶è—åŸºé‡‘è¡¨
CREATE TABLE user_favorites (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    fund_code VARCHAR(10) REFERENCES funds(code),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT unique_user_fund UNIQUE (user_id, fund_code)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_funds_type ON funds(type);
CREATE INDEX idx_funds_company ON funds(company);
CREATE INDEX idx_fund_nav_history_date ON fund_nav_history(nav_date);
CREATE INDEX idx_fund_nav_history_fund_code ON fund_nav_history(fund_code);
CREATE INDEX idx_user_favorites_user_id ON user_favorites(user_id);

-- åˆ†åŒºç­–ç•¥ (å¤§æ•°æ®é‡æ—¶ä½¿ç”¨)
-- CREATE TABLE fund_nav_history_2024 PARTITION OF fund_nav_history
--     FOR VALUES FROM ('2024-01-01') TO ('2025-01-01');
```

**æ•°æ®åº“è¿æ¥é…ç½®**ï¼š
```python
# core/database.py - æ•°æ®åº“é…ç½®
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from contextlib import contextmanager
import logging

from .config import settings

# æ•°æ®åº“å¼•æ“é…ç½®
engine = create_engine(
    settings.DATABASE_URL,
    pool_size=20,
    max_overflow=30,
    pool_pre_ping=True,
    pool_recycle=3600,
    echo=settings.DEBUG,
)

# ä¼šè¯å·¥å‚
SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine,
)

# åŸºç±»
Base = declarative_base()


# æ•°æ®åº“ä¼šè¯ç®¡ç†
def get_db():
    db = SessionLocal()
    try:
        yield db
    except Exception as e:
        logging.error(f"Database session error: {e}")
        db.rollback()
        raise
    finally:
        db.close()


@contextmanager
def get_db_session():
    """ä¸Šä¸‹æ–‡ç®¡ç†å™¨å½¢å¼çš„æ•°æ®åº“ä¼šè¯"""
    session = SessionLocal()
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()
```

#### 2.2.3 ç¼“å­˜æŠ€æœ¯æ ˆ

##### Redis 7+ (ç¼“å­˜å±‚)

**é€‰æ‹©ç†ç”±**ï¼š
- **æ€§èƒ½ä¼˜ç§€**: å†…å­˜æ•°æ®åº“ï¼Œè®¿é—®é€Ÿåº¦æå¿«
- **æ•°æ®ç»“æ„ä¸°å¯Œ**: æ”¯æŒå¤šç§æ•°æ®ç±»å‹
- **æŒä¹…åŒ–æ”¯æŒ**: æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œé¿å…æ•°æ®ä¸¢å¤±
- **ç”Ÿæ€å®Œå–„**: ä¸Python/Node.jsç­‰è¯­è¨€é›†æˆè‰¯å¥½

**ç¼“å­˜æ¶æ„è®¾è®¡**ï¼š
```python
# core/cache.py - Redisç¼“å­˜é…ç½®
import redis
import json
import logging
from typing import Optional, Any
from datetime import timedelta
from .config import settings

class RedisCache:
    def __init__(self):
        self.redis_client = redis.Redis.from_url(settings.REDIS_URL, decode_responses=True)
        self.default_ttl = 3600  # 1å°æ—¶é»˜è®¤è¿‡æœŸæ—¶é—´

    async def get(self, key: str) -> Optional[Any]:
        """è·å–ç¼“å­˜æ•°æ®"""
        try:
            data = self.redis_client.get(key)
            if data:
                return json.loads(data)
            return None
        except Exception as e:
            logging.error(f"Redis GET error: {e}")
            return None

    async def set(
        self,
        key: str,
        value: Any,
        ttl: Optional[int] = None
    ) -> bool:
        """è®¾ç½®ç¼“å­˜æ•°æ®"""
        try:
            ttl = ttl or self.default_ttl
            return self.redis_client.setex(key, ttl, json.dumps(value, default=str))
        except Exception as e:
            logging.error(f"Redis SET error: {e}")
            return False

    async def delete(self, key: str) -> bool:
        """åˆ é™¤ç¼“å­˜æ•°æ®"""
        try:
            return bool(self.redis_client.delete(key))
        except Exception as e:
            logging.error(f"Redis DELETE error: {e}")
            return False

    async def clear_pattern(self, pattern: str) -> int:
        """æ¸…é™¤åŒ¹é…æ¨¡å¼çš„æ‰€æœ‰ç¼“å­˜"""
        try:
            keys = self.redis_client.keys(pattern)
            if keys:
                return self.redis_client.delete(*keys)
            return 0
        except Exception as e:
            logging.error(f"Redis CLEAR_PATTERN error: {e}")
            return 0


# å…¨å±€ç¼“å­˜å®ä¾‹
cache = RedisCache()

# ç¼“å­˜è£…é¥°å™¨
def cache_result(ttl: int = 3600, key_prefix: str = ""):
    """ç¼“å­˜å‡½æ•°ç»“æœçš„è£…é¥°å™¨"""
    def decorator(func):
        async def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜key
            cache_key = f"{key_prefix}{func.__name__}:{str(args)}:{str(kwargs)}"

            # å°è¯•ä»ç¼“å­˜è·å–
            cached_result = await cache.get(cache_key)
            if cached_result is not None:
                return cached_result

            # æ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ç»“æœ
            result = await func(*args, **kwargs)
            await cache.set(cache_key, result, ttl)
            return result
        return wrapper
    return decorator
```

### 2.3 å¼€å‘å’Œè¿ç»´å·¥å…·

#### 2.3.1 ä»£ç ç”Ÿæˆå’Œæ„å»ºå·¥å…·

##### è‡ªåŠ¨åŒ–ä»£ç ç”Ÿæˆ

**build_runneré…ç½®**ï¼š
```yaml
# pubspec.yaml å¼€å‘ä¾èµ–
dev_dependencies:
  build_runner: ^2.4.6
  json_serializable: ^6.7.1
  retrofit_generator: ^7.0.8
  hive_generator: ^2.0.1
  flutter_lints: ^3.0.1
  flutter_test:
    sdk: flutter

# æ„å»ºè„šæœ¬
scripts:
  build: "flutter pub run build_runner build --delete-conflicting-outputs"
  build-watch: "flutter pub run build_runner watch --delete-conflicting-outputs"
  clean-build: "flutter pub run build_runner clean"
```

**æ•°æ®æ¨¡å‹ç”Ÿæˆ**ï¼š
```dart
// fund_model.dart - æ•°æ®æ¨¡å‹å®šä¹‰
import 'package:json_annotation/json_annotation.dart';

part 'fund_model.g.dart';

@JsonSerializable()
class Fund {
  final String code;
  final String name;
  final String type;
  final String company;
  final DateTime? establishmentDate;
  final double? latestNav;
  final DateTime? latestDate;
  final double? totalAssets;
  final double? managementFee;
  final double? custodianFee;
  final double? performanceFee;
  final String? riskLevel;
  final String? investmentTarget;
  final String? investmentStrategy;
  final bool isFavorite;
  final DateTime? lastUpdated;

  Fund({
    required this.code,
    required this.name,
    required this.type,
    required this.company,
    this.establishmentDate,
    this.latestNav,
    this.latestDate,
    this.totalAssets,
    this.managementFee,
    this.custodianFee,
    this.performanceFee,
    this.riskLevel,
    this.investmentTarget,
    this.investmentStrategy,
    this.isFavorite = false,
    this.lastUpdated,
  });

  factory Fund.fromJson(Map<String, dynamic> json) => _$FundFromJson(json);
  Map<String, dynamic> toJson() => _$FundToJson(this);

  Fund copyWith({
    String? code,
    String? name,
    String? type,
    String? company,
    DateTime? establishmentDate,
    double? latestNav,
    DateTime? latestDate,
    double? totalAssets,
    double? managementFee,
    double? custodianFee,
    double? performanceFee,
    String? riskLevel,
    String? investmentTarget,
    String? investmentStrategy,
    bool? isFavorite,
    DateTime? lastUpdated,
  }) {
    return Fund(
      code: code ?? this.code,
      name: name ?? this.name,
      type: type ?? this.type,
      company: company ?? this.company,
      establishmentDate: establishmentDate ?? this.establishmentDate,
      latestNav: latestNav ?? this.latestNav,
      latestDate: latestDate ?? this.latestDate,
      totalAssets: totalAssets ?? this.totalAssets,
      managementFee: managementFee ?? this.managementFee,
      custodianFee: custodianFee ?? this.custodianFee,
      performanceFee: performanceFee ?? this.performanceFee,
      riskLevel: riskLevel ?? this.riskLevel,
      investmentTarget: investmentTarget ?? this.investmentTarget,
      investmentStrategy: investmentStrategy ?? this.investmentStrategy,
      isFavorite: isFavorite ?? this.isFavorite,
      lastUpdated: lastUpdated ?? this.lastUpdated,
    );
  }
}
```

#### 2.3.2 CI/CDå·¥å…·é“¾

##### GitHub Actionså·¥ä½œæµ

**Flutteræ„å»ºé…ç½®**ï¼š
```yaml
# .github/workflows/flutter-build.yml
name: Flutter Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.x'
        channel: 'stable'
        cache: true
        cache-key: flutter-${{ runner.os }}-3.13.x-stable

    - name: Install dependencies
      run: flutter pub get

    - name: Generate code
      run: flutter pub run build_runner build --delete-conflicting-outputs

    - name: Run Flutter tests
      run: flutter test --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: flutter
        name: flutter-coverage

  build-android:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.x'
        channel: 'stable'
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Build Android APK
      run: flutter build apk --release

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-release
        path: build/app/outputs/flutter-apk/app-release.apk

  build-web:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.x'
        channel: 'stable'
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Build web release
      run: flutter build web --release

    - name: Upload web artifact
      uses: actions/upload-artifact@v3
      with:
        name: web-release
        path: build/web
```

**Python APIæ„å»ºé…ç½®**ï¼š
```yaml
# .github/workflows/python-api.yml
name: Python API Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'api/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'api/**'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      working-directory: ./api
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Run code linting
      working-directory: ./api
      run: |
        flake8 app/ tests/
        black --check app/ tests/

    - name: Run security checks
      working-directory: ./api
      run: |
        bandit -r app/

    - name: Run tests
      working-directory: ./api
      run: |
        pytest tests/ -v --cov=app --cov-report=xml --cov-report=html

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./api/coverage.xml
        flags: python-api
        name: python-coverage

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./api
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/jisu-api:latest
          ${{ secrets.DOCKER_USERNAME }}/jisu-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
```

### 2.4 ç›‘æ§å’Œæ—¥å¿—

#### 2.4.1 åº”ç”¨æ€§èƒ½ç›‘æ§

**Sentryé›†æˆé…ç½®**ï¼š
```dart
// main.dart - Sentryé›†æˆ
import 'package:sentry_flutter/sentry_flutter.dart';

Future<void> main() async {
  // Sentryé…ç½®
  await SentryFlutter.init(
    (options) {
      options.dsn = 'https://your-dsn@sentry.io/project-id';
      options.tracesSampleRate = 1.0;
      options.debug = kDebugMode;

      // ç¯å¢ƒé…ç½®
      if (kDebugMode) {
        options.environment = 'development';
      } else if (kProfileMode) {
        options.environment = 'staging';
      } else {
        options.environment = 'production';
      }

      // æ€§èƒ½ç›‘æ§
      options.enableAutoPerformanceTracing = true;
      options.enableOutOfMemoryTracking = true;

      // ç”¨æˆ·ä¿¡æ¯
      options beforeSend = (event) {
        if (event.request?.url?.contains('localhost') ?? false) {
          return null; // å¿½ç•¥å¼€å‘ç¯å¢ƒçš„é”™è¯¯
        }
        return event;
      };
    },
    appRunner: () => runApp(const JisuApp()),
  );
}
```

**æ€§èƒ½ç›‘æ§å®ç°**ï¼š
```dart
// performance_monitor.dart - æ€§èƒ½ç›‘æ§
import 'package:flutter/material.dart';
import 'package:sentry/sentry.dart';

class PerformanceMonitor {
  static final PerformanceMonitor _instance = PerformanceMonitor._internal();
  factory PerformanceMonitor() => _instance;
  PerformanceMonitor._internal();

  // é¡µé¢æ€§èƒ½ç›‘æ§
  void startScreenTransition(String fromScreen, String toScreen) {
    Sentry.startTransaction(
      'screen_transition_$toScreen',
      'ui.interaction',
      description: 'Screen transition from $fromScreen to $toScreen',
      data: {
        'from_screen': fromScreen,
        'to_screen': toScreen,
      },
    );
  }

  // APIè¯·æ±‚æ€§èƒ½ç›‘æ§
  Future<T> traceApiCall<T>(
    String apiName,
    Future<T> apiCall, {
    Map<String, dynamic>? data,
  }) async {
    final transaction = Sentry.startTransaction(
      'api_call_$apiName',
      'http.client',
      data: data,
    );

    try {
      final result = await apiCall;
      transaction.setData('status', 'success');
      return result;
    } catch (error, stackTrace) {
      transaction.setData('status', 'error');
      transaction.throwable = error;
      rethrow;
    } finally {
      await transaction.finish();
    }
  }

  // æ•°æ®åº“æ“ä½œç›‘æ§
  Future<T> traceDatabaseOperation<T>(
    String operation,
    Future<T> dbOperation, {
    Map<String, dynamic>? data,
  }) async {
    final transaction = Sentry.startTransaction(
      'db_operation_$operation',
      'db.query',
      data: data,
    );

    try {
      final result = await dbOperation;
      transaction.setData('status', 'success');
      return result;
    } catch (error, stackTrace) {
      transaction.setData('status', 'error');
      transaction.throwable = error;
      rethrow;
    } finally {
      await transaction.finish();
    }
  }
}
```

#### 2.4.2 æ—¥å¿—ç³»ç»Ÿ

**åº”ç”¨æ—¥å¿—é…ç½®**ï¼š
```dart
// app_logger.dart - æ—¥å¿—é…ç½®
import 'package:logger/logger.dart';

class AppLogger {
  static final Logger _logger = Logger(
    printer: PrettyPrinter(
      methodCount: 0,
      errorMethodCount: 8,
      lineLength: 120,
      colors: true,
      printEmojis: true,
      printTime: true,
    ),
    level: kDebugMode ? Level.debug : Level.info,
    filter: ProductionFilter(),
  );

  static void debug(String message, {Object? error, StackTrace? stackTrace}) {
    _logger.d(message, error: error, stackTrace: stackTrace);
  }

  static void info(String message, {Object? error, StackTrace? stackTrace}) {
    _logger.i(message, error: error, stackTrace: stackTrace);
  }

  static void warning(String message, {Object? error, StackTrace? stackTrace}) {
    _logger.w(message, error: error, stackTrace: stackTrace);
  }

  static void error(String message, {Object? error, StackTrace? stackTrace}) {
    _logger.e(message, error: error, stackTrace: stackTrace);
  }

  static void logApiCall(String method, String url, {int? statusCode, int? duration}) {
    _logger.i(
      'API Call: $method $url',
      error: statusCode != null && statusCode >= 400 ? 'HTTP $statusCode' : null,
      time: Duration(milliseconds: duration ?? 0),
    );
  }
}

class ProductionFilter extends LogFilter {
  @override
  bool shouldLog(LogEvent event) {
    if (!kDebugMode && event.level == Level.debug) {
      return false;
    }
    return true;
  }
}
```

---

## ğŸ¯ æŠ€æœ¯é€‰å‹æ€»ç»“

### 2.5 æŠ€æœ¯æ ˆä¼˜åŠ¿åˆ†æ

#### è·¨å¹³å°ä¼˜åŠ¿
- **ç»Ÿä¸€ä»£ç åº“**: Flutterå®ç°ä¸€æ¬¡ç¼–ç ï¼Œå¤šå¹³å°è¿è¡Œ
- **å¼€å‘æ•ˆç‡**: å‡å°‘å¤šå¹³å°é€‚é…å·¥ä½œé‡
- **ç»´æŠ¤æˆæœ¬**: ç»Ÿä¸€çš„ä»£ç åº“é™ä½ç»´æŠ¤å¤æ‚åº¦
- **ä½“éªŒä¸€è‡´æ€§**: ç¡®ä¿ä¸åŒå¹³å°çš„ç”¨æˆ·ä½“éªŒä¸€è‡´

#### æ€§èƒ½ä¼˜åŠ¿
- **Flutteræ€§èƒ½**: æ¥è¿‘åŸç”Ÿåº”ç”¨çš„æ€§èƒ½è¡¨ç°
- **å¼‚æ­¥æ¶æ„**: å…¨å¼‚æ­¥å¤„ç†ç¡®ä¿ç•Œé¢æµç•…
- **ç¼“å­˜ä¼˜åŒ–**: å¤šçº§ç¼“å­˜ç­–ç•¥æå‡å“åº”é€Ÿåº¦
- **æ•°æ®åº“ä¼˜åŒ–**: PostgreSQLçš„é«˜æ€§èƒ½æŸ¥è¯¢èƒ½åŠ›

#### å¼€å‘æ•ˆç‡ä¼˜åŠ¿
- **çƒ­é‡è½½**: Flutterçƒ­é‡è½½æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡
- **è‡ªåŠ¨åŒ–å·¥å…·**: å®Œå–„çš„è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•å·¥å…·
- **APIæ–‡æ¡£**: FastAPIè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
- **ç±»å‹å®‰å…¨**: å¼ºç±»å‹ç³»ç»Ÿå‡å°‘è¿è¡Œæ—¶é”™è¯¯

#### æ‰©å±•æ€§ä¼˜åŠ¿
- **æ¨¡å—åŒ–æ¶æ„**: ä¾¿äºåŠŸèƒ½æ‰©å±•å’Œæ¨¡å—æ›¿æ¢
- **äº‘åŸç”Ÿ**: æ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²å’Œäº‘åŸç”Ÿæ¶æ„
- **å¾®æœåŠ¡å‹å¥½**: å¯ä»¥è½»æ¾æ‰©å±•ä¸ºå¾®æœåŠ¡æ¶æ„
- **æ•°æ®æ‰©å±•**: æ”¯æŒå¤§è§„æ¨¡æ•°æ®å¤„ç†å’Œåˆ†æ

### 2.6 æŠ€æœ¯é£é™©æ§åˆ¶

#### ä¸»è¦æŠ€æœ¯é£é™©
1. **Flutterç‰ˆæœ¬å…¼å®¹æ€§**: å¤§ç‰ˆæœ¬å‡çº§å¯èƒ½å¸¦æ¥å…¼å®¹æ€§é—®é¢˜
2. **ç¬¬ä¸‰æ–¹åº“ä¾èµ–**: è¿‡åº¦ä¾èµ–ç¬¬ä¸‰æ–¹åº“å¯èƒ½å¸¦æ¥ç»´æŠ¤é£é™©
3. **æ€§èƒ½ç“¶é¢ˆ**: å¤§æ•°æ®å¤„ç†å¯èƒ½å­˜åœ¨æ€§èƒ½ç“¶é¢ˆ

#### é£é™©ç¼“è§£ç­–ç•¥
1. **ç‰ˆæœ¬é”å®š**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç»è¿‡éªŒè¯çš„ç¨³å®šç‰ˆæœ¬
2. **ä¾èµ–å®¡æŸ¥**: å®šæœŸå®¡æŸ¥ç¬¬ä¸‰æ–¹åº“çš„è´¨é‡å’Œç»´æŠ¤çŠ¶æ€
3. **æ€§èƒ½æµ‹è¯•**: å»ºç«‹å®Œå–„çš„æ€§èƒ½æµ‹è¯•å’Œç›‘æ§ä½“ç³»
4. **å¤‡ä»½æ–¹æ¡ˆ**: ä¸ºå…³é”®ç»„ä»¶å‡†å¤‡å¤‡é€‰æŠ€æœ¯æ–¹æ¡ˆ

---

*æœ¬ç« èŠ‚è¯¦ç»†è¯´æ˜äº†åŸºé€Ÿå¹³å°çš„æŠ€æœ¯æ ˆé€‰æ‹©ï¼ŒåŒ…æ‹¬å‰ç«¯æ¡†æ¶ã€åç«¯æœåŠ¡ã€æ•°æ®åº“ã€ç¼“å­˜ç­‰å„ä¸ªå±‚é¢é€‰å‹å†³ç­–å’ŒæŠ€æœ¯ä¼˜åŠ¿*