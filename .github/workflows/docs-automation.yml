# ğŸ“– åŸºé‡‘é‡åŒ–åˆ†æå¹³å° - æ–‡æ¡£è‡ªåŠ¨åŒ–å·¥ä½œæµ
# ç‰ˆæœ¬: v1.0
# æè¿°: è‡ªåŠ¨åŒ–æ–‡æ¡£ç”Ÿæˆã€æ£€æŸ¥å’Œæ›´æ–°

name: ğŸ“– æ–‡æ¡£è‡ªåŠ¨åŒ–

# è§¦å‘æ¡ä»¶
on:
  # ä»£ç æ¨é€æ—¶è§¦å‘
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - '.docs-config.yaml'
      - '.github/workflows/docs-automation.yml'
      - '.github/scripts/doc_generator.py'

  # Pull Requestæ—¶è§¦å‘
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.docs-config.yaml'

  # å®šæ—¶æ‰§è¡Œ (æ¯å¤©å‡Œæ™¨2ç‚¹)
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œçš„æ“ä½œ'
        required: true
        default: 'generate'
        type: choice
        options:
          - generate
          - check
          - sync
      verbose:
        description: 'è¯¦ç»†è¾“å‡º'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

# ä»»åŠ¡å®šä¹‰
jobs:
  # æ–‡æ¡£è‡ªåŠ¨åŒ–ä»»åŠ¡
  docs-automation:
    name: ğŸ“– æ–‡æ¡£è‡ªåŠ¨åŒ–å¤„ç†
    runs-on: ubuntu-latest

    # æƒé™è®¾ç½®
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. å®‰è£…Pythonä¾èµ–
      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install jinja2 pyyaml markdown markdown-link-check

      # 4. è®¾ç½®Node.jsç¯å¢ƒ (ç”¨äºå…¶ä»–å·¥å…·)
      - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 5. å®‰è£…Node.jsä¾èµ–
      - name: ğŸ“¦ å®‰è£…Node.jsä¾èµ–
        run: |
          npm install -g markdownlint-cli2

      # 6. åˆ›å»ºå¿…è¦çš„ç›®å½•
      - name: ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p .docs-templates
          mkdir -p .docs-backup

      # 7. æ‰§è¡Œæ–‡æ¡£è‡ªåŠ¨åŒ–
      - name: ğŸ¤– æ‰§è¡Œæ–‡æ¡£è‡ªåŠ¨åŒ–
        id: generate-docs
        run: |
          ACTION="${{ github.event.inputs.action || 'generate' }}"
          VERBOSE="${{ github.event.inputs.verbose || false }}"

          echo "ğŸš€ æ‰§è¡Œæ“ä½œ: $ACTION"
          echo "ğŸ“ è¯¦ç»†è¾“å‡º: $VERBOSE"

          if [ "$VERBOSE" = "true" ]; then
            python .github/scripts/doc_generator.py --action $ACTION --project-root . --verbose
          else
            python .github/scripts/doc_generator.py --action $ACTION --project-root .
          fi

      # 8. æ£€æŸ¥å˜æ›´
      - name: ğŸ” æ£€æŸ¥æ–‡æ¡£å˜æ›´
        id: check-changes
        run: |
          if git diff --quiet docs/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“„ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´:"
            git diff --name-only docs/
          fi

      # 9. æ–‡æ¡£è´¨é‡æ£€æŸ¥
      - name: ğŸ” æ–‡æ¡£è´¨é‡æ£€æŸ¥
        run: |
          echo "ğŸ” å¼€å§‹æ–‡æ¡£è´¨é‡æ£€æŸ¥..."

          # Markdownæ ¼å¼æ£€æŸ¥
          echo "ğŸ“ æ£€æŸ¥Markdownæ ¼å¼..."
          markdownlint-cli2 "docs/**/*.md" || true

          # é“¾æ¥æœ‰æ•ˆæ€§æ£€æŸ¥
          echo "ğŸ”— æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§..."
          find docs/ -name "*.md" -exec markdown-link-check {} \; || true

          # æ–‡æ¡£å¤§å°æ£€æŸ¥
          echo "ğŸ“Š æ£€æŸ¥æ–‡æ¡£å¤§å°..."
          find docs/ -name "*.md" -size +1M -exec ls -lh {} \; || echo "âœ… æ‰€æœ‰æ–‡æ¡£å¤§å°æ­£å¸¸"

      # 10. ç”Ÿæˆè‡ªåŠ¨åŒ–æŠ¥å‘Š
      - name: ğŸ“Š ç”Ÿæˆè‡ªåŠ¨åŒ–æŠ¥å‘Š
        run: |
          cat > docs/automation-report.md << 'EOF'
          # ğŸ“– æ–‡æ¡£è‡ªåŠ¨åŒ–æŠ¥å‘Š

          ## ğŸ“‹ æ‰§è¡Œä¿¡æ¯

          - **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
          - **æäº¤SHA**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **æ“ä½œç±»å‹**: ${{ github.event.inputs.action || 'generate' }}

          ## ğŸ“Š æ‰§è¡Œç»“æœ

          ### ğŸ“ æ–‡æ¡£çŠ¶æ€

          EOF

          # æ·»åŠ æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯
          echo "#### ğŸ“„ æ–‡æ¡£ç»Ÿè®¡" >> docs/automation-report.md
          echo "" >> docs/automation-report.md
          echo "- æ€»æ–‡æ¡£æ•°: $(find docs/ -name "*.md" | wc -l)" >> docs/automation-report.md
          echo "- PRDæ–‡æ¡£æ•°: $(find docs/prd/ -name "*.md" 2>/dev/null | wc -l)" >> docs/automation-report.md
          echo "- æ¶æ„æ–‡æ¡£æ•°: $(find docs/architecture/ -name "*.md" 2>/dev/null | wc -l)" >> docs/automation-report.md
          echo "- ç”¨æˆ·æ•…äº‹æ•°: $(find docs/stories/ -name "*.md" 2>/dev/null | wc -l)" >> docs/automation-report.md
          echo "- QAæ–‡æ¡£æ•°: $(find docs/qa/ -name "*.md" 2>/dev/null | wc -l)" >> docs/automation-report.md

          echo "" >> docs/automation-report.md
          echo "### ğŸ”„ å˜æ›´çŠ¶æ€" >> docs/automation-report.md
          echo "" >> docs/automation-report.md
          if [ "${{ steps.check-changes.outputs.changed }}" = "true" ]; then
            echo "âœ… æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´ï¼Œå·²è‡ªåŠ¨æ›´æ–°" >> docs/automation-report.md
          else
            echo "ğŸ“„ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡æ¡£å˜æ›´" >> docs/automation-report.md
          fi

          echo "" >> docs/automation-report.md
          echo "---" >> docs/automation-report.md
          echo "" >> docs/automation-report.md
          echo "*ğŸ¤– æœ¬æŠ¥å‘Šç”±æ–‡æ¡£è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ*" >> docs/automation-report.md
          echo "*ğŸ“… ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')*" >> docs/automation-report.md

      # 11. æäº¤æ–‡æ¡£å˜æ›´
      - name: ğŸ“¤ æäº¤æ–‡æ¡£å˜æ›´
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ å˜æ›´çš„æ–‡æ¡£
          git add docs/

          # æäº¤å˜æ›´
          git commit -m "[docs] è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ - $(date '+%Y-%m-%d %H:%M:%S')

          ğŸ“ æ›´æ–°å†…å®¹:
          $(git diff --cached --name-only docs/ | sed 's/^/- /')

          ğŸ¤– ç”±æ–‡æ¡£è‡ªåŠ¨åŒ–ç³»ç»Ÿå¤„ç†

          - æ‰§è¡Œæ“ä½œ: ${{ github.event.inputs.action || 'generate' }}
          - è§¦å‘äº‹ä»¶: ${{ github.event_name }}
          - æäº¤SHA: ${{ github.sha }}" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"

          # æ¨é€å˜æ›´
          git push

      # 12. åˆ›å»ºPull Request (å¯é€‰)
      - name: ğŸ”€ åˆ›å»ºPull Request
        if: steps.check-changes.outputs.changed == 'true' && github.ref != 'refs/heads/main'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[docs] è‡ªåŠ¨æ›´æ–°æ–‡æ¡£"
          title: "ğŸ“– è‡ªåŠ¨æ–‡æ¡£æ›´æ–°"
          body: |
            ## ğŸ“– æ–‡æ¡£è‡ªåŠ¨åŒ–æ›´æ–°

            æ­¤PRç”±æ–‡æ¡£è‡ªåŠ¨åŒ–ç³»ç»Ÿåˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°:

            ### ğŸ“ æ›´æ–°å†…å®¹
            - è‡ªåŠ¨ç”Ÿæˆ/æ›´æ–°æ–‡æ¡£ç´¢å¼•
            - ä¿®å¤æ–‡æ¡£é“¾æ¥
            - æ›´æ–°æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯

            ### ğŸ”§ æ‰§è¡Œä¿¡æ¯
            - **æ“ä½œç±»å‹**: ${{ github.event.inputs.action || 'generate' }}
            - **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
            - **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')

            ---

            *ğŸ¤– æ­¤PRç”±æ–‡æ¡£è‡ªåŠ¨åŒ–ç³»ç»Ÿåˆ›å»º*
          branch: docs-auto-update
          delete-branch: true

      # 13. éƒ¨ç½²æ–‡æ¡£ç«™ç‚¹ (ä»…mainåˆ†æ”¯)
      - name: ğŸŒ éƒ¨ç½²æ–‡æ¡£ç«™ç‚¹
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: docs
          keep_files: true
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com

      # 14. å‘é€é€šçŸ¥
      - name: ğŸ“¢ å‘é€é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… æ–‡æ¡£è‡ªåŠ¨åŒ–æ‰§è¡ŒæˆåŠŸ"

            if [ "${{ steps.check-changes.outputs.changed }}" = "true" ]; then
              echo "ğŸ“ æ–‡æ¡£å·²è‡ªåŠ¨æ›´æ–°"
            else
              echo "ğŸ“„ æ²¡æœ‰æ–‡æ¡£å˜æ›´"
            fi
          else
            echo "âŒ æ–‡æ¡£è‡ªåŠ¨åŒ–æ‰§è¡Œå¤±è´¥"
            echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi

  # æ–‡æ¡£è´¨é‡æ£€æŸ¥ä»»åŠ¡ (å•ç‹¬è¿è¡Œ)
  quality-check:
    name: ğŸ” æ–‡æ¡£è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install markdown markdown-link-check
          npm install -g markdownlint-cli2

      - name: ğŸ” è¿è¡Œè´¨é‡æ£€æŸ¥
        run: |
          echo "ğŸ” å¼€å§‹æ–‡æ¡£è´¨é‡æ£€æŸ¥..."

          # Markdownæ ¼å¼æ£€æŸ¥
          markdownlint-cli2 "docs/**/*.md"

          # é“¾æ¥æ£€æŸ¥
          find docs/ -name "*.md" -exec markdown-link-check {} \;

          echo "âœ… æ–‡æ¡£è´¨é‡æ£€æŸ¥é€šè¿‡"

      - name: ğŸ’¬ æ·»åŠ PRè¯„è®º
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ” æ–‡æ¡£è´¨é‡æ£€æŸ¥ç»“æœ\n\nâŒ æ–‡æ¡£è´¨é‡æ£€æŸ¥æœªé€šè¿‡ï¼Œè¯·ä¿®å¤ä»¥ä¸‹é—®é¢˜ï¼š\n\n- Markdownæ ¼å¼é”™è¯¯\n- å¤±æ•ˆé“¾æ¥\n\nè¯·æŸ¥çœ‹è¯¦ç»†çš„å·¥ä½œæµæ—¥å¿—è·å–å…·ä½“ä¿¡æ¯ã€‚'
            })

  # æ–‡æ¡£ç»Ÿè®¡ä»»åŠ¡
  stats:
    name: ğŸ“Š æ–‡æ¡£ç»Ÿè®¡
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“Š ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡
        run: |
          python .github/scripts/doc_generator.py --action generate --project-root .

          # ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
          cat > docs/stats.md << 'EOF'
          # ğŸ“Š æ–‡æ¡£ç»Ÿè®¡æŠ¥å‘Š

          ## ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯

          - **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **æ€»æ–‡æ¡£æ•°**: $(find docs/ -name "*.md" | wc -l)
          - **æ–‡æ¡£æ€»å¤§å°**: $(du -sh docs/ | cut -f1)

          ## ğŸ“‚ åˆ†ç±»ç»Ÿè®¡

          EOF

          echo "### PRDæ–‡æ¡£" >> docs/stats.md
          echo "- æ–‡æ¡£æ•°: $(find docs/prd/ -name "*.md" 2>/dev/null | wc -l)" >> docs/stats.md
          echo "- æ€»å¤§å°: $(du -sh docs/prd/ 2>/dev/null | cut -f1 || echo '0B')" >> docs/stats.md

          echo "### æ¶æ„æ–‡æ¡£" >> docs/stats.md
          echo "- æ–‡æ¡£æ•°: $(find docs/architecture/ -name "*.md" 2>/dev/null | wc -l)" >> docs/stats.md
          echo "- æ€»å¤§å°: $(du -sh docs/architecture/ 2>/dev/null | cut -f1 || echo '0B')" >> docs/stats.md

          echo "### å…¶ä»–æ–‡æ¡£" >> docs/stats.md
          echo "- æ–‡æ¡£æ•°: $(find docs/ -maxdepth 1 -name "*.md" | wc -l)" >> docs/stats.md
          echo "- æ€»å¤§å°: $(du -sh docs/*.md 2>/dev/null | awk '{sum+=$1} END {print sum "B"}' || echo '0B')" >> docs/stats.md

          # æäº¤ç»Ÿè®¡æŠ¥å‘Š
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/stats.md
          git commit -m "[docs] æ›´æ–°æ–‡æ¡£ç»Ÿè®¡ - $(date '+%Y-%m-%d')" || echo "æ²¡æœ‰å˜æ›´"
          git push