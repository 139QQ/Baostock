# Test Design: Story 2.1.基础收益计算引擎

Date: 2025-10-19
Designer: Quinn (Test Architect)
Source: docs/stories/2.1.fund-profit-calculation-engine.md

## Test Strategy Overview

- **Total test scenarios**: 42
- **Unit tests**: 24 (57%)
- **Integration tests**: 12 (29%)
- **E2E tests**: 6 (14%)
- **Priority distribution**: P0: 18, P1: 16, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: 基础收益指标计算 - 系统必须能够计算累计收益、年化收益率、期间收益率等核心指标

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-001 | Unit | P0 | 累计收益计算精度验证(误差≤0.01%) | 核心金融计算逻辑，精度要求极高 | PERF-001 |
| 2.1-UNIT-002 | Unit | P0 | 年化收益率算法正确性验证 | 复杂时间加权计算，业务核心 | PERF-001 |
| 2.1-UNIT-003 | Unit | P0 | 期间收益率边界条件测试 | 不同时间维度计算逻辑 | PERF-001 |
| 2.1-UNIT-004 | Unit | P1 | 负收益率处理逻辑测试 | 边界条件，亏损情况处理 | PERF-001 |
| 2.1-UNIT-005 | Unit | P2 | 零收益率特殊情况测试 | 极端边界条件 | PERF-001 |
| 2.1-INT-001 | Integration | P0 | 计算引擎与数据源集成测试 | 核心组件交互验证 | PERF-002 |
| 2.1-INT-002 | Integration | P1 | 计算结果与存储系统集成 | 数据持久化验证 | DATA-002 |
| 2.1-E2E-001 | E2E | P0 | 用户查看完整收益分析结果 | 关键用户旅程验证 | PERF-001 |

### AC2: 多时间维度支持 - 支持1周、1月、3月、6月、1年、3年等标准时间段的收益计算

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-006 | Unit | P0 | 标准时间段枚举值验证 | 数据结构完整性测试 | TECH-001 |
| 2.1-UNIT-007 | Unit | P0 | 时间段边界日期计算算法 | 日期处理逻辑核心 | PERF-001 |
| 2.1-UNIT-008 | Unit | P1 | 闰年日期计算准确性 | 特殊日期处理测试 | PERF-001 |
| 2.1-UNIT-009 | Unit | P2 | 非标准时间段输入处理 | 边界条件和错误处理 | TECH-004 |
| 2.1-INT-003 | Integration | P0 | 多时间段数据批量获取性能 | 大数据量处理验证 | PERF-002 |
| 2.1-INT-004 | Integration | P1 | 时间段切换计算缓存机制 | 缓存策略验证 | PERF-002 |
| 2.1-E2E-002 | E2E | P1 | 用户切换不同时间段查看收益 | 用户交互流程验证 | PERF-004 |

### AC3: 收益数据处理 - 能够处理分红、拆分等公司行为对收益计算的影响

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-010 | Unit | P0 | 分红再投资收益计算算法 | 复杂金融逻辑核心 | PERF-001 |
| 2.1-UNIT-011 | Unit | P0 | 份额拆分后净值调整算法 | 关键数据处理逻辑 | DATA-001 |
| 2.1-UNIT-012 | Unit | P1 | 除权除息对净值序列影响 | 公司行为处理验证 | DATA-001 |
| 2.1-UNIT-013 | Unit | P2 | 公司行为时间轴构建算法 | 复杂数据结构处理 | TECH-001 |
| 2.1-INT-005 | Integration | P0 | 分红送配API数据集成验证 | 外部API集成测试 | DATA-001 |
| 2.1-INT-006 | Integration | P0 | 拆分详情API数据处理验证 | 关键数据集成点 | DATA-001 |
| 2.1-INT-007 | Integration | P1 | 公司行为调整因子应用验证 | 数据处理流程测试 | DATA-003 |
| 2.1-E2E-003 | E2E | P1 | 用户查看含分红收益的历史表现 | 完整业务流程验证 | DATA-001 |

### AC4: 基准比较 - 支持与基准指数(如沪深300)的收益对比计算

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-014 | Unit | P0 | 基准收益率计算算法 | 对比分析核心逻辑 | PERF-001 |
| 2.1-UNIT-015 | Unit | P1 | 相对收益率计算验证 | 超额收益计算测试 | PERF-001 |
| 2.1-UNIT-016 | Unit | P2 | 基准数据缺失处理 | 边界条件测试 | DATA-001 |
| 2.1-INT-008 | Integration | P0 | 基准指数API数据获取验证 | 外部数据源集成 | DATA-001 |
| 2.1-INT-009 | Integration | P1 | 基准数据与基金数据时间对齐 | 数据一致性验证 | DATA-002 |

### AC5: 风险收益指标 - 实现夏普比率、最大回撤、波动率等高级风险收益指标

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-017 | Unit | P0 | 夏普比率计算精度验证 | 复杂风险指标计算 | PERF-001 |
| 2.1-UNIT-018 | Unit | P0 | 最大回撤算法准确性测试 | 关键风险指标验证 | PERF-001 |
| 2.1-UNIT-019 | Unit | P0 | 波动率计算算法验证 | 统计计算核心逻辑 | PERF-001 |
| 2.1-UNIT-020 | Unit | P1 | 零波动率特殊情况处理 | 边界条件测试 | PERF-001 |
| 2.1-INT-010 | Integration | P1 | 风险指标与收益数据集成 | 数据流完整性验证 | DATA-002 |
| 2.1-E2E-004 | E2E | P1 | 用户查看完整风险收益分析 | 关键用户体验验证 | BUS-001 |

### AC6: 同类排名 - 支持获取基金在同类产品中的排名表现

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-021 | Unit | P1 | 同类排名百分比计算逻辑 | 排名算法验证 | PERF-001 |
| 2.1-UNIT-022 | Unit | P2 | 排名数据缺失处理 | 边界条件测试 | DATA-001 |
| 2.1-INT-011 | Integration | P0 | 同类排名API数据集成验证 | 外部API集成测试 | DATA-001 |
| 2.1-INT-012 | Integration | P1 | 排名数据时间对齐验证 | 数据一致性测试 | DATA-002 |

### AC7: 基金收藏功能 - 用户可以将感兴趣的基金添加到自选列表

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-023 | Unit | P0 | 自选基金添加逻辑验证 | 核心业务逻辑测试 | SEC-001 |
| 2.1-UNIT-024 | Unit | P1 | 重复基金添加处理机制 | 数据一致性验证 | DATA-002 |
| 2.1-UNIT-025 | Unit | P2 | 无效基金代码添加处理 | 错误处理逻辑 | TECH-003 |
| 2.1-INT-013 | Integration | P0 | 自选基金本地存储集成 | 数据持久化验证 | SEC-001 |
| 2.1-INT-014 | Integration | P1 | 自选基金与云端同步机制 | 数据同步验证 | DATA-002 |

### AC8: 自选基金管理 - 提供完整的自选基金列表管理功能

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-026 | Unit | P1 | 自选基金列表排序逻辑 | 数据处理算法测试 | PERF-004 |
| 2.1-UNIT-027 | Unit | P2 | 自选基金列表分页处理 | 性能优化验证 | PERF-002 |
| 2.1-INT-015 | Integration | P1 | 自选基金列表UI数据绑定 | 关键组件集成 | TECH-002 |
| 2.1-E2E-005 | E2E | P1 | 用户管理自选基金完整流程 | 核心用户体验验证 | SEC-001 |

### AC9: 快速访问 - 从自选列表直接访问基金详情和收益分析

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-INT-016 | Integration | P0 | 自选列表到详情页导航集成 | 关键导航流程验证 | TECH-002 |
| 2.1-E2E-006 | E2E | P0 | 用户从自选列表访问收益分析 | 完整用户旅程验证 | BUS-001 |

### AC10: 批量操作 - 支持批量添加/删除自选基金，提高管理效率

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-028 | Unit | P1 | 批量操作事务处理逻辑 | 数据一致性验证 | DATA-002 |
| 2.1-UNIT-029 | Unit | P2 | 批量操作失败回滚机制 | 错误恢复测试 | TECH-003 |
| 2.1-INT-017 | Integration | P1 | 批量操作UI状态管理 | 状态管理集成 | TECH-002 |
| 2.1-E2E-007 | E2E | P1 | 用户执行批量操作完整流程 | 用户体验验证 | PERF-005 |

### AC11: 搜索筛选 - 在自选基金列表中实现高效的搜索和筛选功能

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-UNIT-030 | Unit | P1 | 基金搜索算法准确性 | 搜索逻辑验证 | PERF-004 |
| 2.1-UNIT-031 | Unit | P2 | 搜索结果排序逻辑 | 结果处理算法 | TECH-001 |
| 2.1-INT-018 | Integration | P1 | 搜索功能与本地数据集成 | 数据检索集成 | DATA-003 |

### AC12: 数据同步 - 确保自选基金与持仓分析数据的一致性和实时同步

#### Scenarios

| ID | Level | Priority | Test Scenario | Justification | Mitigates Risks |
|----|-------|----------|----------------|---------------|-----------------|
| 2.1-INT-019 | Integration | P0 | 自选基金与持仓数据同步机制 | 关键数据一致性 | DATA-002 |
| 2.1-INT-020 | Integration | P1 | 网络断开恢复后数据同步 | 离线恢复验证 | OPS-001 |

## Risk Coverage

### Critical Risk Mitigation

| Risk ID | Risk Description | Test Coverage |
|---------|------------------|---------------|
| PERF-001 | 收益计算精度误差 | 15 tests (8 Unit, 3 Integration, 4 E2E) |
| PERF-002 | 大数据量计算性能瓶颈 | 8 tests (2 Unit, 4 Integration, 2 E2E) |
| DATA-001 | 历史数据质量和完整性 | 12 tests (4 Unit, 6 Integration, 2 E2E) |
| SEC-001 | 金融数据安全泄露 | 6 tests (3 Unit, 2 Integration, 1 E2E) |

### High Risk Mitigation

| Risk ID | Risk Description | Test Coverage |
|---------|------------------|---------------|
| PERF-003 | 多基金组合计算复杂度 | 4 tests (2 Unit, 2 Integration) |
| DATA-002 | 多数据源同步一致性 | 8 tests (2 Unit, 6 Integration) |
| SEC-002 | API安全认证漏洞 | 2 tests (1 Unit, 1 Integration) |
| PERF-004 | 图表渲染性能下降 | 3 tests (1 Unit, 2 Integration) |

## Recommended Execution Order

### Phase 1: Critical Risk Tests (Fail Fast)
1. **P0 Unit Tests** (9 tests) - 核心算法和精度验证
   - 收益计算精度验证 (2.1-UNIT-001 to 2.1-UNIT-003)
   - 风险指标计算验证 (2.1-UNIT-017 to 2.1-UNIT-019)
   - 时间段算法验证 (2.1-UNIT-006 to 2.1-UNIT-007)
   - 数据处理验证 (2.1-UNIT-010 to 2.1-UNIT-012)
   - 基准计算验证 (2.1-UNIT-014)
   - 自选基金逻辑验证 (2.1-UNIT-023)

2. **P0 Integration Tests** (7 tests) - 关键组件交互
   - 计算引擎集成 (2.1-INT-001)
   - API数据集成 (2.1-INT-005, 2.1-INT-006, 2.1-INT-008, 2.1-INT-011, 2.1-INT-013, 2.1-INT-016)

3. **P0 E2E Tests** (4 tests) - 关键用户旅程
   - 完整收益分析流程 (2.1-E2E-001)
   - 核心用户体验验证 (2.1-E2E-003, 2.1-E2E-004, 2.1-E2E-006)

### Phase 2: High Risk Tests (Stability Assurance)
4. **P1 Unit Tests** (10 tests) - 业务逻辑完整性
5. **P1 Integration Tests** (7 tests) - 组件交互验证
6. **P1 E2E Tests** (7 tests) - 用户流程验证

### Phase 3: Medium Risk Tests (Quality Assurance)
7. **P2 Unit Tests** (6 tests) - 边界条件和异常处理
8. **P2 Integration Tests** (2 tests) - 完整性验证

## Test Data Requirements

### Precision Test Data
- **基准测试集**: 标准金融计算工具验证的收益数据
- **边界值数据**: 极端收益率（-100%到+1000%）
- **精度验证数据**: 高精度小数点后8位测试数据

### Performance Test Data
- **大数据集**: 100个基金×3年历史数据
- **并发数据**: 多用户同时计算场景数据
- **内存压力数据**: 长时间计算累积数据

### API Integration Test Data
- **正常数据**: 标准API响应格式数据
- **异常数据**: 缺失字段、错误格式数据
- **边界数据**: 新基金、历史基金数据

### Security Test Data
- **敏感数据**: 模拟用户持仓和财务数据
- **攻击数据**: SQL注入、XSS攻击向量
- **权限数据**: 不同用户权限级别数据

## Test Environment Requirements

### Unit Test Environment
- **Flutter Test**: 最新稳定版本
- **Mock Libraries**: Mockito, Decimal测试支持
- **Coverage Tool**: 90%+覆盖率要求

### Integration Test Environment
- **API Mock**: 完整的AKShare API mock服务
- **Database**: 本地Hive数据库测试环境
- **Network**: 模拟网络延迟和中断环境

### E2E Test Environment
- **真实设备**: iOS、Android、Web多平台
- **性能监控**: 帧率、内存使用监控
- **自动化工具**: Integration_test框架

## Quality Gates Criteria

### Must Pass Before Production
- **All P0 Tests**: 100% pass rate
- **Precision Tests**: Error rate ≤ 0.01%
- **Performance Tests**: Response time ≤ 2 seconds
- **Security Tests**: Zero high-severity vulnerabilities

### Recommended Standards
- **P1 Tests**: 95%+ pass rate
- **P2 Tests**: 90%+ pass rate
- **Code Coverage**: 90%+ for new code
- **Performance Benchmarks**: Consistent with baseline

## Test Maintenance Strategy

### Test Data Maintenance
- **定期更新**: 基金数据和基准数据每月更新
- **版本控制**: 测试数据版本化管理
- **质量监控**: 数据质量持续监控

### Test Code Maintenance
- **代码审查**: 所有测试代码需要审查
- **重构优化**: 定期重构测试代码
- **文档更新**: 测试文档与代码同步更新

### Regression Testing
- **自动化回归**: CI/CD集成自动化测试
- **性能回归**: 定期性能基准测试
- **安全回归**: 定期安全扫描和测试